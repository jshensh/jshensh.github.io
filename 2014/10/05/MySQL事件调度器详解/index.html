<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>MySQL事件调度器详解 | 博客</title>

  
  <meta name="author" content="403 Forbidden">
  

  
  <meta name="description" content="自MySQL5.1.6起，增加了一个非常有特色的功能–事件调度器(Event Scheduler)，可以用做定时执行某些特定任务（例如：删除记录、对数据进行汇总等等），来取代原先只能由操作系统的计划任务来执行的工作。更值得一提的是MYSQL的事件调度器可以精确到每秒钟执行一个任务，而操作系统的计划任">
  

  
  
  <meta name="keywords" content="">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="MySQL事件调度器详解"/>

  <meta property="og:site_name" content="博客"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">博客</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>MySQL事件调度器详解</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2014/10/05/MySQL事件调度器详解/" rel="bookmark">
        <time class="entry-date published" datetime="2014-10-05T05:29:42.000Z">
          2014-10-05
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>自MySQL5.1.6起，增加了一个非常有特色的功能–事件调度器(Event Scheduler)，可以用做定时执行某些特定任务（例如：删除记录、对数据进行汇总等等），来取代原先只能由操作系统的计划任务来执行的工作。更值得一提的是MYSQL的事件调度器可以精确到每秒钟执行一个任务，而操作系统的计划任务（如：Linux下的CRON或Windows下的任务计划）只能精确到每分钟执行一次。对于一些对数据实时性要求比较高的应用（例如：股票、赔率、比分等）就非常适合。<br>事件调度器有时也可称为临时触发器(temporal triggers)，因为事件调度器是基于特定时间周期触发来执行某些任务，而触发器(Triggers)是基于某个表所产生的事件触发的，区别也就在这里。<br>在使用这个功能之前必须确保event_scheduler已开启，可执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL event_scheduler = 1;</span><br></pre></td></tr></table></figure></p>
<p>或我们可以在配置my.ini文件 中加上event_scheduler = 1或<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL event_scheduler = ON;</span><br></pre></td></tr></table></figure></p>
<p>来开启，也可以直接在启动命令加上“–event_scheduler=1”，例如：<br>mysqld … –event_scheduler=1<br>要查看当前是否已开启事件调度器，可执行如下SQL：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES LIKE &apos;event_scheduler&apos;;</span><br></pre></td></tr></table></figure></p>
<p>或<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT @@event_scheduler;</span><br></pre></td></tr></table></figure></p>
<p>或<br>拥有SUPER 权限的账户执行SHOW PROCESSLIST 就可以看到这个线程了</p>
<p><strong>定时服务配置</strong><br>先来看一下它的语法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE EVENT [IF NOT EXISTS] event_name</span><br><span class="line">    ON SCHEDULE schedule</span><br><span class="line">    [ON COMPLETION [NOT] PRESERVE]</span><br><span class="line">    [ENABLE | DISABLE]</span><br><span class="line">    [COMMENT &apos;comment&apos;]</span><br><span class="line">    DO sql_statement;</span><br><span class="line">schedule:</span><br><span class="line">    AT TIMESTAMP [+ INTERVAL INTERVAL]</span><br><span class="line">| EVERY INTERVAL [STARTS TIMESTAMP] [ENDS TIMESTAMP]</span><br></pre></td></tr></table></figure></p>
<p>INTERVAL:<br>    quantity {YEAR | QUARTER | MONTH | DAY | HOUR | MINUTE |<br>              WEEK | SECOND | YEAR_MONTH | DAY_HOUR | DAY_MINUTE |<br>              DAY_SECOND | HOUR_MINUTE | HOUR_SECOND | MINUTE_SECOND}</p>
<p><strong>1. 每秒插入一条记录到数据表</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">USE test;</span><br><span class="line">CREATE TABLE aaa (timeline TIMESTAMP);</span><br><span class="line">CREATE EVENT e_test_insert</span><br><span class="line">ON SCHEDULE EVERY 1 SECOND</span><br><span class="line">DO INSERT INTO test.aaa VALUES (CURRENT_TIMESTAMP);</span><br></pre></td></tr></table></figure></p>
<p>等待3秒钟后，再执行查询看看：<br>mysql&gt; SELECT * FROM aaa;<br>+———————+<br>| timeline            |<br>+———————+<br>| 2007-07-18 20:44:26 |<br>| 2007-07-18 20:44:27 |<br>| 2007-07-18 20:44:28 |<br>+———————+</p>
<p><strong>2. 5秒(天)后清空test表</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE EVENT e_test</span><br><span class="line">ON SCHEDULE AT CURRENT_TIMESTAMP + INTERVAL 5 SECOND</span><br><span class="line">DO TRUNCATE TABLE test.aaa;</span><br><span class="line">CREATE EVENT e_test</span><br><span class="line">ON SCHEDULE AT CURRENT_TIMESTAMP + INTERVAL 5 DAY</span><br><span class="line">DO TRUNCATE TABLE test.aaa;</span><br></pre></td></tr></table></figure></p>
<p><strong>3. 2008年5月23日9点39分20秒整清空test表</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE EVENT e_test</span><br><span class="line">ON SCHEDULE AT TIMESTAMP &apos;2008-05-23 9:39:20&apos;</span><br><span class="line">DO TRUNCATE TABLE test.aaa;</span><br></pre></td></tr></table></figure></p>
<p>这个测试有问题。还不太明白原因。</p>
<p><strong>4. 每天定时清空test表</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE EVENT e_test</span><br><span class="line">ON SCHEDULE EVERY 1 DAY</span><br><span class="line">DO TRUNCATE TABLE test.aaa;</span><br></pre></td></tr></table></figure></p>
<p><strong>5. 5天后开启每天定时清空test表</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE EVENT e_test</span><br><span class="line">ON SCHEDULE EVERY 1 DAY</span><br><span class="line">STARTS CURRENT_TIMESTAMP + INTERVAL 5 DAY</span><br><span class="line">DO TRUNCATE TABLE test.aaa;</span><br></pre></td></tr></table></figure></p>
<p>这里5天也可以为0天，当时就开启清空表</p>
<p><strong>6. 每天定时清空test表，5天后停止执行</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE EVENT e_test</span><br><span class="line">ON SCHEDULE EVERY 1 DAY</span><br><span class="line">ENDS CURRENT_TIMESTAMP + INTERVAL 5 DAY</span><br><span class="line">DO TRUNCATE TABLE test.aaa;</span><br></pre></td></tr></table></figure></p>
<p>该设置要求天数大于1，否则报错。而且创建不成功</p>
<p><strong>7. 5天后开启每天定时清空test表，一个月后停止执行</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE EVENT e_test</span><br><span class="line">ON SCHEDULE EVERY 1 DAY</span><br><span class="line">STARTS CURRENT_TIMESTAMP + INTERVAL 5 DAY</span><br><span class="line">ENDS CURRENT_TIMESTAMP + INTERVAL 1 MONTH</span><br><span class="line">DO TRUNCATE TABLE test.aaa;[ON COMPLETION [NOT] PRESERVE]</span><br></pre></td></tr></table></figure></p>
<p>可以设置这个事件是执行一次还是持久执行，默认为NOT PRESERVE。<br>该事件会停止每隔一秒插入数据的事件，感觉这点上mysql做的还是有问题。</p>
<p><strong>8. 每天定时清空test表(只执行一次，任务完成后就终止该事件)</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE EVENT e_test</span><br><span class="line">ON SCHEDULE EVERY 1 DAY</span><br><span class="line">ON COMPLETION NOT PRESERVE</span><br><span class="line">DO TRUNCATE TABLE test.aaa;</span><br></pre></td></tr></table></figure></p>
<p>[ENABLE | DISABLE]可是设置该事件创建后状态是否开启或关闭，默认为ENABLE。<br>[COMMENT ‘comment’]可以给该事件加上注释。</p>
<p><strong>定时服务日常维护测试</strong><br><strong>修改事件(ALTER EVENT)</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ALTER EVENT event_name</span><br><span class="line">    [ON SCHEDULE schedule]</span><br><span class="line">    [RENAME TO new_event_name]</span><br><span class="line">    [ON COMPLETION [NOT] PRESERVE]</span><br><span class="line">    [COMMENT &apos;comment&apos;]</span><br><span class="line">    [ENABLE | DISABLE]</span><br><span class="line">    [DO sql_statement]</span><br></pre></td></tr></table></figure></p>
<p>a、临时关闭事件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER EVENT e_test DISABLE;</span><br></pre></td></tr></table></figure></p>
<p>b、开启事件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER EVENT e_test ENABLE;</span><br></pre></td></tr></table></figure></p>
<p>c、将每天清空test表改为5天清空一次：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER EVENT e_test</span><br><span class="line">ON SCHEDULE EVERY 5 DAY;</span><br></pre></td></tr></table></figure></p>
<p>d、重命名事件并加上注释<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter event test.new_e_test rename to e_test comment &apos;e_test_cm&apos;;</span><br></pre></td></tr></table></figure></p>
<p><strong>删除事件(DROP EVENT)</strong><br>语法很简单，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP EVENT [IF EXISTS] event_name</span><br></pre></td></tr></table></figure></p>
<p>例如删除前面创建的e_test事件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP EVENT e_test;</span><br></pre></td></tr></table></figure></p>
<p>当然前提是这个事件存在，否则会产生ERROR 1513 (HY000): Unknown event错误，因此最好加上IF EXISTS<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP EVENT IF EXISTS e_test;</span><br></pre></td></tr></table></figure></p>
<p><strong>查看事件</strong><br>a、查看一个event的详细信息可以用下面的视图：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM INFORMATION_SCHEMA.EVENTS WHERE EVENT_NAME = &apos;test_insert&apos;   AND EVENT_SCHEMA = &apos;test&apos;\G;</span><br></pre></td></tr></table></figure></p>
<p>b、简要列出所有的event：show events<br>语法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SHOW EVENTS [FROM schema_name]</span><br><span class="line">    [LIKE &apos;pattern&apos; | WHERE expr]</span><br></pre></td></tr></table></figure></p>
<p>格式化显示所有event<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW EVENTS\G</span><br></pre></td></tr></table></figure></p>
<p>格式化显示test用户的event<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show events FROM test;</span><br></pre></td></tr></table></figure></p>
<p>c、查看event的创建信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SHOW CREATE EVENT event_name</span><br><span class="line">show create event test.e_test\G</span><br></pre></td></tr></table></figure></p>
<p><strong>结论</strong><br>该特性确实非常有用，可作为定时清空数据表、监控主从服务器、汇总数据到另一张表等等，并且可以精确到每秒，实时性也可以得到保障。<br>不过如果当两个事件的针对相同的对象的时候，会出现冲突，这种情况还不明确是我理解的问题还是确实是这样，比如每秒插入和定时删除就会冲突。除了调度SQL语句之外，MYSQL的调度器也可以调度存储过程。</p>
<p><strong>缺点</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM INFORMATION_SCHEMA.EVENTS WHERE EVENT_NAME = &apos;test_insert&apos;  AND EVENT_SCHEMA = &apos;troaudit_db&apos;\G;</span><br></pre></td></tr></table></figure></p>
<p><strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong> 1. row <strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong><br>       EVENT_CATALOG: NULL<br>        EVENT_SCHEMA: troaudit_db<br>          EVENT_NAME: event_session_table<br>             DEFINER: egilance@%<br>           TIME_ZONE: SYSTEM<br>          EVENT_BODY: SQL<br>    EVENT_DEFINITION: BEGIN<br>        CALL create_table_process;<br>    END<br>          EVENT_TYPE: RECURRING<br>          EXECUTE_AT: NULL<br>      INTERVAL_VALUE: 1800<br>      INTERVAL_FIELD: SECOND<br>            SQL_MODE:<br>              STARTS: 2011-08-23 10:51:28<br>                ENDS: NULL<br>              STATUS: ENABLED<br>       ON_COMPLETION: PRESERVE<br>             CREATED: 2011-08-23 10:51:28<br>        LAST_ALTERED: 2011-08-23 10:51:28<br>       LAST_EXECUTED: 2011-08-23 17:55:51<br>       EVENT_COMMENT:<br>          ORIGINATOR: 0<br>CHARACTER_SET_CLIENT: utf8<br>COLLATION_CONNECTION: utf8_general_ci<br>  DATABASE_COLLATION: utf8_unicode_ci<br>1 row in set (0.00 sec)</p>
<p>MySQL只会记录最后一次调度的时间，如果时间往前调整，小于最近执行的时间，则不会执行事件调度。</p>
<p>转载自 <a href="http://www.2cto.com/database/201111/109752.html" target="_blank" rel="noopener">http://www.2cto.com/database/201111/109752.html</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2018 403 Forbidden
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>