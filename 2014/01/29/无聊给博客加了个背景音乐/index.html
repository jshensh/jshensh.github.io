<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>无聊给博客加了个背景音乐 | 博客</title>

  
  <meta name="author" content="403 Forbidden">
  

  
  <meta name="description" content="如题。。顺手写了个管理中心。。这是我第一个用到 json 的玩意儿。。不过别说 json 还是挺方便的。。附源码及安装说明。。
2014-01-31 重要更新，因在编写前一个版本时不熟悉 php 的 cookies 机制，导致 随机播放时避免重复播放 的功能未实现，后准备使用 jquery 将播放列">
  

  
  
  <meta name="keywords" content="">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="无聊给博客加了个背景音乐"/>

  <meta property="og:site_name" content="博客"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">博客</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>无聊给博客加了个背景音乐</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2014/01/29/无聊给博客加了个背景音乐/" rel="bookmark">
        <time class="entry-date published" datetime="2014-01-29T03:08:17.000Z">
          2014-01-29
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>如题。。顺手写了个管理中心。。这是我第一个用到 json 的玩意儿。。不过别说 json 还是挺方便的。。附源码及安装说明。。</p>
<p><strong>2014-01-31 重要更新，因在编写前一个版本时不熟悉 php 的 cookies 机制，导致 随机播放时避免重复播放 的功能未实现，后准备使用 jquery 将播放列表存到本地 cookies 然后随机调用，又发现 cookies 有大小限制。之后只能放弃了这个功能，现在只使用 cookies 记录当前播放的曲目以及服务器传回的播放列表中总计的曲目数量，以便进行顺序播放。</strong></p>
<p>一、先创建数据表<br><code>create table</code>music_list<code>(</code>id<code>int not null auto_increment,</code>name<code>text not null default &quot;&quot;,</code>url<code>text not null default &quot;&quot;,</code>singer<code>text not null default &quot;&quot;,</code>lrc<code>int not null default 0,</code>lrc_data<code>text not null default &quot;&quot;,
primary key(</code>id`)<br>);<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">表示偷了个小懒全用的 text</span><br><span class="line"></span><br><span class="line">二、上传文件至根目录，命名无所谓，必须 .php 结尾，本站的是 music_list.php</span><br><span class="line">`&lt;?php</span><br><span class="line">    session_start();</span><br><span class="line">    header(&quot;Content-type:text/html;charset=utf-8&quot;);</span><br><span class="line">    date_default_timezone_set(&apos;Asia/Shanghai&apos;);</span><br><span class="line">    $pass=&apos;经 md5 加密后的密码&apos;;</span><br><span class="line">    $link = @mysql_connect(&quot;数据库服务器&quot;,&apos;数据库用户名&apos;,&apos;数据库密码&apos;,true);</span><br><span class="line">    if(!$link) &#123;</span><br><span class="line">        die(&quot;Connect Server Failed: &quot; . mysql_error());</span><br><span class="line">    &#125;</span><br><span class="line">    if(!mysql_select_db(&apos;数据库名&apos;,$link)) &#123;</span><br><span class="line">        die(&quot;Select Database Failed: &quot; . mysql_error($link));</span><br><span class="line">    &#125;</span><br><span class="line">    mysql_query(&apos;set names utf8&apos;);</span><br><span class="line">    </span><br><span class="line">    function get_music($id=null) &#123;</span><br><span class="line">        $return_value=array();</span><br><span class="line">        $select_query=mysql_query(&apos;select * from `music_list`&apos;);</span><br><span class="line">        while (($value=mysql_fetch_array($select_query))!==false) &#123;</span><br><span class="line">            $return_tmp=array();</span><br><span class="line">            $return_tmp[&apos;name&apos;]=$value[&apos;name&apos;];</span><br><span class="line">            $return_tmp[&apos;url&apos;]=$value[&apos;url&apos;];</span><br><span class="line">            $return_tmp[&apos;singer&apos;]=$value[&apos;singer&apos;];</span><br><span class="line">            $return_tmp[&apos;id&apos;]=$value[&apos;id&apos;];</span><br><span class="line">            $return_tmp[&apos;lrc&apos;]=htmlspecialchars($value[&apos;lrc&apos;]);</span><br><span class="line">            $return_tmp[&apos;lrc_data&apos;]=str_replace(array(&quot;\r&quot;,&quot;\n&quot;),array(&quot;&quot;,&quot;&lt;br /&gt;&quot;),$value[&apos;lrc_data&apos;]);</span><br><span class="line">            $return_value[]=$return_tmp;</span><br><span class="line">        &#125;</span><br><span class="line">        if ($id==null) &#123;</span><br><span class="line">            return $return_value;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $return_values=$return_value[$id];</span><br><span class="line">            $return_values[&apos;length&apos;]=count($return_value);</span><br><span class="line">            return $return_values;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function chkid($id) &#123;</span><br><span class="line">        if (!empty($id) &amp;&amp; is_numeric($id)) &#123;</span><br><span class="line">            $select_query=mysql_query(&apos;select * from `music_list` where `id`=\&apos;&apos;.$id.&apos;\&apos;&apos;);</span><br><span class="line">            if (mysql_num_rows($select_query)==0) &#123;</span><br><span class="line">                msg(&apos;找不到数据&apos;);</span><br><span class="line">            &#125;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        msg(&apos;找不到数据&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">    function get_post_data() &#123;</span><br><span class="line">        if (!get_magic_quotes_gpc()) &#123;</span><br><span class="line">            $return_value=array();</span><br><span class="line">            foreach ($_POST as $key=&gt;$value) &#123;</span><br><span class="line">                $return_value[$key]=addslashes($value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $return_value=$_POST;</span><br><span class="line">        &#125;</span><br><span class="line">        return $return_value;</span><br><span class="line">    &#125;</span><br><span class="line">    function msg($msg) &#123;</span><br><span class="line">        echo &apos;&lt;p&gt;&apos;.$msg.&apos;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;&apos;.$_SERVER[&apos;PHP_SELF&apos;].&apos;&quot;&gt;返回首页&lt;/a&gt;&lt;/p&gt;&apos;;</span><br><span class="line">        echo_footer();</span><br><span class="line">        exit();</span><br><span class="line">    &#125;</span><br><span class="line">    function echo_header() &#123;</span><br><span class="line">        echo &apos;&lt;html&gt;&lt;head&gt;&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,minimum-scale=1.0,maximum-scale=1.0&quot;/&gt;&lt;title&gt;博客背景音乐管理中心&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&apos;;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    function echo_footer() &#123;</span><br><span class="line">        echo &apos;&lt;/body&gt;&lt;/html&gt;&apos;;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    if ($_GET[&apos;action&apos;]==&apos;get_music&apos;) &#123;</span><br><span class="line">        if ($_GET[&apos;id&apos;]!==&apos;&apos; &amp;&amp; is_numeric($_GET[&apos;id&apos;])) &#123;</span><br><span class="line">            $output=get_music($_GET[&apos;id&apos;]);</span><br><span class="line">            preg_match_all(&quot;/^(http:\/\/.*\/)(.*?)$/&quot;,$output[&apos;url&apos;],$outputtmp);</span><br><span class="line">            $output[&apos;url&apos;]=$outputtmp[1][0].rawurlencode($outputtmp[2][0]);</span><br><span class="line">            foreach ($output as $k=&gt;$v) &#123;</span><br><span class="line">                $output[$k]=urlencode($v);</span><br><span class="line">            &#125;</span><br><span class="line">            echo urldecode(json_encode($output));</span><br><span class="line">        &#125;</span><br><span class="line">        exit();</span><br><span class="line">    &#125; elseif ($_GET[&apos;action&apos;]==&apos;get_music_list&apos;) &#123;</span><br><span class="line">        echo json_encode(get_music());</span><br><span class="line">        exit();</span><br><span class="line">    &#125; elseif ($_GET[&apos;action&apos;]==&apos;login&apos;) &#123;</span><br><span class="line">        if ($_SESSION[&apos;admin&apos;]==&apos;admin&apos;) &#123;</span><br><span class="line">            header(&apos;Location: &apos;.$_SERVER[&apos;PHP_SELF&apos;]);</span><br><span class="line">            exit();</span><br><span class="line">        &#125;</span><br><span class="line">        echo_header();</span><br><span class="line">        if ($_POST) &#123;</span><br><span class="line">            if (md5($_POST[&apos;password&apos;])==$pass) &#123;</span><br><span class="line">                $_SESSION[&apos;admin&apos;]=&apos;admin&apos;;</span><br><span class="line">                header(&apos;Location: &apos;.$_SERVER[&apos;PHP_SELF&apos;]);</span><br><span class="line">                exit();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                echo &apos;&lt;p&gt;密码错误&lt;/p&gt;&apos;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        echo &apos;&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;&lt;p&gt;&lt;label&gt;请输入密码:&lt;input type=&quot;password&quot; name=&quot;password&quot; /&gt;&lt;/label&gt;&lt;/p&gt;&lt;p&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;提交&quot; /&gt;&lt;/p&gt;&lt;/form&gt;&apos;;</span><br><span class="line">        echo_footer();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if ($_SESSION[&apos;admin&apos;]!==&apos;admin&apos;) &#123;</span><br><span class="line">            header(&apos;Location: &apos;.$_SERVER[&apos;PHP_SELF&apos;].&apos;?action=login&apos;);</span><br><span class="line">            exit();</span><br><span class="line">        &#125;</span><br><span class="line">        echo_header();</span><br><span class="line">        if ($_GET[&apos;action&apos;]==&apos;del&apos;) &#123;</span><br><span class="line">            chkid($_GET[&apos;id&apos;]);</span><br><span class="line">            if ($_POST) &#123;</span><br><span class="line">                $del_query=mysql_query(&apos;delete from `music_list` where `id`=\&apos;&apos;.$_GET[&apos;id&apos;].&apos;\&apos;&apos;);</span><br><span class="line">                if ($del_query) &#123;</span><br><span class="line">                    msg(&apos;删除成功&apos;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    msg(&apos;删除失败&apos;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                $select_query=mysql_fetch_array(mysql_query(&apos;select * from `music_list` where `id`=\&apos;&apos;.$_GET[&apos;id&apos;].&apos;\&apos;&apos;));</span><br><span class="line">                echo &apos;&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;&lt;p&gt;您确定要删除 &apos;.$select_query[&apos;name&apos;].&apos; - &apos;.$select_query[&apos;singer&apos;].&apos;么？&lt;/p&gt;&lt;p&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;确定&quot; /&gt;&lt;a href=&quot;&apos;.$_SERVER[&apos;PHP_SELF&apos;].&apos;&quot;&gt;取消&lt;/a&gt;&lt;/p&gt;&lt;/form&gt;&apos;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; elseif ($_GET[&apos;action&apos;]==&apos;edit&apos;) &#123;</span><br><span class="line">            chkid($_GET[&apos;id&apos;]);</span><br><span class="line">            if ($_POST) &#123;</span><br><span class="line">                $post_data=get_post_data();</span><br><span class="line">                $update_query=mysql_query(&apos;update `music_list` set `name`=\&apos;&apos;.$post_data[&apos;name&apos;].&apos;\&apos;, `url`=\&apos;&apos;.$post_data[&apos;url&apos;].&apos;\&apos;, `singer`=\&apos;&apos;.$post_data[&apos;singer&apos;].&apos;\&apos;, `lrc`=\&apos;&apos;.$post_data[&apos;lrc&apos;].&apos;\&apos;, `lrc_data`=\&apos;&apos;.$post_data[&apos;lrc_data&apos;].&apos;\&apos; where `id`=\&apos;&apos;.$_GET[&apos;id&apos;].&apos;\&apos;&apos;);</span><br><span class="line">                if ($update_query) &#123;</span><br><span class="line">                    msg(&apos;数据插入成功&apos;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    msg(&apos;数据插入失败&apos;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                $select_query=mysql_fetch_array(mysql_query(&apos;select * from `music_list` where `id`=\&apos;&apos;.$_GET[&apos;id&apos;].&apos;\&apos;&apos;));</span><br><span class="line">                echo &apos;&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;&lt;p&gt;&lt;label&gt;歌名:&lt;input type=&quot;text&quot; name=&quot;name&quot; value=&quot;&apos;.$select_query[&apos;name&apos;].&apos;&quot; /&gt;&lt;/p&gt;&lt;p&gt;&lt;label&gt;歌手:&lt;input type=&quot;text&quot; name=&quot;singer&quot; value=&quot;&apos;.$select_query[&apos;singer&apos;].&apos;&quot; /&gt;&lt;/p&gt;&lt;p&gt;&lt;label&gt;下载地址:&lt;input type=&quot;text&quot; name=&quot;url&quot; value=&quot;&apos;.$select_query[&apos;url&apos;].&apos;&quot; /&gt;&lt;/p&gt;&lt;p&gt;显示 lrc 歌词: &lt;label&gt;&lt;input type=&quot;radio&quot; name=&quot;lrc&quot; value=&quot;1&quot; &apos;.($select_query[&apos;lrc&apos;]?&apos;checked=&quot;checked&quot; &apos;:&apos;&apos;).&apos;/&gt;是&lt;/label&gt;&amp;nbsp;&amp;nbsp;&lt;label&gt;&lt;input type=&quot;radio&quot; name=&quot;lrc&quot; value=&quot;0&quot; &apos;.(!$select_query[&apos;lrc&apos;]?&apos;checked=&quot;checked&quot; &apos;:&apos;&apos;).&apos;/&gt;否&lt;/label&gt;&lt;/p&gt;&lt;p&gt;lrc 歌词(可选):&lt;br /&gt;&lt;textarea name=&quot;lrc_data&quot;&gt;&apos;.htmlspecialchars($select_query[&apos;lrc_data&apos;]).&apos;&lt;/textarea&gt;&lt;/p&gt;&lt;p&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;确定&quot; /&gt;&lt;a href=&quot;&apos;.$_SERVER[&apos;PHP_SELF&apos;].&apos;&quot;&gt;取消&lt;/a&gt;&lt;/p&gt;&lt;/form&gt;&apos;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; elseif ($_GET[&apos;action&apos;]==&apos;search&apos;) &#123;</span><br><span class="line">            $post_data=get_post_data();</span><br><span class="line">            echo &apos;&lt;form action=&quot;?action=search&quot; method=&quot;post&quot;&gt;&lt;p&gt;&lt;input name=&quot;search&quot; type=&quot;text&quot; value=&quot;&apos;.$post_data[&apos;search&apos;].&apos;&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;input type=&quot;submit&quot; value=&quot;搜索&quot; /&gt;&lt;/p&gt;&lt;/form&gt;&apos;;</span><br><span class="line">            if ($_POST) &#123;</span><br><span class="line">                $search_query=mysql_query(&apos;select * from `music_list` where `name` like \&apos;%&apos;.$post_data[&apos;search&apos;].&apos;%\&apos; or `singer` like \&apos;%&apos;.$post_data[&apos;search&apos;].&apos;%\&apos; or `url` like \&apos;%&apos;.$post_data[&apos;search&apos;].&apos;%\&apos;&apos;);</span><br><span class="line">                if (mysql_num_rows($search_query)&gt;0) &#123;</span><br><span class="line">                    echo &apos;&lt;ol&gt;&apos;;</span><br><span class="line">                    while (($value=mysql_fetch_array($search_query))!==false) &#123;</span><br><span class="line">                        echo &apos;&lt;li&gt;&apos;.$value[&apos;name&apos;].&apos; - &apos;.$value[&apos;singer&apos;].&apos;&amp;nbsp;&lt;a href=&quot;&apos;.$_SERVER[&apos;PHP_SELF&apos;].&apos;?action=edit&amp;id=&apos;.$value[&apos;id&apos;].&apos;&quot;&gt;编辑&lt;/a&gt;&amp;nbsp;&lt;a href=&quot;&apos;.$_SERVER[&apos;PHP_SELF&apos;].&apos;?action=del&amp;id=&apos;.$value[&apos;id&apos;].&apos;&quot;&gt;删除&lt;/a&gt;&lt;/li&gt;&apos;;</span><br><span class="line">                    &#125;</span><br><span class="line">                    echo &apos;&lt;/ol&gt;&lt;a href=&quot;&apos;.$_SERVER[&apos;PHP_SELF&apos;].&apos;&quot;&gt;返回首页&lt;/a&gt;&apos;;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    echo &apos;&lt;p&gt;无搜索结果&lt;/p&gt;&apos;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; elseif ($_GET[&apos;action&apos;]==&apos;add&apos;) &#123;</span><br><span class="line">            if ($_POST) &#123;</span><br><span class="line">                $post_data=get_post_data();</span><br><span class="line">                $insert_query=mysql_query(&apos;insert into `music_list`(`name`,`url`,`singer`,`lrc`,`lrc_data`) values(\&apos;&apos;.$post_data[&apos;name&apos;].&apos;\&apos;,\&apos;&apos;.$post_data[&apos;url&apos;].&apos;\&apos;,\&apos;&apos;.$post_data[&apos;singer&apos;].&apos;\&apos;,\&apos;&apos;.$post_data[&apos;lrc&apos;].&apos;\&apos;,\&apos;&apos;.$post_data[&apos;lrc_data&apos;].&apos;\&apos;)&apos;);</span><br><span class="line">                if ($insert_query) &#123;</span><br><span class="line">                    msg(&apos;数据插入成功&apos;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    msg(&apos;数据插入失败&apos;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                echo &apos;&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;&lt;p&gt;&lt;label&gt;歌名:&lt;input type=&quot;text&quot; name=&quot;name&quot; /&gt;&lt;/p&gt;&lt;p&gt;&lt;label&gt;歌手:&lt;input type=&quot;text&quot; name=&quot;singer&quot; /&gt;&lt;/p&gt;&lt;p&gt;&lt;label&gt;下载地址:&lt;input type=&quot;text&quot; name=&quot;url&quot; value=&quot;http://&quot; /&gt;&lt;/p&gt;&lt;p&gt;显示 lrc 歌词: &lt;label&gt;&lt;input type=&quot;radio&quot; name=&quot;lrc&quot; value=&quot;1&quot; /&gt;是&lt;/label&gt;&amp;nbsp;&amp;nbsp;&lt;label&gt;&lt;input type=&quot;radio&quot; name=&quot;lrc&quot; value=&quot;0&quot; checked=&quot;checked&quot; /&gt;否&lt;/label&gt;&lt;/p&gt;&lt;p&gt;lrc 歌词(可选):&lt;br /&gt;&lt;textarea name=&quot;lrc_data&quot;&gt;&apos;.htmlspecialchars($select_query[&apos;lrc_data&apos;]).&apos;&lt;/textarea&gt;&lt;/p&gt;&lt;p&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;确定&quot; /&gt;&lt;a href=&quot;&apos;.$_SERVER[&apos;PHP_SELF&apos;].&apos;&quot;&gt;取消&lt;/a&gt;&lt;/p&gt;&lt;/form&gt;&apos;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">             echo &apos;&lt;form action=&quot;?action=search&quot; method=&quot;post&quot;&gt;&lt;p&gt;&lt;input name=&quot;search&quot; type=&quot;text&quot; /&gt;&lt;/p&gt;&lt;p&gt;&lt;input type=&quot;submit&quot; value=&quot;搜索&quot; /&gt;&lt;/p&gt;&lt;/form&gt;&apos;;</span><br><span class="line">             $all_list=get_music();</span><br><span class="line">             echo &apos;&lt;ol&gt;&apos;;</span><br><span class="line">             foreach ($all_list as $value) &#123;</span><br><span class="line">                 echo &apos;&lt;li&gt;&apos;.$value[&apos;name&apos;].&apos; - &apos;.$value[&apos;singer&apos;].&apos;&amp;nbsp;&lt;a href=&quot;&apos;.$_SERVER[&apos;PHP_SELF&apos;].&apos;?action=edit&amp;id=&apos;.$value[&apos;id&apos;].&apos;&quot;&gt;编辑&lt;/a&gt;&amp;nbsp;&lt;a href=&quot;&apos;.$_SERVER[&apos;PHP_SELF&apos;].&apos;?action=del&amp;id=&apos;.$value[&apos;id&apos;].&apos;&quot;&gt;删除&lt;/a&gt;&lt;/li&gt;&apos;;</span><br><span class="line">             &#125;</span><br><span class="line">             echo &apos;&lt;/ol&gt;&apos;;</span><br><span class="line">             echo &apos;&lt;a href=&quot;&apos;.$_SERVER[&apos;PHP_SELF&apos;].&apos;?action=add&quot;&gt;添加新曲目&lt;/a&gt;&apos;;</span><br><span class="line">        &#125;</span><br><span class="line">        echo_footer();</span><br><span class="line">    &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>注意不要忘记修改数据库信息和登录密码</p>
<p>三、前台创建小工具<br>`<script type="text/javascript" src="/json2.js"></script></p>
<p><script type="text/javascript" src="/jquery.cookie.js"></script><br>        <style><br>            /*</p>
<pre><code>     * Lyric support by kookxiang(http://ikk.me)
     */
    .kk_player { width: 100%; max-height: 40px; }
    .kk_lrc { height: 125px; overflow: auto; padding: 0; margin: 0; }
    .kk_lrc li { display: block; text-align: center; color: gray; line-height: 20px; margin: 2px 0 3px 0 !important; min-height: 20px; }
    .kk_lrc .current { color: black; font-weight: bold; }
    .kk_lrc, .kk_lrc * { -webkit-transition-duration: 1s; -moz-transition-duration: 1s; transition-duration: 1s; }
    .kk_lrc ::selection { background: transparent; background: rgba(127, 127, 127, 0.1); }
    .kk_lrc_box { position: relative; }
    .kk_lrc_box:before { content: &apos;.&apos;; overflow: hidden; text-indent: -9999px; width: 100%; height: 30px; z-index: 1; display: block; position: absolute; background: url(http://lab.233.imjs.work/getlrc/cover.png) repeat-x 0 0; top: 0; pointer-events: none; }
    .kk_lrc_box:after { content: &apos;.&apos;; overflow: hidden; text-indent: -9999px; width: 100%; height: 30px; z-index: 1; display: block; position: absolute; background: url(http://lab.233.imjs.work/getlrc/cover.png) repeat-x 0 100%; bottom: 0; pointer-events: none; }

    ::-webkit-scrollbar { width: 8px; height: 8px;}
    ::-webkit-scrollbar-track { -webkit-border-radius: 10px; border-radius: 10px; }
    ::-webkit-scrollbar-thumb { -webkit-border-radius: 10px; border-radius: 10px; background: rgba(96, 96, 96, 0.8); -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.5); }
    ::-webkit-scrollbar-thumb:window-inactive { background: rgba(96, 96, 96, 0.4); }
&lt;/style&gt;
&lt;script&gt;
</code></pre><p>var ael=false;<br>var tmp_interval=[0,0];<br>function get_lrc(name,singer) {<br>    var script = document.createElement(‘script’);<br>    script.setAttribute(‘src’, “<a href="http://lab.liujiantao.me/lrc/?name=&quot;+encodeURIComponent(name)+&quot;&amp;singer=&quot;+encodeURIComponent(singer)+&quot;&amp;callback=con_lrc&quot;)">http://lab.liujiantao.me/lrc/?name=&quot;+encodeURIComponent(name)+&quot;&amp;singer=&quot;+encodeURIComponent(singer)+&quot;&amp;callback=con_lrc&quot;)</a>;<br>    //load javascript<br>    document.getElementsByTagName(‘head’)[0].appendChild(script);<br>    return true;<br>}</p>
<p>function con_lrc(lrc_data) {<br>    var err_msg={“-1”:”服务器没有接收到完整数据”,”-2”:”无法正常获取 xml 文件”,”-3”:”找不到该曲目”,”-4”:”未收录 lrc 歌词”,”-5”:”无法正常获取 lrc 歌词”};<br>    if (lrc_data.status==”error”) {<br>        console.error(err_msg[lrc_data.errcode]);<br>        $(“#kk_lrc_box”).css(“display”,”none”);<br>        return false;<br>    }<br>    $(“#player_lrc”).html(“<li></li><li></li><li></li>“);<br>    var kk_lrc = load_kk_lrc();<br>    for (j=0;j&lt;lrc_data.result.length;j++) {<br>        var lrcArray=lrc_data.result[j].split(“<br />“);<br>        var timeKey=new Object();<br>        var strArray=new Array();<br>        var _offset=lrc_data.result[j].match(/[offset.<em>?(\d</em>?)]/);<br>        _offset=(typeof _offset==”undefined” || _offset===null)?0:_offset[1]/1000;<br>        for (var i = 0,l = lrcArray.length;i &lt; l;i++) {<br>            clause = decodeURIComponent(lrcArray[i]).replace(/[\d<em>?:\d</em>?([.:]\d<em>?)?]/g,’’);<br>            timeRegExpArr = decodeURIComponent(lrcArray[i]).match(/[(\d</em>?):(\d<em>?)([.:](\d</em>?))?]/g);<br>            if (timeRegExpArr!=null) {<br>                for (var k = 0,h = timeRegExpArr.length;k &lt; h;k++) { //第一遍循环，JSON存储歌词，数组存储时间<br>                    _timeRegExpArr = timeRegExpArr[k].match(/^[(\d<em>?):(\d</em>?)(<a href="\d*?">.:</a>)?]$/);<br>                    min = parseFloat(_timeRegExpArr[1]);<br>                    sec = parseFloat(_timeRegExpArr[2]);<br>                    msec = parseFloat(typeof _timeRegExpArr[4]==”undefined”?0:_timeRegExpArr[4]);<br>                    time=min * 60 + sec + msec/100 - _offset;<br>                    time=(time&lt;0)?0:time;<br>                    if (!timeKey[time]) {<br>                        strArray.push(time);<br>                        timeKey[time] = clause + ‘<br />‘;<br>                    } else {<br>                        timeKey[time] += clause + ‘<br />‘;<br>                    }<br>                }<br>            }<br>        }<br>        strArray.sort(function(a,b) {<br>            return a - b;<br>        });<br>        for (var i = 0,l = strArray.length;i &lt; l;i++) { //第二遍循环，JSON存储时间，数组存储歌词<br>            var tempIndex = strArray[i],<br>            tempClause = timeKey[tempIndex];<br>            kk_lrc.add_lrc(tempIndex,tempClause);<br>        }<br>    }<br>    kk_lrc.init();<br>    ael=true;<br>    return true;<br>}</p>
<p>function add_lrc(lrc_data) {<br>    con_lrc({‘status’:’success’,’errcode’:’0’,’result’:[lrc_data.replace(“\n”,”<br />“)]});<br>    return true;<br>}</p>
<p>/*</p>
<ul>
<li><p>Lyric support by kookxiang(<a href="http://ikk.me">http://ikk.me</a>)<br>*/<br>function load_kk_lrc(){<br> var kk_lrc = new Object();<br> kk_lrc.extra_top = 1;<br> kk_lrc.current = -1;<br> kk_lrc.current_obj;<br> kk_lrc.offset = 0;<br> kk_lrc.current_start = -1;<br> kk_lrc.next_update_time = -1;<br> kk_lrc.showtime = -1;<br> kk_lrc.lrc_offset = -1;<br> kk_lrc.lrc_height = -1;<br> kk_lrc.lrc = [];<br> kk_lrc.lrcobj = null;<br> kk_lrc.target = 0;<br> kk_lrc._target = 0;<br> kk_lrc.player_obj = document.getElementById(‘player_player’);<br> kk_lrc.lrc_obj = document.getElementById(‘player_lrc’);</p>
<p> kk_lrc.scroll_lrc = function () {</p>
<pre><code>if(typeof kk_lrc.lrc[kk_lrc.current+2] != &quot;undefined&quot;){
    for(id in kk_lrc.lrcobj) kk_lrc.lrcobj[id].className = &apos;&apos;;
    kk_lrc.lrcobj[kk_lrc.current+3].className = &apos;current&apos;;
}
kk_lrc.current_start = kk_lrc.lrc[kk_lrc.current];
kk_lrc.current++;
kk_lrc.current_obj = kk_lrc.lrcobj[kk_lrc.current+2];
kk_lrc.next_update_time = kk_lrc.lrc[kk_lrc.current];
kk_lrc.showtime = kk_lrc.next_update_time - kk_lrc.current_start;
kk_lrc.lrc_offset = kk_lrc.current_obj.offsetTop;
kk_lrc.lrc_height = kk_lrc.current_obj.offsetHeight;
</code></pre><p> };<br> kk_lrc.check_lrc_update = function () {</p>
<pre><code>var curTime = kk_lrc.player_obj.currentTime;
if(curTime &gt;= kk_lrc.next_update_time - 0.2){
    kk_lrc.scroll_lrc();
    kk_lrc.check_lrc_update();
}
if(typeof kk_lrc.lrc[kk_lrc.current-1] != &quot;undefined&quot;){
    kk_lrc.extra_top = (kk_lrc.next_update_time - curTime) / kk_lrc.showtime;
}
kk_lrc.target = Math.round(kk_lrc.lrc_offset - (125 - kk_lrc.lrc_height) / 2);
if(kk_lrc.target &lt; 0) kk_lrc.target = 0;
</code></pre><p> };<br> kk_lrc.init = function () {</p>
<pre><code>kk_lrc.add_lrc(&apos;999999&apos;, &apos;&apos;);
kk_lrc.add_lrc(&apos;999999&apos;, &apos;&apos;);
kk_lrc.add_lrc(&apos;999999&apos;, &apos;&apos;);
kk_lrc.current = -1;
kk_lrc.lrcobj = kk_lrc.lrc_obj.getElementsByTagName(&apos;li&apos;);
kk_lrc.current_obj = kk_lrc.lrcobj[0];
kk_lrc.scroll_lrc();
kk_lrc.check_lrc_update();
        if (ael==false) {
kk_lrc.player_obj.addEventListener(&quot;seeked&quot; ,function(){
    kk_lrc.current = -1;
    kk_lrc.scroll_lrc();
    kk_lrc.check_lrc_update();
});
kk_lrc.player_obj.addEventListener(&quot;durationchange&quot; ,function(){
    kk_lrc.current = -1;
    kk_lrc.scroll_lrc();
    kk_lrc.check_lrc_update();
});
        } else {
            clearInterval(tmp_interval[0]);
            clearInterval(tmp_interval[1]);
        }
tmp_interval[0]=setInterval(function(){
        if(kk_lrc.player_obj.paused) return;
        if(kk_lrc.current_start &gt; kk_lrc.player_obj.currentTime){
            kk_lrc.current = -1;
            kk_lrc.scroll_lrc();
            kk_lrc.check_lrc_update();
        }else{
            kk_lrc.check_lrc_update();
        }
    }, 100);
    tmp_interval[1]=setInterval(function(){
        if(kk_lrc._target == kk_lrc.target) return;
        if(Math.abs(kk_lrc.lrc_obj.scrollTop - kk_lrc._target) &gt; kk_lrc.lrc_height){
            kk_lrc._target = kk_lrc.lrc_obj.scrollTop;
        }
        if(kk_lrc.player_obj.paused){
            kk_lrc._target = kk_lrc.fixFloat(kk_lrc._target * 0.8 + kk_lrc.target * 0.2);
        }else{
            kk_lrc._target = kk_lrc.fixFloat(kk_lrc._target * 0.98 + kk_lrc.target * 0.02);
        }
        kk_lrc.lrc_obj.scrollTop = kk_lrc._target;
    }, 5);
</code></pre><p> };<br> kk_lrc.add_lrc = function (time, lrc) {</p>
<pre><code>kk_lrc.lrc.push(parseFloat(time) + kk_lrc.offset);
var lrc_line = document.createElement(&quot;li&quot;);
lrc_line.innerHTML = lrc;
kk_lrc.lrc_obj.appendChild(lrc_line);
</code></pre><p> };<br> kk_lrc.get_lrc = function (num) {</p>
<pre><code>if(typeof kk_lrc.lrc[num] != &quot;undefined&quot;){
    return kk_lrc.lrc[num][1];
}else{
    return &apos;&apos;;
}
</code></pre><p> }<br> kk_lrc.setoffset = function (num) {</p>
<pre><code>kk_lrc.offset = num / 1000;
</code></pre><p> }<br> kk_lrc.fixFloat = function (num) {</p>
<pre><code>return Math.ceil(num * 10) / 10;
</code></pre><p> }<br> return kk_lrc;<br>}<br> function get_music() {</p>
<pre><code>$(&quot;#audio_player&quot;).html(&apos;&lt;p&gt;正在加载播放器，请稍候&lt;/p&gt;&apos;);
if (&quot;undefined&quot;==typeof $.cookie(&quot;music_list&quot;) || $.cookie(&quot;music_list&quot;)==null) {
    var music_id=0;
} else {
    var cookie_music=JSON.parse($.cookie(&quot;music_list&quot;));
    if ((cookie_music[&apos;id&apos;]+1)==cookie_music[&apos;length&apos;]) {
        var music_id=0;
    } else {
        var music_id=cookie_music[&apos;id&apos;]+1;
    }
}
var music_id=(&quot;undefined&quot;!==typeof arguments[0])?arguments[0]:music_id;
$.ajax({
    type: &apos;get&apos;,
    url: &apos;/music_list.php&apos;,
    dataType: &apos;json&apos;,
    timeout: 3000,
    data: {&quot;action&quot;:&quot;get_music&quot;,&quot;id&quot;:music_id},
    success: function(music) {
        $(&quot;#audio_player&quot;).html(&apos;&lt;p&gt;当前&lt;span id=&quot;audio_player_status&quot;&gt;正在缓冲准备播放&lt;/span&gt;的是:&lt;br /&gt;&lt;span id=&quot;music_name&quot;&gt;&apos; +  music[&apos;name&apos;] + &apos; - &apos; + music[&apos;singer&apos;] + &apos;&lt;/span&gt;&amp;nbsp;&lt;a href=&quot;####&quot; id=&quot;reload_audio_player&quot;&gt;换一首&lt;/a&gt;&lt;/p&gt;&apos;);
        if (typeof $(&quot;#audio_list&quot;).html()!==&apos;undefined&apos;) $(&quot;#audio_list&quot;).html($(&quot;#audio_list&quot;).html().replace(/&lt;\/?span.*?&gt;/g,&apos;&apos;).replace($(&quot;#music_name&quot;).html(),&apos;&lt;span style=&quot;font-weight: bold; color: red&quot;&gt;&apos;+$(&quot;#music_name&quot;).html()+&apos;&lt;/span&gt;&apos;));
        if ($(document).width()&gt;=768 &amp;&amp; (new Date().getHours()&gt;=8 &amp;&amp; new Date().getHours()&lt;23)) {
            $(&quot;#player_player&quot;).attr(&quot;autoplay&quot;,&quot;autoplay&quot;);
        }
        $(&quot;#player_player&quot;).attr(&quot;src&quot;,music[&apos;url&apos;]);
        if (music[&apos;lrc&apos;]==&quot;0&quot;) {
            $(&quot;#kk_lrc_box&quot;).css(&quot;display&quot;,&quot;none&quot;);
        } else {
            $(&quot;#kk_lrc_box&quot;).css(&quot;display&quot;,&quot;block&quot;);
            if (music[&apos;lrc_data&apos;]!==&quot;&quot;) {
                add_lrc(music[&apos;lrc_data&apos;]);
            } else {
                get_lrc(music[&apos;name&apos;],music[&apos;singer&apos;]);
            }
        }
        $(&quot;#audio_player2&quot;).html(&apos;&lt;!-- id=&apos; + music_id + &apos; mysql_id=&apos; + music[&apos;id&apos;] + &apos; --&gt;&apos; + (($(document).width()&lt;768 || new Date().getHours()&lt;8 || new Date().getHours()&gt;=23)?&quot;&lt;p&gt;&lt;small&gt;已为您关闭了自动播放&lt;/small&gt;&lt;/p&gt;&quot;:&quot;&quot;));
        $.cookie(&quot;music_list&quot;,&apos;{&quot;id&quot;:&apos;+ music_id + &apos;,&quot;length&quot;:&apos; + music[&apos;length&apos;] + &apos;}&apos;,{expires: 7, path: &apos;/&apos;});
    },
    error: function(XMLHttpRequest,status) {
        if (status == &apos;timeout&apos;) {
            $(&quot;#audio_player&quot;).html(&apos;&lt;p&gt;请求超时，&lt;a href=&quot;####&quot; id=&quot;reload_audio_player&quot;&gt;重新加载&lt;/a&gt;&lt;/p&gt;&apos;);
            return true;
        } else {
            $(&quot;#audio_player&quot;).html(&apos;&lt;p&gt;无法请求播放数据&lt;/p&gt;&apos;);
            return true;
        }
    }
});
</code></pre><p> }<br> function change_audio_player_status() {</p>
<pre><code>$(&quot;#audio_player_status&quot;).html(&quot;正在播放&quot;)
</code></pre><p> }<br> $(function() {</p>
<pre><code>get_music();
$(&quot;#audio_player&quot;).on(&apos;click&apos;, &quot;#reload_audio_player&quot;, function() {
    get_music();
});
</code></pre><p> });<br></script><br><span id="audio_player"></span><br><audio src="" controls="controls" onended="get_music()" onplaying="change_audio_player_status()" style="width: 100%" id="player_player">您的浏览器不支持 HTML5</audio><br><span id="audio_player2"></span><br><div class="kk_lrc_box" id="kk_lrc_box"><ul id="player_lrc" class="kk_lrc"></p>
</li>
</ul>
<p></ul></div><br><code>`</code></p>
<p>四、将下面这个文件解压上传至根目录，里面分别是 jQuery 的 JSON 插件和 Cookies 插件<br><a href="http://futa.ooo/wp-content/uploads/2014/01/jq.zip">jq.zip</a></p>
<p>效果如本页所示。有段时间没写 php 了，如果有什么 bug 或者建议请评论，谢谢</p>
</style></p>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/程序发布/">程序发布</a>
    </span>
    

    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2018 403 Forbidden
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>