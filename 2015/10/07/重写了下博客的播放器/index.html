<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>重写了下博客的播放器 | 博客</title>

  
  <meta name="author" content="403 Forbidden">
  

  
  <meta name="description" content="国庆无聊，对博客的播放器做了比较大幅度的修改，总结一下现有以下改进:

添加了”自动播放”复选框，可以由用户自主决定是否需要播放背景音乐(其实歌都不错的。。)


使用 node.js 重写了多标签的背景音乐控制器，主要是为了避免产生当用户打开多个标签后背景音乐同时播放的问题

抱着开源共享的想法，">
  

  
  
  <meta name="keywords" content="">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="重写了下博客的播放器"/>

  <meta property="og:site_name" content="博客"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">博客</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>重写了下博客的播放器</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/10/07/重写了下博客的播放器/" rel="bookmark">
        <time class="entry-date published" datetime="2015-10-07T02:03:16.000Z">
          2015-10-07
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>国庆无聊，对博客的播放器做了比较大幅度的修改，总结一下现有以下改进:</p>
<ol>
<li>添加了”自动播放”复选框，可以由用户自主决定是否需要播放背景音乐(其实歌都不错的。。)</li>
</ol>
<ol start="2">
<li>使用 node.js 重写了多标签的背景音乐控制器，主要是为了避免产生当用户打开多个标签后背景音乐同时播放的问题</li>
</ol>
<p>抱着开源共享的想法，现在这里共享一下控制器源码。播放器的就不特地写了，都是前端的东西，右键”查看源代码”即可。如果有什么 bug，希望各位提出，谢谢各位。<br>`var app = require(‘express’)();<br>var http = require(‘http’).Server(app);<br>var io = require(‘socket.io’)(http);</p>
<p>app.get(‘/‘, function(req, res){<br>    res.send(‘</p><h1>Welcome Realtime Server</h1>‘);<br>});<p></p>
<p>function count(o){<br>    var t = typeof o;<br>    if (t == ‘string’) {<br>        return o.length;<br>    } else if (t == ‘object’) {<br>        var n = 0;<br>        for (var i in o) {<br>                n++;<br>        }<br>        return n;<br>    }<br>    return false;<br>}; </p>
<p>Date.prototype.Format = function (fmt) {<br>    var o = {<br>        “M+”: this.getMonth() + 1,<br>        “d+”: this.getDate(),<br>        “h+”: this.getHours(),<br>        “m+”: this.getMinutes(),<br>        “s+”: this.getSeconds(),<br>        “q+”: Math.floor((this.getMonth() + 3) / 3),<br>        “S”: this.getMilliseconds()<br>    };<br>    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + “”).substr(4 - RegExp.$1.length));<br>    for (var k in o)<br>    if (new RegExp(“(“ + k + “)”).test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : ((“00” + o[k]).substr((“” + o[k]).length)));<br>    return fmt;<br>}</p>
<p>var dump_log=function(msg) {<br>    //console.log(“\033[40;33m”+new Date().Format(“yyyy-MM-dd hh:mm:ss”)+”\033[0m\n”+msg+”\nNow “+count(clients)+” user(s) online.”);<br>    console.log(new Date().Format(“yyyy-MM-dd hh:mm:ss”)+”\n”+msg+”\nNow “+count(clients)+” user(s) online.”);<br>}</p>
<p>var onlineCount = 0;<br>var index=0;<br>global[‘clients’]={};</p>
<p>io.on(‘connection’, function(socket){</p>
<pre><code>socket.on(&apos;bindkey&apos;, function(str){
    if (!str.match(/^[a-z0-9]{64}$/)) {
        dump_log(&quot;data: &quot;+str+&quot;\nip: &quot;+socket.handshake.address);
        return false;
    }
    socket.bindkey = str;
    socket.index = index;
    if (typeof global[&apos;clients&apos;][str]==&quot;undefined&quot;) {
        global[&apos;clients&apos;][str]={};
        onlineCount++;
    }
    global[&apos;clients&apos;][str][index]={&apos;playing&apos;:(count(global[&apos;clients&apos;][str])==0?1:0),&apos;socket&apos;:socket,&apos;ip&apos;:socket.handshake.address,&apos;index&apos;:index};
    socket.emit(&quot;message&quot;,[0,index,global[&apos;clients&apos;][str][index][&apos;playing&apos;]]);
    dump_log(&quot;bindkey: &quot;+str+&quot;, index: &quot;+index+&quot;, ip: &quot;+socket.handshake.address);
    index++;
});

socket.on(&apos;disconnect&apos;, function(){
    delete global[&apos;clients&apos;][socket.bindkey][socket.index];
    if (count(global[&apos;clients&apos;][socket.bindkey])!==0) {
        for (var ckey in global[&apos;clients&apos;][socket.bindkey]) {
            var ready_play=global[&apos;clients&apos;][socket.bindkey][ckey];
            break;
        }
        ready_play[&apos;playing&apos;]=1;
        ready_play.socket.emit(&quot;message&quot;,[1,ready_play.socket.index,1]);
    } else {
        delete global[&apos;clients&apos;][socket.bindkey];
        onlineCount--;
    }
    dump_log(&quot;bindkey: &quot;+socket.bindkey+&quot;, index: &quot;+socket.index+&quot;, ip: &quot;+socket.handshake.address+&quot; offline.&quot;);
});
</code></pre><p>});</p>
<p>http.listen(3000, function(){<br>    console.log(‘listening on *:3000’);<br>});<br><code>`</code></p>
<p>Docker 项目地址: <a href="https://github.com/jshensh/audioController" target="_blank" rel="noopener">https://github.com/jshensh/audioController</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2018 403 Forbidden
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>