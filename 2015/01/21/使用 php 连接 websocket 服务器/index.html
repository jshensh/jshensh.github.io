<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>使用 php 连接 websocket 服务器 | 博客</title>

  
  <meta name="author" content="403 Forbidden">
  

  
  <meta name="description" content="最近在写一个问卷调查（也可以投票用）系统，因为有一个大屏幕需要实时显示结果，于是用了 websocket。考虑到投票用户用的浏览器可能不支持 websocket，于是就只写了一个普通的表单，向 websocket 传消息的任务就交给了 php。百度了下，找到了个现成的客户端（PHP Websocke">
  

  
  
  <meta name="keywords" content="">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="使用 php 连接 websocket 服务器"/>

  <meta property="og:site_name" content="博客"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">博客</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>使用 php 连接 websocket 服务器</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/01/21/使用 php 连接 websocket 服务器/" rel="bookmark">
        <time class="entry-date published" datetime="2015-01-21T00:03:00.000Z">
          2015-01-21
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>　　最近在写一个问卷调查（也可以投票用）系统，因为有一个大屏幕需要实时显示结果，于是用了 websocket。考虑到投票用户用的浏览器可能不支持 websocket，于是就只写了一个普通的表单，向 websocket 传消息的任务就交给了 php。百度了下，找到了个现成的客户端（<a href="http://download.csdn.net/download/byjlwaa/5389173" target="_blank" rel="noopener">PHP Websocket 客户端 - 下载频道 - CSDN.NET</a>），但是下载下来以后试了下发现无法正常使用，于是调整了它的 header，server 端则打印出通讯的 log，结果发现，连接是可以正常建立的，发送数据却失败。查了下资料（<a href="http://www.cnblogs.com/yjf512/archive/2013/03/11/2953483.html" target="_blank" rel="noopener">关于websocket - 轩脉刃 - 博客园</a>），发现源码中的 senddata 的 function 是错误的，它没有对数据进行处理就直接发送了。发现问题后，我根据通讯协议对源码做了如下修改：<br>`    public function sendData($data)<br>    {<br>        // send actual data:<br>        fwrite($this-&gt;_Socket, $this-&gt;encode($data)) or die(‘Error:’ . $errno . ‘:’ . $errstr);<br>        $wsData = fread($this-&gt;_Socket, 2000);<br>        $retData = trim($wsData,chr(0).chr(255));<br>        return $retData;<br>    }</p>
<pre><code>private function encode( $data ) {
    $data = is_array( $data ) || is_object( $data ) ? json_encode( $data ) : (string) $data;
    $len = strlen( $data );
    $mask=array();
    for ($j=0;$j&lt;4;$j++) {
        $mask[]=mt_rand(1,255);
    }
    $head[0] = 129;
    if ( $len &lt;= 125 ) {
        $head[1] = $len;
    } elseif ( $len &lt;= 65535 ) {
        $split = str_split( sprintf(&apos;%016b&apos;, $len ), 8 );
        $head[1] = 126;
        $head[2] = bindec( $split[0] );
        $head[3] = bindec( $split[1] );
    } else {
        $split = str_split( sprintf(&apos;%064b&apos;, $len ), 8 );
        $head[1] = 127;
        for ( $i = 0; $i &lt; 8; $i++ ) {
            $head[$i+2] = bindec( $split[$i] );
        }
        if ( $head[2] &gt; 127 ) {
            return false;
        }
    }
    $head[1]+=128;
    $head=array_merge($head,$mask);
    foreach( $head as $k =&gt; $v ) {
        $head[$k] = chr( $v );
    }

    $mask_data=&apos;&apos;;
    for ($j=0;$j&lt;$len;$j++) {
        $mask_data.=chr(ord($data[$j]) ^ $mask[$j % 4]);
    }
    return implode(&apos;&apos;, $head ) . $mask_data;
}

private function _connect($host, $port)
{
    $key1 = $this-&gt;_generateRandomString(32);
    $key2 = $this-&gt;_generateRandomString(32);
    $key3 = $this-&gt;_generateRandomString(8, false, true);        

            $header = &quot;GET ws://&quot;.$host.&quot;:&quot;.$port.&quot;/ HTTP/1.1\r\n&quot;;
            $header.= &quot;Host: &quot;.$host.&quot;:&quot;.$port.&quot;\r\n&quot;;
            $header.= &quot;Connection: Upgrade\r\n&quot;;
            $header.= &quot;Pragma: no-cache\r\n&quot;;
            $header.= &quot;Cache-Control: no-cache\r\n&quot;;
            $header.= &quot;Upgrade: websocket\r\n&quot;;
            $header.= &quot;Sec-WebSocket-Version: 13\r\n&quot;;
            $header.= &quot;User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36\r\n&quot;;
            $header.= &quot;Accept-Encoding: gzip, deflate, sdch\r\n&quot;;
            $header.= &quot;Accept-Language: zh-CN,zh;q=0.8\r\n&quot;;
            $header.= &quot;Sec-WebSocket-Key: &quot; . $key1 . &quot;\r\n&quot;;
            $header.= &quot;Sec-WebSocket-Extensions: permessage-deflate; client_max_window_bits\r\n&quot;;
            $header.= &quot;\r\n&quot;;


    $this-&gt;_Socket = fsockopen($host, $port, $errno, $errstr, 2); 
    fwrite($this-&gt;_Socket, $header) or die(&apos;Error: &apos; . $errno . &apos;:&apos; . $errstr); 
    $response = fread($this-&gt;_Socket, 2000);

    /**
     * @todo: check response here. Currently not implemented cause &quot;2 key handshake&quot; is already deprecated.
     * See: http://en.wikipedia.org/wiki/WebSocket#WebSocket_Protocol_Handshake
     */        

    return true;
}
</code></pre><p><code>`</code></p>
<p>　　替换源码中的 sendData 与 _connect 并添加 encode function 即可，因为修改之前的源码是别人发布的，所以下载见文章开头的 csdn 链接。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2018 403 Forbidden
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>