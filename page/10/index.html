<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 10 页 | 博客</title>

  
  <meta name="author" content="403 Forbidden">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="博客"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">博客</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/categories">分类</a></li>
      
        <li><a href="/about.html">关于</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    
  <article>

  
    
    <h3 class="article-title"><a href="/2015/01/30/解决json_encode中文UNICODE转码问题/"><span>解决json_encode中文UNICODE转码问题</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/01/30/解决json_encode中文UNICODE转码问题/" rel="bookmark">
        <time class="entry-date published" datetime="2015-01-30T00:32:22.000Z">
          2015-01-30
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>前段时间做东西时用到了 json，php 自带的 json_encode 会将 unicode 字符转码，以 \uxxxx 的形式输出，这样不方便调试，并且，不方便插入数据库（mysql 会自动去掉反斜杠，变成 uxxxx）。于是在网上找到了如下两种解决方案：</p>
<ol>
<li><p>JSON_UNESCAPED_UNICODE：<br>该方法只适用于 php 5.4 及以上版本，使用方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> json_encode(<span class="string">"中文"</span>, JSON_UNESCAPED_UNICODE);</span><br></pre></td></tr></table></figure>
</li>
<li><p>自己写 function 处理：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ch_json_encode</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">ch_urlencode</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (is_array($data) || is_object($data)) &#123;</span><br><span class="line">           <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">               <span class="keyword">if</span> (is_scalar($v)) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (is_array($data)) &#123;</span><br><span class="line">                       $data[$k] = urlencode($v);</span><br><span class="line">                   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (is_object($data)) &#123;</span><br><span class="line">                       $data-&gt;$k = urlencode($v);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (is_array($data)) &#123;</span><br><span class="line">                   $data[$k] = ch_urlencode($v); <span class="comment">//递归调用该函数</span></span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (is_object($data)) &#123;</span><br><span class="line">                   $data-&gt;$k = ch_urlencode($v);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> $data;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   $ret = ch_urlencode($data);</span><br><span class="line">   $ret = json_encode($ret);</span><br><span class="line">   <span class="keyword">return</span> urldecode($ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>个人觉得第二种方法有 bug，以前有过输出 \’ 的经历。</p>
<p>参考 <a href="http://blog.csdn.net/lanqiao825/article/details/26700809" target="_blank" rel="noopener">http://blog.csdn.net/lanqiao825/article/details/26700809</a>、<a href="http://blog.sina.com.cn/s/blog_6ad6243801016zqo.html" target="_blank" rel="noopener">http://blog.sina.com.cn/s/blog_6ad6243801016zqo.html</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/01/30/解决json_encode中文UNICODE转码问题/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/01/28/mysql中You can't specify target table for update in FROM clause错误/"><span>mysql中You can&#39;t specify target table for update in FROM clause错误</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/01/28/mysql中You can't specify target table for update in FROM clause错误/" rel="bookmark">
        <time class="entry-date published" datetime="2015-01-27T22:24:07.000Z">
          2015-01-28
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>mysql中You can’t specify target table  for update in FROM clause错误的意思是说，不能先select出同一表中的某些值，再update这个表(在同一语句中)。 例如下面这个sql：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> tbl <span class="keyword">where</span> <span class="keyword">id</span> <span class="keyword">in</span> </span><br><span class="line">(</span><br><span class="line">        <span class="keyword">select</span> <span class="keyword">max</span>(<span class="keyword">id</span>) <span class="keyword">from</span> tbl a <span class="keyword">where</span> <span class="keyword">EXISTS</span></span><br><span class="line">        (</span><br><span class="line">            <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> tbl b <span class="keyword">where</span> a.tac=b.tac <span class="keyword">group</span> <span class="keyword">by</span> tac <span class="keyword">HAVING</span> <span class="keyword">count</span>(<span class="number">1</span>)&gt;<span class="number">1</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> tac</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>改写成下面就行了：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> tbl <span class="keyword">where</span> <span class="keyword">id</span> <span class="keyword">in</span> </span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> a.id <span class="keyword">from</span> </span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">select</span> <span class="keyword">max</span>(<span class="keyword">id</span>) <span class="keyword">id</span> <span class="keyword">from</span> tbl a <span class="keyword">where</span> <span class="keyword">EXISTS</span></span><br><span class="line">        (</span><br><span class="line">            <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> tbl b <span class="keyword">where</span> a.tac=b.tac <span class="keyword">group</span> <span class="keyword">by</span> tac <span class="keyword">HAVING</span> <span class="keyword">count</span>(<span class="number">1</span>)&gt;<span class="number">1</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> tac</span><br><span class="line">    ) a</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>也就是说将select出的结果再通过中间表select一遍，这样就规避了错误。注意，这个问题只出现于mysql，mssql和oracle不会出现此问题。</p>
<p>转载自：<a href="http://blog.csdn.net/priestmoon/article/details/8016121" target="_blank" rel="noopener">http://blog.csdn.net/priestmoon/article/details/8016121</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/01/28/mysql中You can't specify target table for update in FROM clause错误/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/01/21/使用 php 连接 websocket 服务器/"><span>使用 php 连接 websocket 服务器</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/01/21/使用 php 连接 websocket 服务器/" rel="bookmark">
        <time class="entry-date published" datetime="2015-01-21T00:03:00.000Z">
          2015-01-21
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>　　最近在写一个问卷调查（也可以投票用）系统，因为有一个大屏幕需要实时显示结果，于是用了 websocket。考虑到投票用户用的浏览器可能不支持 websocket，于是就只写了一个普通的表单，向 websocket 传消息的任务就交给了 php。百度了下，找到了个现成的客户端（<a href="http://download.csdn.net/download/byjlwaa/5389173" target="_blank" rel="noopener">PHP Websocket 客户端 - 下载频道 - CSDN.NET</a>），但是下载下来以后试了下发现无法正常使用，于是调整了它的 header，server 端则打印出通讯的 log，结果发现，连接是可以正常建立的，发送数据却失败。查了下资料（<a href="http://www.cnblogs.com/yjf512/archive/2013/03/11/2953483.html" target="_blank" rel="noopener">关于websocket - 轩脉刃 - 博客园</a>），发现源码中的 senddata 的 function 是错误的，它没有对数据进行处理就直接发送了。发现问题后，我根据通讯协议对源码做了如下修改：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendData</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// send actual data:</span></span><br><span class="line">	fwrite(<span class="keyword">$this</span>-&gt;_Socket, <span class="keyword">$this</span>-&gt;encode($data)) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'Error:'</span> . $errno . <span class="string">':'</span> . $errstr);</span><br><span class="line">	$wsData = fread(<span class="keyword">$this</span>-&gt;_Socket, <span class="number">2000</span>);</span><br><span class="line">	$retData = trim($wsData,chr(<span class="number">0</span>).chr(<span class="number">255</span>));        </span><br><span class="line">	<span class="keyword">return</span> $retData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">encode</span><span class="params">( $data )</span> </span>&#123;</span><br><span class="line">       $data = is_array( $data ) || is_object( $data ) ? json_encode( $data ) : (string) $data;</span><br><span class="line">       $len = strlen( $data );</span><br><span class="line">       $mask=<span class="keyword">array</span>();</span><br><span class="line">       <span class="keyword">for</span> ($j=<span class="number">0</span>;$j&lt;<span class="number">4</span>;$j++) &#123;</span><br><span class="line">           $mask[]=mt_rand(<span class="number">1</span>,<span class="number">255</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       $head[<span class="number">0</span>] = <span class="number">129</span>;</span><br><span class="line">       <span class="keyword">if</span> ( $len &lt;= <span class="number">125</span> ) &#123;</span><br><span class="line">           $head[<span class="number">1</span>] = $len;</span><br><span class="line">       &#125; <span class="keyword">elseif</span> ( $len &lt;= <span class="number">65535</span> ) &#123;</span><br><span class="line">           $split = str_split( sprintf(<span class="string">'%016b'</span>, $len ), <span class="number">8</span> );</span><br><span class="line">           $head[<span class="number">1</span>] = <span class="number">126</span>;</span><br><span class="line">           $head[<span class="number">2</span>] = bindec( $split[<span class="number">0</span>] );</span><br><span class="line">           $head[<span class="number">3</span>] = bindec( $split[<span class="number">1</span>] );</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           $split = str_split( sprintf(<span class="string">'%064b'</span>, $len ), <span class="number">8</span> );</span><br><span class="line">           $head[<span class="number">1</span>] = <span class="number">127</span>;</span><br><span class="line">           <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; <span class="number">8</span>; $i++ ) &#123;</span><br><span class="line">               $head[$i+<span class="number">2</span>] = bindec( $split[$i] );</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> ( $head[<span class="number">2</span>] &gt; <span class="number">127</span> ) &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       $head[<span class="number">1</span>]+=<span class="number">128</span>;</span><br><span class="line">       $head=array_merge($head,$mask);</span><br><span class="line">       <span class="keyword">foreach</span>( $head <span class="keyword">as</span> $k =&gt; $v ) &#123;</span><br><span class="line">           $head[$k] = chr( $v );</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       $mask_data=<span class="string">''</span>;</span><br><span class="line">       <span class="keyword">for</span> ($j=<span class="number">0</span>;$j&lt;$len;$j++) &#123;</span><br><span class="line">           $mask_data.=chr(ord($data[$j]) ^ $mask[$j % <span class="number">4</span>]);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> implode(<span class="string">''</span>, $head ) . $mask_data;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">_connect</span><span class="params">($host, $port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	$key1 = <span class="keyword">$this</span>-&gt;_generateRandomString(<span class="number">32</span>);</span><br><span class="line">	$key2 = <span class="keyword">$this</span>-&gt;_generateRandomString(<span class="number">32</span>);</span><br><span class="line">	$key3 = <span class="keyword">$this</span>-&gt;_generateRandomString(<span class="number">8</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);		</span><br><span class="line"></span><br><span class="line">               $header = <span class="string">"GET ws://"</span>.$host.<span class="string">":"</span>.$port.<span class="string">"/ HTTP/1.1\r\n"</span>;</span><br><span class="line">               $header.= <span class="string">"Host: "</span>.$host.<span class="string">":"</span>.$port.<span class="string">"\r\n"</span>;</span><br><span class="line">               $header.= <span class="string">"Connection: Upgrade\r\n"</span>;</span><br><span class="line">               $header.= <span class="string">"Pragma: no-cache\r\n"</span>;</span><br><span class="line">               $header.= <span class="string">"Cache-Control: no-cache\r\n"</span>;</span><br><span class="line">               $header.= <span class="string">"Upgrade: websocket\r\n"</span>;</span><br><span class="line">               $header.= <span class="string">"Sec-WebSocket-Version: 13\r\n"</span>;</span><br><span class="line">               $header.= <span class="string">"User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36\r\n"</span>;</span><br><span class="line">               $header.= <span class="string">"Accept-Encoding: gzip, deflate, sdch\r\n"</span>;</span><br><span class="line">               $header.= <span class="string">"Accept-Language: zh-CN,zh;q=0.8\r\n"</span>;</span><br><span class="line">               $header.= <span class="string">"Sec-WebSocket-Key: "</span> . $key1 . <span class="string">"\r\n"</span>;</span><br><span class="line">               $header.= <span class="string">"Sec-WebSocket-Extensions: permessage-deflate; client_max_window_bits\r\n"</span>;</span><br><span class="line">               $header.= <span class="string">"\r\n"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">$this</span>-&gt;_Socket = fsockopen($host, $port, $errno, $errstr, <span class="number">2</span>); </span><br><span class="line">	fwrite(<span class="keyword">$this</span>-&gt;_Socket, $header) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'Error: '</span> . $errno . <span class="string">':'</span> . $errstr); </span><br><span class="line">	$response = fread(<span class="keyword">$this</span>-&gt;_Socket, <span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@todo</span>: check response here. Currently not implemented cause "2 key handshake" is already deprecated.</span></span><br><span class="line"><span class="comment">	 * See: http://en.wikipedia.org/wiki/WebSocket#WebSocket_Protocol_Handshake</span></span><br><span class="line"><span class="comment">	 */</span>		</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>　　替换源码中的 sendData 与 _connect 并添加 encode function 即可，因为修改之前的源码是别人发布的，所以下载见文章开头的 csdn 链接。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/01/21/使用 php 连接 websocket 服务器/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/01/17/使用Raspberry Pi作为无线路由器/"><span>使用Raspberry Pi作为无线路由器</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/01/17/使用Raspberry Pi作为无线路由器/" rel="bookmark">
        <time class="entry-date published" datetime="2015-01-16T20:14:47.000Z">
          2015-01-17
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>鉴于之前的教程过于麻烦。。自己也从头试了一下，发现有点问题，于是本人决定全部推倒重写一遍（注：本文采用的无线网卡为 TP-LINK WN823N，RTL8192CU 芯片）</p>
<p>另外，文章中用了 vi 编辑器，树莓派自带 vim-tiny，有点反人类，apt-get install vim 解决问题</p>
<p>参考了以下两篇文章（如果只按照其中的一篇来都不会成功，所以整理了一下）：</p>
<ul>
<li><a href="http://wangye.org/blog/archives/845/" target="_blank" rel="noopener">http://wangye.org/blog/archives/845/</a></li>
</ul>
<ul>
<li><a href="http://shumeipai.nxez.com/2014/04/01/raspberry-pi-wireless-router.html" target="_blank" rel="noopener">http://shumeipai.nxez.com/2014/04/01/raspberry-pi-wireless-router.html</a></li>
</ul>
<p><strong>一、安装dhcp服务和ap热点服务</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install isc-dhcp-server hostapd</span><br></pre></td></tr></table></figure></p>
<p><strong>二、配置无线网络</strong><br><strong>本文搭建的无线网络使用了 192.168.51 网段，如有需要，请自行修改，后文同</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/network/interfaces</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">auto lo</span><br><span class="line"></span><br><span class="line">iface lo inet loopback</span><br><span class="line">iface eth0 inet dhcp</span><br><span class="line"></span><br><span class="line">allow-hotplug wlan0</span><br><span class="line">iface wlan0 inet static</span><br><span class="line">    address 192.168.51.1</span><br><span class="line">    netmask 255.255.255.0</span><br><span class="line"></span><br><span class="line">iface default inet dhcp</span><br></pre></td></tr></table></figure>
<p><strong>三、修改 DHCP Server 设置</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/dhcp/dhcpd.conf</span><br></pre></td></tr></table></figure></p>
<p>在最后添加，注意是在最后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">subnet 192.168.51.0 netmask 255.255.255.0 &#123;</span><br><span class="line">    range 192.168.51.100 192.168.51.254;</span><br><span class="line">    option subnet-mask 255.255.255.0;</span><br><span class="line">    option broadcast-address 192.168.51.255;</span><br><span class="line">    option routers 192.168.51.1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>四、打开内核的网卡转发能力</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br></pre></td></tr></table></figure></p>
<p>将 net.ipv4.ip_forward=1 的注释去掉</p>
<p><strong>五、重新编译 hostapd 使其支持 RTL8192CU 芯片的无线网卡</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://futa.ooo/uploads/2015/01/RTL8188-hostapd-master.zip</span><br><span class="line">unzip RTL8188-hostapd-master.zip</span><br><span class="line">cd RTL8188-hostapd-master/hostapd</span><br><span class="line">make;make install</span><br></pre></td></tr></table></figure></p>
<p><strong>六、修改 iptables 的 nat 规则并保存</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="line">iptables -A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A FORWARD -i wlan0 -o eth0 -j ACCEPT</span><br><span class="line">iptables-save &gt; /etc/iptables.ipv4.nat</span><br></pre></td></tr></table></figure></p>
<p>开机自动加载 iptables 规则：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/rc.local</span><br></pre></td></tr></table></figure></p>
<p>在 exit 0; 前面添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables-restore&lt;/etc/iptables.ipv4.nat</span><br></pre></td></tr></table></figure></p>
<p><strong>七、修改无线网络的设置</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/hostapd/hostapd.conf</span><br></pre></td></tr></table></figure></p>
<p>只需要改两行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># Basic configuration</span><br><span class="line"></span><br><span class="line">interface=wlan0</span><br><span class="line">ssid=sxbxjhwm_raspberry # SSID，修改</span><br><span class="line">channel=1</span><br><span class="line">#bridge=br0</span><br><span class="line"></span><br><span class="line"># WPA and WPA2 configuration</span><br><span class="line"></span><br><span class="line">macaddr_acl=0</span><br><span class="line">auth_algs=1</span><br><span class="line">ignore_broadcast_ssid=0</span><br><span class="line">wpa=3</span><br><span class="line">wpa_passphrase=87654321 # 密码，修改</span><br><span class="line">wpa_key_mgmt=WPA-PSK</span><br><span class="line">wpa_pairwise=TKIP</span><br><span class="line">rsn_pairwise=CCMP</span><br><span class="line"></span><br><span class="line"># Hardware configuration</span><br><span class="line"></span><br><span class="line">driver=rtl871xdrv</span><br><span class="line">ieee80211n=1</span><br><span class="line">hw_mode=g</span><br><span class="line">device_name=RTL8192CU</span><br><span class="line">manufacturer=Realtek</span><br></pre></td></tr></table></figure></p>
<p><strong>P.S. 如果 DHCP 获取不到 IP，需要添加自启动：</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/rc.local</span><br></pre></td></tr></table></figure></p>
<p>在 exit 0 之前添加以下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ifdown wlan0</span><br><span class="line">ifup wlan0</span><br><span class="line">ifconfig wlan0 192.168.51.1 netmask 255.255.255.0</span><br><span class="line">service isc-dhcp-server restart</span><br><span class="line">service hostapd restart</span><br></pre></td></tr></table></figure></p>
<hr>
<p>实验成功，效果图：<br><a href="/uploads/2015/01/QQ截图20150116205540.jpg"><img src="/uploads/2015/01/QQ截图20150116205540-300x154.jpg" alt="QQ截图20150116205540"></a><br><a href="/uploads/2015/01/QQ图片20150116205445-e1421413729569.jpg"><img src="/uploads/2015/01/QQ图片20150116205445-e1421413729569-169x300.jpg" alt="QQ图片20150116205445"></a><br><a href="/uploads/2015/01/QQ图片20150116205452.png"><img src="/uploads/2015/01/QQ图片20150116205452-169x300.png" alt="QQ图片20150116205452"></a><br><a href="/uploads/2015/01/QQ图片20150116205458.png"><img src="/uploads/2015/01/QQ图片20150116205458-169x300.png" alt="QQ图片20150116205458"></a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/树莓派/">树莓派</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/01/17/使用Raspberry Pi作为无线路由器/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/01/16/Linux umount 报 device is busy 的处理方法/"><span>Linux umount 报 device is busy 的处理方法</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/01/16/Linux umount 报 device is busy 的处理方法/" rel="bookmark">
        <time class="entry-date published" datetime="2015-01-16T03:07:40.000Z">
          2015-01-16
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>今天在IDC 辐射了半天，又弄了套DG。 在Linux 挂盘这块也小学了两招。</p>
<p><strong>一. umout 移动硬盘</strong><br>开始用sftp 将安装文件copy到服务器的时候，速度太慢了，500k/s。几个G的东西，copy 这些就要半个多小时，扛不住，拿移动硬盘来copy了。 结果移动硬盘的格式不对。 是NTFS 格式，Linux 识别不了。 只能格式化成FAT32的。 而GG 的win7 系统又不具备格式化成FAT32的功能。 有点小变态。让同事在XP 下帮我格式化了。</p>
<p>安装文件copy到服务器后，同事直接将移动硬盘从服务器上拔下来了。 导致的结果是，用df 命令查看，挂载的移动硬盘还存在。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@qs-wg-db1 ~]# df -lh</span><br><span class="line">Filesystem Size Used Avail Use% Mounted on</span><br><span class="line">/dev/sdb3 125G 3.3G 115G 3% /</span><br><span class="line">/dev/sdb1 99M 12M 82M 13% /boot</span><br><span class="line">tmpfs 3.9G 0 3.9G 0% /dev/shm</span><br><span class="line">/dev/sda1 275G 72G 189G 28% /u01</span><br><span class="line">/dev/sdc1 10G 2.0G 8.1G 20% /datatmp</span><br></pre></td></tr></table></figure>
<p>就是这个/dev/sdc1。</p>
<p>这时使用umount 命令，会提示设备忙，无法挂载。</p>
<p>处理方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@qs-wg-db1 ~]# fuser -km /datatmp</span><br><span class="line">[root@qs-wg-db1 ~]# df -lh</span><br><span class="line">Filesystem Size Used Avail Use% Mounted on</span><br><span class="line">/dev/sdb3 125G 3.3G 115G 3% /</span><br><span class="line">/dev/sdb1 99M 12M 82M 13% /boot</span><br><span class="line">tmpfs 3.9G 0 3.9G 0% /dev/shm</span><br><span class="line">/dev/sda1 275G 72G 189G 28% /u01</span><br><span class="line">/dev/sdc1 10G 2.0G 8.1G 20% /datatmp</span><br><span class="line">[root@qs-wg-db1 ~]# umount /datatmp</span><br><span class="line">[root@qs-wg-db1 ~]# df -lh</span><br><span class="line">Filesystem Size Used Avail Use% Mounted on</span><br><span class="line">/dev/sdb3 125G 3.3G 115G 3% /</span><br><span class="line">/dev/sdb1 99M 12M 82M 13% /boot</span><br><span class="line">tmpfs 3.9G 0 3.9G 0% /dev/shm</span><br><span class="line">/dev/sda1 275G 72G 189G 28% /u01</span><br></pre></td></tr></table></figure></p>
<p>成功umount了。</p>
<p><strong>二. umount 光驱</strong><br>安装DB 之前，检查了一下相关包，少了3个。 从系统安装盘上找了包，安装了一下。 当时是直接将/dev/cdrom mount 到了/mnt目录。 也是图个方便。 结果收工时去拿盘，光驱弹不出来。 同事让我把cdrom umout掉。 同样的提示，设备忙。</p>
<p>处理方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@qs-wg-db1 ~]#fuser –km /dev/cdrom</span><br><span class="line">[root@qs-wg-db1 ~]#eject -- 弹出光驱</span><br></pre></td></tr></table></figure></p>
<p>在网上搜了一下，正确挂载CD-ROM的方法应该如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># mkdir cdrom</span><br><span class="line"># mount /dev/cdrom /mnt/cdrom</span><br><span class="line">或者</span><br><span class="line"># mount /dev/cdrom /media/cdrom</span><br></pre></td></tr></table></figure>
<p>直接挂载在/mnt,/media等系统目录下，在umount时会出现出错信息“umount: /mnt/cdrom: device is busy”的情况。</p>
<p>如果一个文件系统处于“busy”状态的时候，不能卸载该文件系统。如下情况将导致文件系统处于“busy”状态：<br>1) 文件系统上面有打开的文件<br>2) 某个进程的工作目录在此文件系统上<br>3) 文件系统上面的缓存文件正在被使用</p>
<p><strong>三. fuser 命令</strong><br>前面2个umout 都使用了这个fuser 命令。 man了一下这个命令。 内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@qs-wg-db1 ~]# man fuser</span><br><span class="line">FUSER(1) User Commands FUSER(1)</span><br><span class="line"></span><br><span class="line">NAME</span><br><span class="line">fuser - identify processes using files or sockets</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">fuser [-a|-s|-c] [-4|-6] [-n space ] [-k [-i] [-signal ] ] [-muvf] name</span><br><span class="line">fuser -l</span><br><span class="line">fuser -V</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">fuser displays the PIDs of processes using the specified files or file systems. In the default display mode, each file name is followed by a letter denoting the type</span><br><span class="line">of access:</span><br><span class="line">c current directory.</span><br><span class="line">e executable being run.</span><br><span class="line">f open file. f is omitted in default display mode.</span><br><span class="line">F open file for writing. F is omitted in default display mode.</span><br><span class="line">r root directory.</span><br><span class="line">m mmap&apos;ed file or shared library.</span><br><span class="line"></span><br><span class="line">fuser returns a non-zero return code if none of the specified files is accessed or in case of a fatal error. If at least one access has been found, fuser returns zero.</span><br><span class="line">In order to look up processes using TCP and UDP sockets, the corresponding name space has to be selected with the -n option. By default fuser will look in both IPv6 and IPv4 sockets. To change the default, behavior, use the -4 and -6 options. The socket(s) can be specified by the local and remote port, and the remote address. All fields are optional, but commas in front of missing fields must be present:</span><br><span class="line">[lcl_port][,[rmt_host][,[rmt_port]]]</span><br><span class="line">Either symbolic or numeric values can be used for IP addresses and port numbers.</span><br><span class="line"></span><br><span class="line">fuser outputs only the PIDs to stdout, everything else is sent to stderr.</span><br><span class="line"></span><br><span class="line">OPTIONS</span><br><span class="line">-a Show all files specified on the command line. By default, only files that are accessed by at least one process are shown.</span><br><span class="line">-c Same as -m option, used for POSIX compatibility.</span><br><span class="line">-f Silently ignored, used for POSIX compatibility.</span><br><span class="line">-k Kill processes accessing the file. Unless changed with -signal, SIGKILL is sent. An fuser process never kills itself, but may kill other fuser processes. The effective user ID of the process executing fuser is set to its real user ID before attempting to kill.</span><br><span class="line">-i Ask the user for confirmation before killing a process. This option is silently ignored if -k is not present too.</span><br><span class="line">-l List all known signal names.</span><br><span class="line">-m name specifies a file on a mounted file system or a block device that is mounted. All processes accessing files on that file system are listed. If adirectory file is specified, it is automatically changed to name/. to use any file system that might be mounted on that directory.</span><br><span class="line"></span><br><span class="line">-n space Select a different name space. The name spaces file (file names, the default), udp (local UDP ports), and tcp (local TCP ports) are supported. For ports, either the port number or the symbolic name can be specified. If there is no ambiguity, the shortcut notation name/Ispace (e.g. 80/tcp ) can be used.</span><br><span class="line">-s Silent operation. -u and -v are ignored in this mode. -a must not be used with -s.</span><br><span class="line">-signal Use the specified signal instead of SIGKILL when killing processes. Signals can be specified either by name (e.g. -HUP) or by number (e.g. -1). This option is silently ignored if the -k option is not used.</span><br><span class="line">-u Append the user name of the process owner to each PID.</span><br><span class="line">-v Verbose mode. Processes are shown in a ps-like style. The fields PID, USER and COMMAND are similar to ps. ACCESS shows how the process accesses the file. If the access is by the kernel (e.g. in the case of a mount point, awap file, etc.), kernel is shown instead of the PID.</span><br><span class="line">-V Display version information.</span><br><span class="line">-4 Search only for IPv4 sockets. This option must not be used with the -6 option and only has an effect with the tcp and udp namespaces.</span><br><span class="line">-6 Search only for IPv6 sockets. This option must not be used with the -4 option and only has an effect with the tcp and udp namespaces.</span><br><span class="line">- Reset all options and set the signal back to SIGKILL.</span><br><span class="line">FILES</span><br><span class="line">/proc location of the proc file system</span><br></pre></td></tr></table></figure>
<p>fuser 命令显示访问某个文件的进程的PID. 其中-k 和 -m 参数上面红色部分有说明。-k 是kill 访问这个文件的进程。 没有进程访问，就可以成功umount了.</p>
<p>转载自 <a href="http://blog.csdn.net/tianlesoftware/article/details/6194295" target="_blank" rel="noopener">http://blog.csdn.net/tianlesoftware/article/details/6194295</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/VPS-技术/">VPS 技术</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/01/16/Linux umount 报 device is busy 的处理方法/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/01/11/移动端重构系列10——侧边栏导航/"><span>移动端重构系列10——侧边栏导航</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/01/11/移动端重构系列10——侧边栏导航/" rel="bookmark">
        <time class="entry-date published" datetime="2015-01-10T22:46:48.000Z">
          2015-01-11
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>本系列文章，如果没有特别说明，兼容安卓4.0.4+</p>
<p>panel一般用来做侧边栏导航，铺满整屏高度，有两种展现形式：第一种直接盖在整块内容栏（包括header和footer部分）上面，如图一；第二种把整块内容栏推开panel的宽度，如图二<br><a href="/uploads/2015/01/panel1.jpg"><img src="/uploads/2015/01/panel1.jpg" alt="panel1"></a><br><a href="/uploads/2015/01/panel2.jpg"><img src="/uploads/2015/01/panel2.jpg" alt="panel2"></a></p>
<p>设计结构如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">header</span> <span class="attr">class</span>=<span class="string">"header"</span>&gt;</span><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"wrap-page"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">"page"</span>&gt;</span><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">footer</span> <span class="attr">class</span>=<span class="string">"footer"</span>&gt;</span><span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">"panel"</span>&gt;</span><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><strong>第一种实现方案：</strong><br><a href="http://jsbin.com/sapip/1" target="_blank" rel="noopener">demo 1</a><br>先将panel通过translate偏移负的本身宽度，离开可视区域，然后通过切换active这个class来实现无偏移。当然除此之外，top和bottom的0实现了100%高度，z-index要保证大于header和footer的层级。<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$panelWidth:      120px !default;</span><br><span class="line"><span class="selector-class">.panel</span>&#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">980</span>;</span><br><span class="line">    <span class="attribute">width</span>: $panelWidth;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#333</span>;</span><br><span class="line">    @include translate3d(-$panelWidth, 0, 0);</span><br><span class="line">    @<span class="keyword">extend</span> %transition-transform;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.panel</span><span class="selector-class">.active</span>&#123;</span><br><span class="line">    @include translate3d(0, 0, 0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同样我们也可以通过给body添加删除class如panel-active来控制panel的位置。</p>
<p><strong>第二种实现方案</strong><br><a href="http://jsbin.com/sapip/2" target="_blank" rel="noopener">demo 2</a>，在demo1的基础上根据第二种方案顺便处理下了当panel出现时，内容禁止滚动<br>因为需要实现整块内容栏（包括header和footer部分）偏移panel的宽度，所以第一反应是应该有个div把整块内容栏包裹下，如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"wrap-container"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">header</span> <span class="attr">class</span>=<span class="string">"header"</span>&gt;</span><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"wrap-page"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">"page"</span>&gt;</span><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">footer</span> <span class="attr">class</span>=<span class="string">"footer"</span>&gt;</span><span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">"panel"</span>&gt;</span><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>多了一层结构，看起来有点不爽，不过使用起来还是很爽的。首先panel偏移负的本身宽度，接下来通过控制wrap-container的class来实现内容栏偏移panel的宽度<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.panel</span>&#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">z-index</span>: $zIndexOverlay;</span><br><span class="line">    <span class="attribute">width</span>: $panelWidth;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#333</span>;</span><br><span class="line">    @include translate3d(-$panelWidth, 0, 0);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.wrap-container</span>&#123;</span><br><span class="line">    @extend %transition-transform;  </span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.wrap-container</span><span class="selector-class">.panel-active</span>&#123;</span><br><span class="line">    @include translate3d($panelWidth, 0, 0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>既然这里需要一个父元素来实现一个偏移，为什么body不可以呢？所以果断干掉wrap-container，恢复最初的结构<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.panel</span>&#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">z-index</span>: $zIndexOverlay;</span><br><span class="line">    <span class="attribute">width</span>: $panelWidth;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#333</span>;</span><br><span class="line">    @include translate3d(-$panelWidth, 0, 0);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.has-panel</span>&#123;</span><br><span class="line">    @extend %transition-transform;  </span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.panel-active</span>&#123;</span><br><span class="line">    @include translate3d($panelWidth, 0, 0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>总结</strong><br>一般来说使用比较多的还是第二种方案，因为第一种直接把左边的那个点击图标遮盖住了。而panel实际使用的时候还是挺不太好办的，因为左边的第一个icon一般都是放首页，返回什么的，当然适用不适用还是根据各自业务需要走</p>
<p>转载自：<a href="http://www.w3cplus.com/mobile/mobile-terminal-refactoring-sidebar-menu.html" target="_blank" rel="noopener">http://www.w3cplus.com/mobile/mobile-terminal-refactoring-sidebar-menu.html</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/01/11/移动端重构系列10——侧边栏导航/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/01/03/记一下 openwrt 可能忘记的常用命令/"><span>记一下 openwrt 可能忘记的常用命令</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/01/03/记一下 openwrt 可能忘记的常用命令/" rel="bookmark">
        <time class="entry-date published" datetime="2015-01-03T09:04:05.000Z">
          2015-01-03
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>将 /dev/sda1 分区挂载为 swap 交换区：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkswap /dev/sda1</span><br><span class="line">swapon /dev/sda1</span><br></pre></td></tr></table></figure></p>
<p>挂载 vfat：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">opkg install kmod-fs-vfat // fat，fat32</span><br><span class="line">opkg install kmod-nls-utf8 kmod-nls-cp437 kmod-nls-iso8859-1 // 文件系统的语言支持</span><br><span class="line">mkdir sda1</span><br><span class="line">mount -t vfat /dev/sda1 sda1</span><br></pre></td></tr></table></figure></p>
<p>挂载 ntfs：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">opkg install kmod-fuse ntfs-3g</span><br><span class="line">mkdir sda1</span><br><span class="line">ntfs-3g /dev/sda1 sda1</span><br></pre></td></tr></table></figure></p>
<p>格式化分区：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opkg install e2fsprogs</span><br><span class="line">mkfs.ext4 /dev/sda1</span><br></pre></td></tr></table></figure></p>
<p>支持 extroot：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opkg install block-mount</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure></p>
<p>复制flash根分区文件到外部存储<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir /mnt/sda1</span><br><span class="line">mount /dev/sda1 /mnt/sda1</span><br><span class="line">mkdir -p /tmp/cproot</span><br><span class="line">mount --bind / /tmp/cproot/</span><br><span class="line">tar -C /tmp/cproot/ -cvf - . | tar -C /mnt/sda1 -xf -</span><br><span class="line">umount /dev/sda1</span><br></pre></td></tr></table></figure></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/openwrt/">openwrt</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/01/03/记一下 openwrt 可能忘记的常用命令/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/01/01/使用 HTML5 WebSocket 构建实时 Web 应用/"><span>使用 HTML5 WebSocket 构建实时 Web 应用</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/01/01/使用 HTML5 WebSocket 构建实时 Web 应用/" rel="bookmark">
        <time class="entry-date published" datetime="2014-12-31T21:37:21.000Z">
          2015-01-01
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>作为下一代的 Web 标准，HTML5 拥有许多引人注目的新特性，如 Canvas、本地存储、多媒体编程接口、WebSocket 等等。这其中有“Web 的 TCP ”之称的 WebSocket 格外吸引开发人员的注意。WebSocket 的出现使得浏览器提供对 Socket 的支持成为可能，从而在浏览器和服务器之间提供了一个基于 TCP 连接的双向通道。Web 开发人员可以非常方便地使用 WebSocket 构建实时 web 应用，开发人员的手中从此又多了一柄神兵利器。本文首先介绍 HTML5 WebSocket 的基本概念以及这个规范试图解决的问题，然后介绍 WebSocket 的基本原理和编程接口。接下来会通过一个简单案例来示范怎样实现一个 WebSocket 应用，并且展示 WebSocket 如何在功能强大和编程简单易用上达到的完美统一。最后介绍了目前主流浏览器对 WebSocket 支持的状况、局限性以及未来的展望。</p>
<h2 id="实时-Web-应用的窘境"><a href="#实时-Web-应用的窘境" class="headerlink" title="实时 Web 应用的窘境"></a>实时 Web 应用的窘境</h2><p>Web 应用的信息交互过程通常是客户端通过浏览器发出一个请求，服务器端接收和审核完请求后进行处理并返回结果给客户端，然后客户端浏览器将信息呈现出来，这种机制对于信息变化不是特别频繁的应用尚能相安无事，但是对于那些实时要求比较高的应用来说，比如说在线游戏、在线证券、设备监控、新闻在线播报、RSS 订阅推送等等，当客户端浏览器准备呈现这些信息的时候，这些信息在服务器端可能已经过时了。所以保持客户端和服务器端的信息同步是实时 Web 应用的关键要素，对 Web 开发人员来说也是一个难题。在 WebSocket 规范出来之前，开发人员想实现这些实时的 Web 应用，不得不采用一些折衷的方案，其中最常用的就是轮询 (Polling) 和 Comet 技术，而 Comet 技术实际上是轮询技术的改进，又可细分为两种实现方式，一种是长轮询机制，一种称为流技术。下面我们简单介绍一下这几种技术：<br><strong>轮询：</strong><br>这是最早的一种实现实时 Web 应用的方案。客户端以一定的时间间隔向服务端发出请求，以频繁请求的方式来保持客户端和服务器端的同步。这种同步方案的最大问题是，当客户端以固定频率向服务器发起请求的时候，服务器端的数据可能并没有更新，这样会带来很多无谓的网络传输，所以这是一种非常低效的实时方案。<br><strong>长轮询：</strong><br>长轮询是对定时轮询的改进和提高，目地是为了降低无效的网络传输。当服务器端没有数据更新的时候，连接会保持一段时间周期直到数据或状态改变或者时间过期，通过这种机制来减少无效的客户端和服务器间的交互。当然，如果服务端的数据变更非常频繁的话，这种机制和定时轮询比较起来没有本质上的性能的提高。<br><strong>流：</strong><br>流技术方案通常就是在客户端的页面使用一个隐藏的窗口向服务端发出一个长连接的请求。服务器端接到这个请求后作出回应并不断更新连接状态以保证客户端和服务器端的连接不过期。通过这种机制可以将服务器端的信息源源不断地推向客户端。这种机制在用户体验上有一点问题，需要针对不同的浏览器设计不同的方案来改进用户体验，同时这种机制在并发比较大的情况下，对服务器端的资源是一个极大的考验。<br>综合这几种方案，您会发现这些目前我们所使用的所谓的实时技术并不是真正的实时技术，它们只是在用 Ajax 方式来模拟实时的效果，在每次客户端和服务器端交互的时候都是一次 HTTP 的请求和应答的过程，而每一次的 HTTP 请求和应答都带有完整的 HTTP 头信息，这就增加了每次传输的数据量，而且这些方案中客户端和服务器端的编程实现都比较复杂，在实际的应用中，为了模拟比较真实的实时效果，开发人员往往需要构造两个 HTTP 连接来模拟客户端和服务器之间的双向通讯，一个连接用来处理客户端到服务器端的数据传输，一个连接用来处理服务器端到客户端的数据传输，这不可避免地增加了编程实现的复杂度，也增加了服务器端的负载，制约了应用系统的扩展性。</p>
<hr>
<h2 id="WebSocket-的拯救"><a href="#WebSocket-的拯救" class="headerlink" title="WebSocket 的拯救"></a>WebSocket 的拯救</h2><p>HTML5 WebSocket 设计出来的目的就是要取代轮询和 Comet 技术，使客户端浏览器具备像 C/S 架构下桌面系统的实时通讯能力。 浏览器通过 JavaScript 向服务器发出建立 WebSocket 连接的请求，连接建立以后，客户端和服务器端就可以通过 TCP 连接直接交换数据。因为 WebSocket 连接本质上就是一个 TCP 连接，所以在数据传输的稳定性和数据传输量的大小方面，和轮询以及 Comet 技术比较，具有很大的性能优势。Websocket.org 网站对传统的轮询方式和 WebSocket 调用方式作了一个详细的测试和比较，将一个简单的 Web 应用分别用轮询方式和 WebSocket 方式来实现，在这里引用一下他们的测试结果图：</p>
<h5 id="图-1-轮询和-WebSocket-实现方式的网络负载对比图"><a href="#图-1-轮询和-WebSocket-实现方式的网络负载对比图" class="headerlink" title="图 1. 轮询和 WebSocket 实现方式的网络负载对比图"></a>图 1. 轮询和 WebSocket 实现方式的网络负载对比图</h5><p><img src="/uploads/2015/01/image002.jpg" alt="图 1. 轮询和 WebSocket 实现方式的网络负载对比图"><br>通过这张图可以清楚的看出，在流量和负载增大的情况下，WebSocket 方案相比传统的 Ajax 轮询方案有极大的性能优势。这也是为什么我们认为 WebSocket 是未来实时 Web 应用的首选方案的原因。</p>
<hr>
<h2 id="WebSocket-规范"><a href="#WebSocket-规范" class="headerlink" title="WebSocket 规范"></a>WebSocket 规范</h2><p>WebSocket 协议本质上是一个基于 TCP 的协议。为了建立一个 WebSocket 连接，客户端浏览器首先要向服务器发起一个 HTTP 请求，这个请求和通常的 HTTP 请求不同，包含了一些附加头信息，其中附加头信息<strong>”Upgrade: WebSocket”</strong>表明这是一个申请协议升级的 HTTP 请求，服务器端解析这些附加的头信息然后产生应答信息返回给客户端，客户端和服务器端的 WebSocket 连接就建立起来了，双方就可以通过这个连接通道自由的传递信息，并且这个连接会持续存在直到客户端或者服务器端的某一方主动的关闭连接。<br>下面我们来详细介绍一下 WebSocket 规范，由于这个规范目前还是处于草案阶段，版本的变化比较快，我们选择 <strong>draft-hixie-thewebsocketprotocol-76</strong>版本来描述 WebSocket 协议。因为这个版本目前在一些主流的浏览器上比如 Chrome,、FireFox、Opera 上都得到比较好的支持，您如果参照的是新一些的版本话，内容可能会略有差别。<br>一个典型的 WebSocket 发起请求和得到响应的例子看起来如下：</p>
<h5 id="清单-1-WebSocket-握手协议"><a href="#清单-1-WebSocket-握手协议" class="headerlink" title="清单 1. WebSocket 握手协议"></a>清单 1. WebSocket 握手协议</h5><p><strong>客户端到服务端：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /demo HTTP/1.1 </span><br><span class="line">Host: example.com </span><br><span class="line">Connection: Upgrade </span><br><span class="line">Sec-WebSocket-Key2: 12998 5 Y3 1 .P00 </span><br><span class="line">Upgrade: WebSocket </span><br><span class="line">Sec-WebSocket-Key1: 4@1 46546xW%0l 1 5 </span><br><span class="line">Origin: http://example.com </span><br><span class="line">[8-byte security key]</span><br></pre></td></tr></table></figure></p>
<p><strong>服务端到客户端：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 101 WebSocket Protocol Handshake </span><br><span class="line">Upgrade: WebSocket </span><br><span class="line">Connection: Upgrade </span><br><span class="line">WebSocket-Origin: http://example.com </span><br><span class="line">WebSocket-Location: ws://example.com/demo </span><br><span class="line">[16-byte hash response]</span><br></pre></td></tr></table></figure></p>
<p>这些请求和通常的 HTTP 请求很相似，但是其中有些内容是和 WebSocket 协议密切相关的。我们需要简单介绍一下这些请求和应答信息，”Upgrade:WebSocket”表示这是一个特殊的 HTTP 请求，请求的目的就是要将客户端和服务器端的通讯协议从 HTTP 协议升级到 WebSocket 协议。从客户端到服务器端请求的信息里包含有”Sec-WebSocket-Key1”、“Sec-WebSocket-Key2”和”[8-byte securitykey]”这样的头信息。这是客户端浏览器需要向服务器端提供的握手信息，服务器端解析这些头信息，并在握手的过程中依据这些信息生成一个 16 位的安全密钥并返回给客户端，以表明服务器端获取了客户端的请求，同意创建 WebSocket 连接。一旦连接建立，客户端和服务器端就可以通过这个通道双向传输数据了。<br>在实际的开发过程中，为了使用 WebSocket 接口构建 Web 应用，我们首先需要构建一个实现了 WebSocket 规范的服务器，服务器端的实现不受平台和开发语言的限制，只需要遵从 WebSocket 规范即可，目前已经出现了一些比较成熟的 WebSocket 服务器端实现，比如：</p>
<ul>
<li>Kaazing WebSocket Gateway —  一个 Java 实现的 WebSocket Server</li>
<li>mod_pywebsocket — 一个 Python 实现的 WebSocket Server</li>
<li>Netty —一个 Java 实现的网络框架其中包括了对 WebSocket 的支持</li>
<li>node.js —一个 Server 端的 JavaScript 框架提供了对 WebSocket 的支持<br>如果以上的 WebSocket 服务端实现还不能满足您的业务需求的话，开发人员完全可以根据 WebSocket 规范自己实现一个服务器。在“WebSocket 实战”这一节，我们将使用 Microsoft .NET 平台上的 C# 语言来打造一个简单的 WebSocket 服务器，继而构建一个简单的实时聊天系统。</li>
</ul>
<hr>
<h2 id="WebSocket-JavaScript-接口"><a href="#WebSocket-JavaScript-接口" class="headerlink" title="WebSocket JavaScript 接口"></a>WebSocket JavaScript 接口</h2><p>上一节介绍了 WebSocket 规范，其中主要介绍了 WebSocket 的握手协议。握手协议通常是我们在构建 WebSocket 服务器端的实现和提供浏览器的 WebSocket 支持时需要考虑的问题，而针对 Web 开发人员的 WebSocket JavaScript 客户端接口是非常简单的，以下是 WebSocket JavaScript 接口的定义：</p>
<h5 id="清单-2-WebSocket-JavaScript-定义"><a href="#清单-2-WebSocket-JavaScript-定义" class="headerlink" title="清单 2. WebSocket JavaScript 定义"></a>清单 2. WebSocket JavaScript 定义</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[Constructor(in DOMString url, in optional DOMString protocol)] </span><br><span class="line">interface WebSocket &#123; </span><br><span class="line">  readonly attribute DOMString URL; </span><br><span class="line">       // ready state </span><br><span class="line">  const unsigned short CONNECTING = 0; </span><br><span class="line">  const unsigned short OPEN = 1; </span><br><span class="line">  const unsigned short CLOSED = 2; </span><br><span class="line">  readonly attribute unsigned short readyState; </span><br><span class="line">  readonly attribute unsigned long bufferedAmount; </span><br><span class="line">  //networking </span><br><span class="line">  attribute Function onopen; </span><br><span class="line">  attribute Function onmessage; </span><br><span class="line">  attribute Function onclose; </span><br><span class="line">  boolean send(in DOMString data); </span><br><span class="line">  void close(); </span><br><span class="line">&#125;; </span><br><span class="line">WebSocket implements EventTarget;</span><br></pre></td></tr></table></figure>
<p>其中 URL 属性代表 WebSocket 服务器的网络地址，协议通常是”ws”,send 方法就是发送数据到服务器端，close 方法就是关闭连接。除了这些方法，还有一些很重要的事件：onopen，onmessage，onerror 以及 onclose。我们借用 <strong>Nettuts</strong> 网站上的一张图来形象的展示一下 WebSocket 接口：</p>
<h5 id="图-2-WebSocket-JavaScript-接口"><a href="#图-2-WebSocket-JavaScript-接口" class="headerlink" title="图 2. WebSocket JavaScript 接口"></a>图 2. WebSocket JavaScript 接口</h5><p><img src="/uploads/2015/01/image003.gif" alt="图 2. WebSocket JavaScript 接口"><br>下面是一段简单的 JavaScript 代码展示了怎样建立 WebSocket 连接和获取数据：</p>
<h5 id="清单-3-建立-WebSocket-连接的实例-JavaScript-代码"><a href="#清单-3-建立-WebSocket-连接的实例-JavaScript-代码" class="headerlink" title="清单 3. 建立 WebSocket 连接的实例 JavaScript 代码"></a>清单 3. 建立 WebSocket 连接的实例 JavaScript 代码</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span>  wsServer = <span class="string">'ws://localhost:8888/Demo'</span>; </span><br><span class="line"><span class="keyword">var</span>  websocket = <span class="keyword">new</span> WebSocket(wsServer); </span><br><span class="line">websocket.onopen = <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123; onOpen(evt) &#125;; </span><br><span class="line">websocket.onclose = <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123; onClose(evt) &#125;; </span><br><span class="line">websocket.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123; onMessage(evt) &#125;; </span><br><span class="line">websocket.onerror = <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123; onError(evt) &#125;; </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onOpen</span>(<span class="params">evt</span>) </span>&#123; </span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Connected to WebSocket server."</span>); </span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onClose</span>(<span class="params">evt</span>) </span>&#123; </span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Disconnected"</span>); </span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onMessage</span>(<span class="params">evt</span>) </span>&#123; </span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Retrieved data from server: '</span> + evt.data); </span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onError</span>(<span class="params">evt</span>) </span>&#123; </span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Error occured: '</span> + evt.data); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="浏览器支持"><a href="#浏览器支持" class="headerlink" title="浏览器支持"></a>浏览器支持</h2><p>  下面是主流浏览器对 HTML5 WebSocket 的支持情况：</p>
<table summary="浏览器支持"><tr>浏览器支持情况</tr><tbody xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><tr><br><td>Chrome<br></td><br><td>Supported in version 4+<br></td></tr><tr><br><td>Firefox<br></td><br><td>Supported in version 4+<br></td></tr><tr><br><td>Internet Explorer<br></td><br><td>Supported in version 10+<br></td></tr><tr><br><td>Opera<br></td><br><td>Supported in version 10+<br></td></tr><tr><br><td>Safari<br></td><br><td>Supported in version 5+<br></td></tr></tbody></table>

<hr>
<h2 id="WebSocket-实战"><a href="#WebSocket-实战" class="headerlink" title="WebSocket 实战"></a>WebSocket 实战</h2><p>这一节里我们用一个案例来演示怎么使用 WebSocket 构建一个实时的 Web 应用。这是一个简单的实时多人聊天系统，包括客户端和服务端的实现。客户端通过浏览器向聊天服务器发起请求，服务器端解析客户端发出的握手请求并产生应答信息返回给客户端，从而在客户端和服务器之间建立连接通道。服务器支持广播功能，每个聊天用户发送的信息会实时的发送给所有的用户，当用户退出聊天室时，服务器端需要清理相应用户的连接信息，避免资源的泄漏。以下我们分别从服务器端和客户端来演示这个 Web 聊天系统的实现，在实现方式上我们采用了 C# 语言来实现 WebSocket 服务器，而客户端是一个运行在浏览器里的 HTML 文件。</p>
<h3 id="WebSocket-服务器端实现"><a href="#WebSocket-服务器端实现" class="headerlink" title="WebSocket 服务器端实现"></a>WebSocket 服务器端实现</h3><p>这个聊天服务器的实现和基于套接字的网络应用程序非常类似，首先是服务器端要启动一个套接字监听来自客户端的连接请求，关键的区别在于 WebSocket 服务器需要解析客户端的 WebSocket 握手信息，并根据 WebSocket 规范的要求产生相应的应答信息。一旦 WebSocket 连接通道建立以后，客户端和服务器端的交互就和普通的套接字网络应用程序是一样的了。所以在下面的关于 WebSocket 服务器端实现的描述中，我们主要阐述 WebSocket 服务器怎样处理 WebSocket 握手信息，至于 WebSocket 监听端口的建立，套接字信息流的读取和写入，都是一些常用的套接字编程的方式，我们就不多做解释了，您可以自行参阅本文的附件源代码文件。<br>在描述 WebSocket 规范时提到，一个典型的 WebSocket Upgrade 信息如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /demo HTTP/1.1 </span><br><span class="line">Host: example.com </span><br><span class="line">Connection: Upgrade </span><br><span class="line">Sec-WebSocket-Key2: 12998 5 Y3 1 .P00 </span><br><span class="line">Upgrade: WebSocket </span><br><span class="line">Sec-WebSocket-Key1: 4@1 46546xW%0l 1 5 </span><br><span class="line">Origin: http://example.com </span><br><span class="line">[8-byte security key]</span><br></pre></td></tr></table></figure></p>
<p>其中 Sec-WebSocket-Key1，Sec-WebSocket-Key2 和 [8-byte security key] 这几个头信息是 WebSocket 服务器用来生成应答信息的来源，依据 <strong>draft-hixie-thewebsocketprotocol-76</strong> 草案的定义，WebSocket 服务器基于以下的算法来产生正确的应答信息：</p>
<ol>
<li>逐个字符读取 Sec-WebSocket-Key1 头信息中的值，将数值型字符连接到一起放到一个临时字符串里，同时统计所有空格的数量；</li>
<li>将在第 1 步里生成的数字字符串转换成一个整型数字，然后除以第 1 步里统计出来的空格数量，将得到的浮点数转换成整数型；</li>
<li>将第 2 步里生成的整型值转换为符合网络传输的网络字节数组；</li>
<li>对 Sec-WebSocket-Key2 头信息同样进行第 1 到第 3 步的操作，得到另外一个网络字节数组；</li>
<li>将 [8-byte security key] 和在第 3，第 4 步里生成的网络字节数组合并成一个 16 字节的数组；</li>
<li>对第 5 步生成的字节数组使用 MD5 算法生成一个哈希值，这个哈希值就作为安全密钥返回给客户端，以表明服务器端获取了客户端的请求，同意创建 WebSocket 连接<br>至此，客户端和服务器的 WebSocket 握手就完成了，WebSocket 通道也建立起来了。下面首先介绍一下服务器端实现是如何根据用户传递的握手信息来生成网络字节数组的。.NET 平台提供了很方便的对字符串，数值以及数组操作的函数，所以生成字节数组的方法还是非常简单明了的，代码如下：</li>
</ol>
<h5 id="清单-4-生成网络字节数组的代码"><a href="#清单-4-生成网络字节数组的代码" class="headerlink" title="清单 4. 生成网络字节数组的代码"></a>清单 4. 生成网络字节数组的代码</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> byte[] 　 BuildServerPartialKey(<span class="built_in">string</span> clientKey) </span><br><span class="line">&#123; </span><br><span class="line">     <span class="built_in">string</span> partialServerKey = <span class="string">""</span>; </span><br><span class="line">    byte[] currentKey; </span><br><span class="line">    <span class="keyword">int</span> spacesNum = <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">char</span>[] keyChars = clientKey.ToCharArray(); </span><br><span class="line">    foreach (<span class="keyword">char</span> currentChar in keyChars) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">char</span>.IsDigit(currentChar)) partialServerKey += currentChar; </span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">char</span>.IsWhiteSpace(currentChar)) spacesNum++; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">try</span> </span><br><span class="line">    &#123; </span><br><span class="line">             currentKey = BitConverter.GetBytes((<span class="keyword">int</span>)(Int64.Parse(partialServerKey) </span><br><span class="line">/ spacesNum)); </span><br><span class="line">       <span class="keyword">if</span> (BitConverter.IsLittleEndian) Array.Reverse(currentKey); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">catch</span> </span><br><span class="line">    &#123; </span><br><span class="line">       <span class="keyword">if</span> (currentKey!= null) Array.Clear(currentKey, <span class="number">0</span>, currentKey.Length); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> currentKey; </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>得到网络字节数组以后，服务器端生成 16 位安全密钥的方法如下所示：</p>
<h5 id="清单-5-生成-16-位安全密钥的代码"><a href="#清单-5-生成-16-位安全密钥的代码" class="headerlink" title="清单 5. 生成 16 位安全密钥的代码"></a>清单 5. 生成 16 位安全密钥的代码</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> byte[] BuildCompleteServerKey(byte[] serverKey1, byte[] serverKey2, </span><br><span class="line">byte[] last8Bytes) </span><br><span class="line">&#123; </span><br><span class="line">    byte[] concatenatedKeys = <span class="keyword">new</span> byte[<span class="number">16</span>]; </span><br><span class="line">   Array.Copy(serverKey1, <span class="number">0</span>, concatenatedKeys, <span class="number">0</span>, <span class="number">4</span>); </span><br><span class="line">   Array.Copy(serverKey2, <span class="number">0</span>, concatenatedKeys, <span class="number">4</span>, <span class="number">4</span>); </span><br><span class="line">   Array.Copy(last8Bytes, <span class="number">0</span>, concatenatedKeys, <span class="number">8</span>, <span class="number">8</span>); </span><br><span class="line">   System.Security.Cryptography.MD5 MD5Service = </span><br><span class="line">System.Security.Cryptography.MD5.Create(); </span><br><span class="line">  <span class="keyword">return</span> MD5Service.ComputeHash(concatenatedKeys); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个实现是非常简单明了的，就是将生成的网络字节数组和客户端提交的头信息里的 [8-byte security key] 合并成一个 16 位字节数组并用 MD5 算法加密，然后将生成的安全密钥作为应答信息返回给客户端，双方的 WebSocekt 连接通道就建立起来了。实现了 WebSocket 握手信息的处理逻辑，一个具有基本功能的 WebSocket 服务器就完成了。整个 WebSocket 服务器由两个核心类构成，一个是 WebSocketServer，另外一个是 SocketConnection，出于篇幅的考虑，我们不介绍每个类的属性和方法了，文章的附件会给出详细的源代码，有兴趣的读者可以参考。<br>服务器刚启动时的画面如下：</p>
<h5 id="图-3-WebSocket-服务器刚启动的画面"><a href="#图-3-WebSocket-服务器刚启动的画面" class="headerlink" title="图 3. WebSocket 服务器刚启动的画面"></a>图 3. WebSocket 服务器刚启动的画面</h5><p><img src="/uploads/2015/01/image004.jpg" alt="图 3. WebSocket 服务器刚启动的画面"><br>客户端可以依据这个信息填写聊天服务器的连接地址，当有客户端连接到聊天服务器上时，服务器会打印出客户端和服务器的握手信息，每个客户的聊天信息也会显示在服务器的界面上，运行中的聊天服务器的界面如下：</p>
<h5 id="图-4-有客户端连接到-WebSocket-服务器的"><a href="#图-4-有客户端连接到-WebSocket-服务器的" class="headerlink" title="图 4. 有客户端连接到 WebSocket 服务器的"></a>图 4. 有客户端连接到 WebSocket 服务器的</h5><p><img src="/uploads/2015/01/image005.jpg" alt="图 4. 有客户端连接到 WebSocket 服务器的"><br>以上我们简单描述了实现一个 WebSocket 服务器的最基本的要素，下一节我们会描述客户端的实现。</p>
<h3 id="客户端实现"><a href="#客户端实现" class="headerlink" title="客户端实现"></a>客户端实现</h3><p>客户端的实现相对于服务器端的实现来说要简单得多了，我们只需要发挥想象去设计 HTML 用户界面，然后呼叫 WebSocket JavaScript 接口来和 WebSocket 服务器端来交互就可以了。当然别忘了使用一个支持 HTML5 和 WebSocket 的浏览器，在笔者写这篇文章的时候使用的浏览器是 Firefox。客户端的页面结构是非常简洁的，初始运行界面如下：</p>
<h5 id="图-5-聊天室客户端初始页面"><a href="#图-5-聊天室客户端初始页面" class="headerlink" title="图 5. 聊天室客户端初始页面"></a>图 5. 聊天室客户端初始页面</h5><p><img src="/uploads/2015/01/image006.jpg" alt="图 5. 聊天室客户端初始页面"><br>当页面初次加载的时候，首先会检测当前的浏览器是否支持 WebSocket 并给出相应的提示信息。用户按下连接按钮时，页面会初始化一个到聊天服务器的 WebSocekt 连接，初始化成功以后，页面会加载对应的 WebSocket 事件处理函数，客户端 JavaScript 代码如下所示：</p>
<h5 id="清单-6-初始化客户端-WebSocket-对象的代码"><a href="#清单-6-初始化客户端-WebSocket-对象的代码" class="headerlink" title="清单 6. 初始化客户端 WebSocket 对象的代码"></a>清单 6. 初始化客户端 WebSocket 对象的代码</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ToggleConnectionClicked</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (SocketCreated &amp;amp;&amp;amp; (ws.readyState == <span class="number">0</span> || ws.readyState == <span class="number">1</span>)) &#123;  </span><br><span class="line">               ws.close();</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               Log(<span class="string">"准备连接到聊天服务器 ..."</span>);</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                ws = </span><br><span class="line">                <span class="keyword">new</span> WebSocket(<span class="string">"ws://"</span> + <span class="built_in">document</span>.getElementById(<span class="string">"Connection"</span>).value);</span><br><span class="line">                 SocketCreated = <span class="literal">true</span>;</span><br><span class="line">               &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">                 Log(ex, <span class="string">"ERROR"</span>);</span><br><span class="line">                 <span class="keyword">return</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="built_in">document</span>.getElementById(<span class="string">"ToggleConnection"</span>).innerHTML = <span class="string">"断开"</span>;</span><br><span class="line">               ws.onopen = WSonOpen;</span><br><span class="line">               ws.onmessage = WSonMessage;</span><br><span class="line">               ws.onclose = WSonClose;</span><br><span class="line">               ws.onerror = WSonError;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">function</span> <span class="title">WSonOpen</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">           Log(<span class="string">"连接已经建立。"</span>, <span class="string">"OK"</span>);</span><br><span class="line">           $(<span class="string">"#SendDataContainer"</span>).show(<span class="string">"slow"</span>);</span><br><span class="line">       &#125;;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">function</span> <span class="title">WSonMessage</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">           Log(event.data);            </span><br><span class="line">       &#125;;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">function</span> <span class="title">WSonClose</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">           Log(<span class="string">"连接关闭。"</span>, <span class="string">"ERROR"</span>);</span><br><span class="line">           <span class="built_in">document</span>.getElementById(<span class="string">"ToggleConnection"</span>).innerHTML = <span class="string">"连接"</span>;</span><br><span class="line">           $(<span class="string">"#SendDataContainer"</span>).hide(<span class="string">"slow"</span>);</span><br><span class="line">       &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">function</span> <span class="title">WSonError</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">           Log(<span class="string">"WebSocket错误。"</span>, <span class="string">"ERROR"</span>);</span><br><span class="line">       &#125;;</span><br></pre></td></tr></table></figure>
<p>当用户按下发送按钮，客户端会调用WebSocket对象向服务器发送信息，并且这个消息会广播给所有的用户，实现代码如下所示：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SendDataClicked</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">document</span>.getElementById(<span class="string">"DataToSend"</span>).value != <span class="string">""</span>) &#123;</span><br><span class="line">                ws.send(<span class="built_in">document</span>.getElementById(<span class="string">"txtName"</span>).value + <span class="string">"说 :\""</span> + </span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">"DataToSend"</span>).value + <span class="string">"\""</span>);</span><br><span class="line">                <span class="built_in">document</span>.getElementById(<span class="string">"DataToSend"</span>).value = <span class="string">""</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure></p>
<p>如果有多个用户登录到聊天服务器，客户端页面的运行效果如下所示：</p>
<h5 id="图-6-聊天客户端运行页面"><a href="#图-6-聊天客户端运行页面" class="headerlink" title="图 6. 聊天客户端运行页面"></a>图 6. 聊天客户端运行页面</h5><p><img src="/uploads/2015/01/image007.jpg" alt="图 6. 聊天客户端运行页面"><br>至此我们已经完成了一个完整的 WebSocket 客户端实现，用户可以体验一下这个聊天室的简单和快捷，完全不用考虑页面的刷新和繁琐的 Ajax 调用，享受桌面程序的用户体验。WebSocket 的强大和易用可见一斑，您完全可以在这个基础上加入更多的功能，设计更加漂亮的用户界面，切身体验 WebSocket 的震撼力。完整的客户端代码请参阅附件提供的源代码。</p>
<hr>
<h2 id="WebSocket-的局限性"><a href="#WebSocket-的局限性" class="headerlink" title="WebSocket 的局限性"></a>WebSocket 的局限性</h2><p>WebSocket 的优点已经列举得很多了，但是作为一个正在演变中的 Web 规范，我们也要看到目前用 Websocket 构建应用程序的一些风险。首先，WebSocket 规范目前还处于草案阶段，也就是它的规范和 API 还是有变动的可能，另外的一个风险就是微软的 IE 作为占市场份额最大的浏览器，和其他的主流浏览器相比，对 HTML5 的支持是比较差的，这是我们在构建企业级的 Web 应用的时候必须要考虑的一个问题。</p>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文介绍了 HTML5 WebSocket 的横空出世以及它尝试解决的的问题，然后介绍了 WebSocket 规范和 WebSocket 接口，以及和传统的实时技术相比在性能上的优势，并且演示了怎样使用 WebSocket 构建一个实时的 Web 应用，最后我们介绍了当前的主流浏览器对 HTML5 的支持情况和 WebSocket 的局限性。不过，我们应该看到，尽管 HTML5 WebSocket 目前还有一些局限性，但是已经是大势所趋，微软也明确表达了未来对 HTML5 的支持，而且这些支持我们可以在 Windows 8 和 IE10 里看到，我们也在各种移动设备，平板电脑上看到了 HTML5 和 WebSocket 的身影。WebSocket 将会成为未来开发实时 Web 应用的生力军应该是毫无悬念的了，作为 Web 开发人员，关注 HTML5，关注 WebSocket 也应该提上日程了，否则我们在新一轮的软件革新的浪潮中只能做壁上观了。</p>
<p>下载示例代码：<a href="/uploads/2015/01/new-source.zip">new-source</a></p>
<p>转载自 <a href="http://www.ibm.com/developerworks/cn/web/1112_huangxa_websocket/" target="_blank" rel="noopener">http://www.ibm.com/developerworks/cn/web/1112_huangxa_websocket/</a></p>
<p>另祝各位元旦快乐！</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/01/01/使用 HTML5 WebSocket 构建实时 Web 应用/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2014/12/20/iptables 开启80端口/"><span>iptables 开启80端口</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2014/12/20/iptables 开启80端口/" rel="bookmark">
        <time class="entry-date published" datetime="2014-12-20T03:59:13.000Z">
          2014-12-20
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>经常使用CentOS的朋友，可能会遇到和我一样的问题。最近在Linux CentOS防火墙下安装配置 ORACLE<br>数据库的时候，总显示因为网络端口而导致的EM安装失败，遂打算先关闭一下CentOS防火墙。偶然看到CentOS防火墙的配置操作说明，感觉不错。执行”setup”命令启动文字模式配置实用程序,在”选择一种工具”中选择”防火墙配置”,然后选择”运行工具”按钮,出现CentOS防火墙配置界面,<br>将”安全级别”设为”禁用”,然后选择”确定”即可. </p>
<p>这样重启计算机后,CentOS防火墙默认已经开放了80和22端口 </p>
<p>简介：CentOS是Linux家族的一个分支。 </p>
<p>CentOS防火墙在虚拟机的CENTOS装好APACHE不能用,郁闷,解决方法如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/sbin/iptables -I INPUT -p tcp --dport 80 -j ACCEPT </span><br><span class="line">/sbin/iptables -I INPUT -p tcp --dport 22 -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>然后保存：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/rc.d/init.d/iptables save</span><br></pre></td></tr></table></figure></p>
<p>centos 5.3，5.4以上的版本需要用<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service iptables save</span><br></pre></td></tr></table></figure></p>
<p>来实现保存到配置文件。<br>这样重启计算机后,CentOS防火墙默认已经开放了80和22端口。 </p>
<p>这里应该也可以不重启计算机：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/iptables restart</span><br></pre></td></tr></table></figure></p>
<p>CentOS防火墙的关闭，关闭其服务即可：<br>查看CentOS防火墙信息：<code>/etc/init.d/iptables status</code></p>
<p>关闭CentOS防火墙服务：<code>/etc/init.d/iptables stop</code></p>
<p>永久关闭？不知道怎么个永久法：<code>chkconfig –level 35 iptables off</code></p>
<p>上面的内容是针对老版本的centos，下面的内容是基于新版本。 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -P INPUT DROP</span><br></pre></td></tr></table></figure>
<p>这样就拒绝所有访问 CentOS 5.3 本系统数据，除了 Chain RH-Firewall-1-INPUT (2 references) 的规则外 ， 呵呵。 </p>
<p>用命令配置了 iptables 一定还要 <code>service iptables save</code> 才能保存到配置文件。<br><code>cat /etc/sysconfig/iptables</code> 可以查看 防火墙 iptables 配置文件内容 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># Generated by iptables-save v1.3.5 on Sat Apr 14 07:51:07 2001 </span><br><span class="line">*filter </span><br><span class="line">:INPUT DROP [0:0] </span><br><span class="line">:FORWARD ACCEPT [0:0] </span><br><span class="line">:OUTPUT ACCEPT [1513:149055] </span><br><span class="line">:RH-Firewall-1-INPUT - [0:0] </span><br><span class="line">-A INPUT -j RH-Firewall-1-INPUT </span><br><span class="line">-A FORWARD -j RH-Firewall-1-INPUT </span><br><span class="line">-A RH-Firewall-1-INPUT -i lo -j ACCEPT </span><br><span class="line">-A RH-Firewall-1-INPUT -p icmp -m icmp --icmp-type any -j ACCEPT </span><br><span class="line">-A RH-Firewall-1-INPUT -p esp -j ACCEPT </span><br><span class="line">-A RH-Firewall-1-INPUT -p ah -j ACCEPT </span><br><span class="line">-A RH-Firewall-1-INPUT -d 224.0.0.251 -p udp -m udp --dport 5353 -j ACCEPT </span><br><span class="line">-A RH-Firewall-1-INPUT -p udp -m udp --dport 631 -j ACCEPT </span><br><span class="line">-A RH-Firewall-1-INPUT -p tcp -m tcp --dport 631 -j ACCEPT </span><br><span class="line">-A RH-Firewall-1-INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT </span><br><span class="line">-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT </span><br><span class="line">-A RH-Firewall-1-INPUT -j REJECT --reject-with icmp-host-prohibited </span><br><span class="line">COMMIT </span><br><span class="line"># Completed on Sat Apr 14 07:51:07 2001</span><br></pre></td></tr></table></figure>
<p>另外补充:<br>CentOS 防火墙配置 80端口<br>看了好几个页面内容都有错，下面是正确方法：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>/sbin/iptables -I INPUT -p tcp --dport 80 -j ACCEPT </span><br><span class="line"><span class="meta">#</span>/sbin/iptables -I INPUT -p tcp --dport 22 -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>然后保存：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>/etc/rc.d/init.d/iptables save</span><br></pre></td></tr></table></figure></p>
<p>再查看是否已经有了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@vcentos ~]# /etc/init.d/iptables status </span><br><span class="line">Table: filter </span><br><span class="line">Chain INPUT (policy ACCEPT) </span><br><span class="line">num target prot opt source destination </span><br><span class="line">1 ACCEPT udp -- 0.0.0.0/0 0.0.0.0/0 udp dpt:80 </span><br><span class="line">2 ACCEPT tcp -- 0.0.0.0/0 0.0.0.0/0 tcp dpt:80 </span><br><span class="line">3 RH-Firewall-1-INPUT all -- 0.0.0.0/0 0.0.0.0/0 </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT) </span><br><span class="line">num target prot opt source destination </span><br><span class="line">1 RH-Firewall-1-INPUT all -- 0.0.0.0/0 0.0.0.0/0</span><br></pre></td></tr></table></figure></p>
<ul>
<li>设置iptables为自动启动 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --level 2345 iptables on</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>可能因为大家使用的版本不一，所有使用方法也略有不同。 </p>
<p>如果需要远程管理mysql，则使用以下指令临时打开，用完后关闭 </p>
<ul>
<li><p>打开指令  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp -s xxx.xxx.xxx.xxx --dport 3306 -j ACCEPT</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭指令  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -D INPUT -p tcp -s xxx.xxx.xxx.xxx --dport 3306 -j ACCEPT</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>转载自 <a href="http://www.blogjava.net/Alpha/archive/2012/09/17/387950.html" target="_blank" rel="noopener">http://www.blogjava.net/Alpha/archive/2012/09/17/387950.html</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/VPS-技术/">VPS 技术</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2014/12/20/iptables 开启80端口/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2014/12/16/PHP 快速读取大文件/"><span>PHP 快速读取大文件</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2014/12/16/PHP 快速读取大文件/" rel="bookmark">
        <time class="entry-date published" datetime="2014-12-16T05:57:14.000Z">
          2014-12-16
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>最近想分析一下iis的日志，由于日志文件800M等大文件，所以怎样使用PHP快速读取成了问题！首先排除了file，因为加载太慢,内存溢出！<br>后来考虑用指针fgets，但是读取还是有点慢，如果只读取1000条以内的数据还是可以接受的<br>最后试用了PHP的stream_get_line函数 ，读取快速，读取50万条数据大文件，大概需要20秒左右的时间！例子代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$fp = fopen(<span class="string">'./iis.log'</span>, <span class="string">'r'</span>); <span class="comment">//文件</span></span><br><span class="line"><span class="keyword">while</span> (!feof($fp)) &#123;</span><br><span class="line">	<span class="comment">//for($j=1;$j&lt;=1000;$j++) &#123;		 //读取下面的1000行并存储到数组中</span></span><br><span class="line">	 $logarray[] = stream_get_line($fp, <span class="number">65535</span>, <span class="string">"\n"</span>);</span><br><span class="line">		<span class="comment">// break;</span></span><br><span class="line">	 <span class="comment">// &#125;</span></span><br><span class="line"> </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>转载自 <a href="http://www.wenlingnet.com/index.php/172/" target="_blank" rel="noopener">http://www.wenlingnet.com/index.php/172/</a></p>
<p>P.S. 说实话这个是挺快的，就是没法指定起始位置<br><a href="/uploads/2014/12/QQ图片20141216215656.png"><img src="/uploads/2014/12/QQ图片20141216215656-1024x551.png" alt="QQ图片20141216215656"></a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2014/12/16/PHP 快速读取大文件/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>




<nav class="pagination">
  
  <a href="/page/9/" class="pagination-prev">上一页</a>
  
  
  <a href="/page/11/" class="pagination-next">下一页</a>
  
</nav>
    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2019 403 Forbidden
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>