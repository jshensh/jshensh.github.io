<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 7 页 | 博客</title>

  
  <meta name="author" content="403 Forbidden">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="博客"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">博客</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/categories">分类</a></li>
      
        <li><a href="/about.html">关于</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    
  <article>

  
    
    <h3 class="article-title"><a href="/2015/10/08/Linux下MySQL的root密码忘记解决方法/"><span>Linux下MySQL的root密码忘记解决方法</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/10/08/Linux下MySQL的root密码忘记解决方法/" rel="bookmark">
        <time class="entry-date published" datetime="2015-10-08T08:03:05.000Z">
          2015-10-08
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>验证环境：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# rpm -qa | grep mysql</span><br><span class="line">mysql-5.1.71-1.el6.i686</span><br><span class="line">mysql-server-5.1.71-1.el6.i686</span><br><span class="line">mysql-libs-5.1.71-1.el6.i686</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# lsb_release -a</span><br><span class="line">LSB Version:    :core-4.0-ia32:core-4.0-noarch:graphics-4.0-ia32:graphics-4.0-noarch:printing-4.0-ia32:printing-4.0-noarch</span><br><span class="line">Distributor ID: CentOS</span><br><span class="line">Description:    CentOS Linux release 6.0 (Final)</span><br><span class="line">Release:        6.0</span><br><span class="line">Codename:      Final</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# uname -r</span><br><span class="line">2.6.32-71.el6.i686</span><br></pre></td></tr></table></figure></p>
<p>1．首先确认服务器出于安全的状态，也就是没有人能够任意地连接MySQL数据库。<br>因为在重新设置MySQL的root密码的期间，MySQL数据库完全出于没有密码保护的状态下，其他的用户也可以任意地登录和修改MySQL的信息。可以采用将MySQL对外的端口封闭，并且停止Apache以及所有的用户进程的方法实现服务器的准安全状态。最安全的状态是到服务器的Console上面操作，并且拔掉网线。</p>
<p>2．修改MySQL的登录设置：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br></pre></td></tr></table></figure></p>
<p>在[mysqld]的段中加上一句：skip-grant-tables<br>例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[mysqld] </span><br><span class="line">datadir=/var/lib/mysql </span><br><span class="line">socket=/var/lib/mysql/mysql.sock </span><br><span class="line">skip-grant-tables</span><br></pre></td></tr></table></figure></p>
<p>保存并且退出vi。</p>
<p>3．重新启动mysqld<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># /etc/init.d/mysqld restart </span><br><span class="line">Stopping MySQL: [ OK ] </span><br><span class="line">Starting MySQL: [ OK ]</span><br></pre></td></tr></table></figure></p>
<p>4．登录并修改MySQL的root密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mysql</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \\g.</span><br><span class="line">Your MySQL connection id is 3</span><br><span class="line">Server version: 5.1.71 Source distribution</span><br><span class="line">Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line">Type &apos;help;&apos; or &apos;\\h&apos; for help. Type &apos;\\c&apos; to clear the current input statement.</span><br><span class="line">mysql&gt;UPDATE mysql.user SET Password = password (&quot;new-password&quot;) WHERE User = &apos;root&apos;;</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 3  Changed: 3  Warnings: 0</span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure></p>
<p>5．将MySQL的登录设置修改回来<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br></pre></td></tr></table></figure></p>
<p>将刚才在[mysqld]的段中加上的skip-grant-tables删除,保存并且退出vi；</p>
<p>6．再次重新启动mysqld<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># /etc/init.d/mysqld restart </span><br><span class="line">Stopping MySQL: [ OK ] </span><br><span class="line">Starting MySQL: [ OK ]</span><br></pre></td></tr></table></figure></p>
<p>7、使用新的密码登录，正常登录，搞定！</p>
<p>转载自 <a href="http://www.linuxidc.com/Linux/2013-07/87069.htm" target="_blank" rel="noopener">http://www.linuxidc.com/Linux/2013-07/87069.htm</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/VPS-技术/">VPS 技术</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/10/08/Linux下MySQL的root密码忘记解决方法/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/10/07/重写了下博客的播放器/"><span>重写了下博客的播放器</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/10/07/重写了下博客的播放器/" rel="bookmark">
        <time class="entry-date published" datetime="2015-10-07T02:03:16.000Z">
          2015-10-07
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>国庆无聊，对博客的播放器做了比较大幅度的修改，总结一下现有以下改进:</p>
<ol>
<li>添加了”自动播放”复选框，可以由用户自主决定是否需要播放背景音乐(其实歌都不错的。。)</li>
</ol>
<ol start="2">
<li>使用 node.js 重写了多标签的背景音乐控制器，主要是为了避免产生当用户打开多个标签后背景音乐同时播放的问题</li>
</ol>
<p>抱着开源共享的想法，现在这里共享一下控制器源码。播放器的就不特地写了，都是前端的东西，右键”查看源代码”即可。如果有什么 bug，希望各位提出，谢谢各位。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">'express'</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>).Server(app);</span><br><span class="line"><span class="keyword">var</span> io = <span class="built_in">require</span>(<span class="string">'socket.io'</span>)(http);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">	res.send(<span class="string">'&lt;h1&gt;Welcome Realtime Server&lt;/h1&gt;'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">count</span>(<span class="params">o</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> t = <span class="keyword">typeof</span> o;</span><br><span class="line">    <span class="keyword">if</span> (t == <span class="string">'string'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> o.length;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t == <span class="string">'object'</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> n = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> o) &#123;</span><br><span class="line">                n++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="built_in">Date</span>.prototype.Format = <span class="function"><span class="keyword">function</span> (<span class="params">fmt</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> o = &#123;</span><br><span class="line">        <span class="string">"M+"</span>: <span class="keyword">this</span>.getMonth() + <span class="number">1</span>,</span><br><span class="line">        <span class="string">"d+"</span>: <span class="keyword">this</span>.getDate(),</span><br><span class="line">        <span class="string">"h+"</span>: <span class="keyword">this</span>.getHours(),</span><br><span class="line">        <span class="string">"m+"</span>: <span class="keyword">this</span>.getMinutes(),</span><br><span class="line">        <span class="string">"s+"</span>: <span class="keyword">this</span>.getSeconds(),</span><br><span class="line">        <span class="string">"q+"</span>: <span class="built_in">Math</span>.floor((<span class="keyword">this</span>.getMonth() + <span class="number">3</span>) / <span class="number">3</span>),</span><br><span class="line">        <span class="string">"S"</span>: <span class="keyword">this</span>.getMilliseconds()</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/(y+)/</span>.test(fmt)) fmt = fmt.replace(<span class="built_in">RegExp</span>.$<span class="number">1</span>, (<span class="keyword">this</span>.getFullYear() + <span class="string">""</span>).substr(<span class="number">4</span> - <span class="built_in">RegExp</span>.$<span class="number">1.</span>length));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> k <span class="keyword">in</span> o)</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"("</span> + k + <span class="string">")"</span>).test(fmt)) fmt = fmt.replace(<span class="built_in">RegExp</span>.$<span class="number">1</span>, (<span class="built_in">RegExp</span>.$<span class="number">1.</span>length == <span class="number">1</span>) ? (o[k]) : ((<span class="string">"00"</span> + o[k]).substr((<span class="string">""</span> + o[k]).length)));</span><br><span class="line">    <span class="keyword">return</span> fmt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dump_log=<span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">	<span class="comment">//console.log("\033[40;33m"+new Date().Format("yyyy-MM-dd hh:mm:ss")+"\033[0m\n"+msg+"\nNow "+count(clients)+" user(s) online.");</span></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>().Format(<span class="string">"yyyy-MM-dd hh:mm:ss"</span>)+<span class="string">"\n"</span>+msg+<span class="string">"\nNow "</span>+count(clients)+<span class="string">" user(s) online."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> onlineCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> index=<span class="number">0</span>;</span><br><span class="line">global[<span class="string">'clients'</span>]=&#123;&#125;;</span><br><span class="line"></span><br><span class="line">io.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">socket</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	socket.on(<span class="string">'bindkey'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">str</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!str.match(<span class="regexp">/^[a-z0-9]&#123;64&#125;$/</span>)) &#123;</span><br><span class="line">			dump_log(<span class="string">"data: "</span>+str+<span class="string">"\nip: "</span>+socket.handshake.address);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		socket.bindkey = str;</span><br><span class="line">		socket.index = index;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">typeof</span> global[<span class="string">'clients'</span>][str]==<span class="string">"undefined"</span>) &#123;</span><br><span class="line">			global[<span class="string">'clients'</span>][str]=&#123;&#125;;</span><br><span class="line">			onlineCount++;</span><br><span class="line">		&#125;</span><br><span class="line">		global[<span class="string">'clients'</span>][str][index]=&#123;<span class="string">'playing'</span>:(count(global[<span class="string">'clients'</span>][str])==<span class="number">0</span>?<span class="number">1</span>:<span class="number">0</span>),<span class="string">'socket'</span>:socket,<span class="string">'ip'</span>:socket.handshake.address,<span class="string">'index'</span>:index&#125;;</span><br><span class="line">		socket.emit(<span class="string">"message"</span>,[<span class="number">0</span>,index,global[<span class="string">'clients'</span>][str][index][<span class="string">'playing'</span>]]);</span><br><span class="line">		dump_log(<span class="string">"bindkey: "</span>+str+<span class="string">", index: "</span>+index+<span class="string">", ip: "</span>+socket.handshake.address);</span><br><span class="line">		index++;</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	socket.on(<span class="string">'disconnect'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">delete</span> global[<span class="string">'clients'</span>][socket.bindkey][socket.index];</span><br><span class="line">		<span class="keyword">if</span> (count(global[<span class="string">'clients'</span>][socket.bindkey])!==<span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">var</span> ckey <span class="keyword">in</span> global[<span class="string">'clients'</span>][socket.bindkey]) &#123;</span><br><span class="line">				<span class="keyword">var</span> ready_play=global[<span class="string">'clients'</span>][socket.bindkey][ckey];</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			ready_play[<span class="string">'playing'</span>]=<span class="number">1</span>;</span><br><span class="line">			ready_play.socket.emit(<span class="string">"message"</span>,[<span class="number">1</span>,ready_play.socket.index,<span class="number">1</span>]);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">delete</span> global[<span class="string">'clients'</span>][socket.bindkey];</span><br><span class="line">			onlineCount--;</span><br><span class="line">		&#125;</span><br><span class="line">		dump_log(<span class="string">"bindkey: "</span>+socket.bindkey+<span class="string">", index: "</span>+socket.index+<span class="string">", ip: "</span>+socket.handshake.address+<span class="string">" offline."</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">  </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">http.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'listening on *:3000'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>Docker 项目地址: <a href="https://github.com/jshensh/audioController" target="_blank" rel="noopener">https://github.com/jshensh/audioController</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/10/07/重写了下博客的播放器/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/10/04/NodeJS中 package.json 解析/"><span>NodeJS中 package.json 解析</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/10/04/NodeJS中 package.json 解析/" rel="bookmark">
        <time class="entry-date published" datetime="2015-10-04T08:44:33.000Z">
          2015-10-04
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>package.json 中包含各种所需模块以及项目的配置信息（名称、版本、许可证等）meta 信息。<br><strong>包含可配置项</strong></p>
<ul>
<li>name 名称</li>
</ul>
<ul>
<li>应用描述 description</li>
</ul>
<ul>
<li>版本号 version</li>
</ul>
<ul>
<li>应用的配置项 config</li>
</ul>
<ul>
<li>作者 author</li>
</ul>
<ul>
<li>资源仓库地址 respository</li>
</ul>
<ul>
<li>授权方式 licenses</li>
</ul>
<ul>
<li>目录 directories</li>
</ul>
<ul>
<li>应用入口文件 main</li>
</ul>
<ul>
<li>命令行文件 bin</li>
</ul>
<ul>
<li>项目应用运行依赖模块 dependencies</li>
</ul>
<ul>
<li>项目应用开发环境依赖 devDependencies</li>
</ul>
<ul>
<li>运行引擎 engines</li>
</ul>
<ul>
<li>脚本 script</li>
</ul>
<h1 id="简单模式"><a href="#简单模式" class="headerlink" title="简单模式"></a>简单模式</h1><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">name: "myApp",</span><br><span class="line"></span><br><span class="line">version :"0.0.1"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="完整模式"><a href="#完整模式" class="headerlink" title="完整模式"></a>完整模式</h1><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="attr">"name"</span>: <span class="string">"myApp"</span>,</span><br><span class="line"><span class="attr">"version"</span>: <span class="string">"0.0.0"</span>,</span><br><span class="line"><span class="attr">"author"</span> : <span class="string">"simple"</span>,</span><br><span class="line"><span class="attr">"description"</span> : <span class="string">"Nodejs Package json介绍"</span>,</span><br><span class="line"><span class="attr">"keywords"</span> : <span class="string">"javascript, nodejs"</span>,</span><br><span class="line"><span class="attr">"respository"</span> : &#123;</span><br><span class="line"><span class="attr">"type"</span> :<span class="string">"git"</span>,</span><br><span class="line"><span class="attr">"url"</span> :<span class="string">"http://path/to/url"</span></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="attr">"bugs"</span> : &#123;</span><br><span class="line"><span class="attr">"url"</span> : <span class="string">"http://path/to/bug"</span>,</span><br><span class="line"><span class="attr">"email"</span> : <span class="string">"bug@example.com"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"contributors"</span> : [</span><br><span class="line"></span><br><span class="line">&#123;<span class="attr">"name"</span> : <span class="string">"zhangsan"</span>, <span class="attr">"email"</span> : <span class="string">"zhangsan@example.com"</span></span><br><span class="line"></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="string">"license"</span> : <span class="string">"MIT"</span>,</span><br><span class="line"><span class="attr">"engines"</span> : &#123; <span class="attr">"node"</span> : <span class="string">"0.10.x"</span>&#125;,</span><br><span class="line"><span class="attr">"script"</span> : &#123;</span><br><span class="line"><span class="attr">"start"</span> : <span class="string">"node index.js"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"private"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"scripts"</span>: &#123;</span><br><span class="line"><span class="attr">"start"</span>: <span class="string">"node ./bin/www"</span></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="attr">"dependencies"</span>: &#123;</span><br><span class="line"><span class="attr">"express"</span>: <span class="string">"~4.9.0"</span>,</span><br><span class="line"><span class="attr">"body-parser"</span>: <span class="string">"~1.8.1"</span>,</span><br><span class="line"><span class="attr">"cookie-parser"</span>: <span class="string">"~1.3.3"</span>,</span><br><span class="line"><span class="attr">"morgan"</span>: <span class="string">"~1.3.0"</span>,</span><br><span class="line"><span class="attr">"serve-favicon"</span>: <span class="string">"~2.1.3"</span>,</span><br><span class="line"><span class="attr">"debug"</span>: <span class="string">"~2.0.0"</span>,</span><br><span class="line"><span class="attr">"jade"</span>: <span class="string">"~1.6.0"</span></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line"><span class="attr">"bower"</span> : <span class="string">"~1.2.8"</span>,</span><br><span class="line"><span class="attr">"grunt"</span> : <span class="string">"~0.4.1"</span>,</span><br><span class="line"><span class="attr">"grunt-contrib-concat"</span> : <span class="string">"~0.3.0"</span>,</span><br><span class="line"><span class="attr">"grunt-contrib-jshint"</span> : <span class="string">"~0.7.2"</span>,</span><br><span class="line"><span class="attr">"grunt-contrib-uglify"</span> : <span class="string">"~0.2.7"</span>,</span><br><span class="line"><span class="attr">"grunt-contrib-clean"</span> : <span class="string">"~0.5.0"</span>,</span><br><span class="line"><span class="attr">"browserify"</span> : <span class="string">"2.36.1"</span>,</span><br><span class="line"><span class="attr">"grunt-browserify"</span> : <span class="string">"~1.3.0"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>1.scripts</strong><br>运行指定脚本命令。</p>
<p><strong>2.</strong><br><strong>npm install express –save</strong><br><strong>npm install express –save-dev</strong><br><strong>上面代码表示单独安装express模块，</strong><br>–save参数表示将该模块写入dependencies属性，<br>–save-dev表示将该模块写入devDependencies属性。</p>
<p><strong>3.关于指定版本号</strong><br>_（1）波浪号~（tilde）+指定版本：比如~1.2.2，表示安装1.2.x的最新版本（不低于1.2.2），但是不安装1.3.x，也就是说安装时不改变大版本号和次要版本号。 _</p>
<p>转载自 <a href="http://www.cnphp6.com/archives/57964?utm_source=tuicool" target="_blank" rel="noopener">http://www.cnphp6.com/archives/57964?utm_source=tuicool</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/10/04/NodeJS中 package.json 解析/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/10/02/加上了“财经消息”小工具。。。但我感觉应该没人会看/"><span>加上了“财经消息”小工具。。。但我感觉应该没人会看</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/10/02/加上了“财经消息”小工具。。。但我感觉应该没人会看/" rel="bookmark">
        <time class="entry-date published" datetime="2015-10-01T19:02:32.000Z">
          2015-10-02
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>纯用来提升逼格。。。数据来源 <a href="http://www.jin10.com/" target="_blank" rel="noopener">http://www.jin10.com/</a><br>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/10/02/加上了“财经消息”小工具。。。但我感觉应该没人会看/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/09/29/使用Node.js+Socket.IO搭建WebSocket实时应用/"><span>使用Node.js+Socket.IO搭建WebSocket实时应用</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/09/29/使用Node.js+Socket.IO搭建WebSocket实时应用/" rel="bookmark">
        <time class="entry-date published" datetime="2015-09-29T08:02:31.000Z">
          2015-09-29
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>Web领域的实时推送技术，也被称作Realtime技术。这种技术要达到的目的是让用户不需要刷新浏览器就可以获得实时更新。它有着广泛的应用场景，比如在线聊天室、在线客服系统、评论系统、WebIM等。<br><a href="/uploads/2015/09/20140611173333_407.jpg"><img src="/uploads/2015/09/20140611173333_407.jpg" alt="20140611173333_407"></a></p>
<p><strong>WebSocket简介</strong><br>谈到Web实时推送，就不得不说WebSocket。在WebSocket出现之前，很多网站为了实现实时推送技术，通常采用的方案是轮询 (Polling)和Comet技术，Comet又可细分为两种实现方式，一种是长轮询机制，一种称为流技术，这两种方式实际上是对轮询技术的改进，这些 方案带来很明显的缺点，需要由浏览器对服务器发出HTTP request，大量消耗服务器带宽和资源。面对这种状况，HTML5定义了WebSocket协议，能更好的节省服务器资源和带宽并实现真正意义上的实 时推送。<br>WebSocket协议本质上是一个基于TCP的协议，它由通信协议和编程API组成，WebSocket能够在浏览器和服务器之间建立双向连接， 以基于事件的方式，赋予浏览器实时通信能力。既然是双向通信，就意味着服务器端和客户端可以同时发送并响应请求，而不再像HTTP的请求和响应。<br>为了建立一个WebSocket连接，客户端浏览器首先要向服务器发起一个HTTP请求，这个请求和通常的HTTP请求不同，包含了一些附加头信 息，其中附加头信息”Upgrade: WebSocket”表明这是一个申请协议升级的HTTP请求，服务器端解析这些附加的头信息然后产生应答信息返回给客户端，客户端和服务器端的 WebSocket连接就建立起来了，双方就可以通过这个连接通道自由的传递信息，并且这个连接会持续存在直到客户端或者服务器端的某一方主动的关闭连接。<br>一个典型WebSocket客户端请求头：<br><a href="/uploads/2015/09/20140611173334_763.jpg"><img src="/uploads/2015/09/20140611173334_763.jpg" alt="20140611173334_763"></a><br>前面讲到WebSocket是HTML5中新增的一种通信协议，这意味着一部分老版本浏览器（主要是IE10以下版本）并不具备这个功能，<a href="http://tongji.baidu.com/data/browser" target="_blank" rel="noopener">通过百度统计的公开数据显示</a>，IE8 目前仍以33%的市场份额占据榜首，好在chrome浏览器市场份额逐年上升，现在以超过26%的市场份额位居第二，同时微软前不久宣布停止对IE6的技 术支持并提示用户更新到新版本浏览器，这个曾经让无数前端工程师为之头疼的浏览器有望退出历史舞台，再加上几乎所有的智能手机浏览器都支持HTML5，所 以使得WebSocket的实战意义大增，但是无论如何，我们实际的项目中，仍然要考虑低版本浏览器的兼容方案：在支持WebSocket的浏览器中采用 新技术，而在不支持WebSocket的浏览器里启用Comet来接收发送消息。</p>
<p><strong>WebSocket实战</strong><br>本文将以多人在线聊天应用作为实例场景，我们先来确定这个聊天应用的基本需求。</p>
<p><strong>需求分析</strong><br>1、兼容不支持WebSocket的低版本浏览器。<br>2、允许客户端有相同的用户名。<br>3、进入聊天室后可以看到当前在线的用户和在线人数。<br>4、用户上线或退出，所有在线的客户端应该实时更新。<br>5、用户发送消息，所有客户端实时收取。<br>在实际的开发过程中，为了使用WebSocket接口构建Web应用，我们首先需要构建一个实现了 WebSocket规范的服务端，服务端的实现不受平台和开发语言的限制，只需要遵从WebSocket规范即可，目前已经出现了一些比较成熟的 WebSocket服务端实现，比如本文使用的Node.js+Socket.IO。为什么选用这个方案呢？先来简单介绍下他们两。</p>
<p><strong>Node.js</strong><br>Node.js采用C++语言编写而成，它不是Javascript应用，而是一个Javascript的运行环境，据Node.js创始人 Ryan Dahl回忆，他最初希望采用Ruby来写Node.js，但是后来发现Ruby虚拟机的性能不能满足他的要求，后来他尝试采用V8引擎，所以选择了 C++语言。<br>Node.js支持的系统包括*nux、Windows，这意味着程序员可以编写系统级或者服务器端的Javascript代码，交给 Node.js来解释执行。Node.js的Web开发框架Express，可以帮助程序员快速建立web站点，从2009年诞生至今，Node.js的 成长的速度有目共睹，其发展前景获得了技术社区的充分肯定。</p>
<p><strong>Socket.IO</strong><br>Socket.IO是一个开源的WebSocket库，它通过Node.js实现WebSocket服务端，同时也提供客户端JS库。Socket.IO支持以事件为基础的实时双向通讯，它可以工作在任何平台、浏览器或移动设备。<br>Socket.IO支持4种协议：WebSocket、htmlfile、xhr-polling、jsonp-polling，它会自动根据浏览 器选择适合的通讯方式，从而让开发者可以聚焦到功能的实现而不是平台的兼容性，同时Socket.IO具有不错的稳定性和性能。</p>
<p><strong>编码实现</strong><br>本文一开始的的插图就是效果演示图：可以<a href="http://demo.plhwin.com/chat/" target="_blank" rel="noopener">点击这里</a>查看在线演示，整个开发过程非常简单，下面简单记录了开发步骤：</p>
<p><strong>安装Node.js</strong><br>根据自己的操作系统，去Node.js官网下载安装即可。如果成功安装。在命令行输入node -v和npm -v应该能看到相应的版本号。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">node -v </span><br><span class="line">v0.10.26 </span><br><span class="line">npm -v </span><br><span class="line">1.4.6</span><br></pre></td></tr></table></figure></p>
<p><strong>搭建WebSocket服务端</strong><br>这个环节我们尽可能的考虑真实生产环境，把WebSocket后端服务搭建成一个线上可以用域名访问的服务，如果你是在本地开发环境，可以换成本地ip地址，或者使用一个虚拟域名指向本地ip。<br>先进入到你的工作目录，比如 /workspace/wwwroot/plhwin/realtime.plhwin.com，新建一个名为 package.json的文件，内容如下：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"realtime-server"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"0.0.1"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">"my first realtime server"</span>,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来使用npm命令安装express和socket.io<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install --save express</span><br><span class="line">npm install --save socket.io</span><br></pre></td></tr></table></figure></p>
<p>安装成功后，应该可以看到工作目录下生成了一个名为node_modules的文件夹，里面分别是express和socket.io，接下来可以开始编写服务端的代码了，新建一个文件：index.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">'express'</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>).Server(app);</span><br><span class="line"><span class="keyword">var</span> io = <span class="built_in">require</span>(<span class="string">'socket.io'</span>)(http);</span><br><span class="line"> </span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    res.send(<span class="string">'&lt;h1&gt;Welcome Realtime Server&lt;/h1&gt;'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">http.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'listening on *:3000'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>命令行运行node index.js，如果一切顺利，你应该会看到返回的listening on *:3000字样，这说明服务已经成功搭建了。此时浏览器中打开<a href="http://localhost:3000应该可以看到正常的欢迎页面。" target="_blank" rel="noopener">http://localhost:3000应该可以看到正常的欢迎页面。</a><br>如果你想要让服务运行在线上服务器，并且可以通过域名访问的话，可以使用Nginx做代理，在nginx.conf中添加如下配置，然后将域名（比如：realtime.plhwin.com）解析到服务器IP即可。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server</span><br><span class="line"> &#123;</span><br><span class="line">   listen       80;</span><br><span class="line">   server_name  realtime.plhwin.com;</span><br><span class="line">   location / &#123;</span><br><span class="line">     proxy_pass http://127.0.0.1:3000;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>完成以上步骤，<a href="http://realtime.plhwin.com:3000的后端服务就正常搭建了。" target="_blank" rel="noopener">http://realtime.plhwin.com:3000的后端服务就正常搭建了。</a><br><a href="/uploads/2015/09/20140611173334_655.jpg"><img src="/uploads/2015/09/20140611173334_655.jpg" alt="20140611173334_655"></a></p>
<p><strong>服务端代码实现</strong><br>前面讲到的index.js运行在服务端，之前的代码只是一个简单的WebServer欢迎内容，让我们把WebSocket服务端完整的实现代码加入进去，整个服务端就可以处理客户端的请求了。完整的index.js代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"format-detection"</span> <span class="attr">content</span>=<span class="string">"telephone=no"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"format-detection"</span> <span class="attr">content</span>=<span class="string">"email=no"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0"</span> <span class="attr">name</span>=<span class="string">"viewport"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>多人聊天室<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"./style.css"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--[if lt IE 8]&gt;&lt;script src="./json3.min.js"&gt;&lt;/script&gt;&lt;![endif]--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://realtime.plhwin.com:3000/socket.io/socket.io.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"loginbox"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"width:260px;margin:200px auto;"</span>&gt;</span></span><br><span class="line">                请先输入你在聊天室的昵称</span><br><span class="line">                <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">style</span>=<span class="string">"width:180px;"</span> <span class="attr">placeholder</span>=<span class="string">"请输入用户名"</span> <span class="attr">id</span>=<span class="string">"username"</span> <span class="attr">name</span>=<span class="string">"username"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">style</span>=<span class="string">"width:50px;"</span> <span class="attr">value</span>=<span class="string">"提交"</span> <span class="attr">onclick</span>=<span class="string">"CHAT.usernameSubmit();"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"chatbox"</span> <span class="attr">style</span>=<span class="string">"display:none;"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"background:#3d3d3d;height: 28px; width: 100%;font-size:12px;"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"line-height: 28px;color:#fff;"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"text-align:left;margin-left:10px;"</span>&gt;</span>Websocket多人聊天室<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"float:right; margin-right:10px;"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"showusername"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span> |</span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">onclick</span>=<span class="string">"CHAT.logout()"</span> <span class="attr">style</span>=<span class="string">"color:#fff;"</span>&gt;</span>退出<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"doc"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"chat"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"message"</span> <span class="attr">class</span>=<span class="string">"message"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"onlinecount"</span> <span class="attr">style</span>=<span class="string">"background:#EFEFF4; font-size:12px; margin-top:10px; margin-left:10px; color:#666;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-box"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">maxlength</span>=<span class="string">"140"</span> <span class="attr">placeholder</span>=<span class="string">"请输入聊天内容，按Ctrl提交"</span> <span class="attr">id</span>=<span class="string">"content"</span> <span class="attr">name</span>=<span class="string">"content"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"action"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"mjr_send"</span> <span class="attr">onclick</span>=<span class="string">"CHAT.submit();"</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"./client.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>上面的html内容本身没有什么好说的，我们主要看看里面的4个文件请求：<br>1、realtime.plhwin.com:3000/socket.io/socket.io.js<br>2、style.css<br>3、json3.min.js<br>4、client.js</p>
<p>第1个JS是Socket.IO提供的客户端JS文件，在前面安装服务端的步骤中，当npm安装完socket.io并搭建起WebServer后，这个JS文件就可以正常访问了。<br>第2个style.css文件没什么好说的，就是样式文件而已。<br>第3个JS只在IE8以下版本的IE浏览器中加载，目的是让这些低版本的IE浏览器也能处理json，这是一个开源的JS，详见：<a href="http://bestiejs.github.io/json3/" target="_blank" rel="noopener">http://bestiejs.github.io/json3/</a><br>第4个client.js是完整的客户端的业务逻辑实现代码，它的内容如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> d = <span class="built_in">document</span>,</span><br><span class="line">    w = <span class="built_in">window</span>,</span><br><span class="line">    p = <span class="built_in">parseInt</span>,</span><br><span class="line">    dd = d.documentElement,</span><br><span class="line">    db = d.body,</span><br><span class="line">    dc = d.compatMode == <span class="string">'CSS1Compat'</span>,</span><br><span class="line">    dx = dc ? dd: db,</span><br><span class="line">    ec = <span class="built_in">encodeURIComponent</span>;</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">    w.CHAT = &#123;</span><br><span class="line">        msgObj:d.getElementById(<span class="string">"message"</span>),</span><br><span class="line">        screenheight:w.innerHeight ? w.innerHeight : dx.clientHeight,</span><br><span class="line">        username:<span class="literal">null</span>,</span><br><span class="line">        userid:<span class="literal">null</span>,</span><br><span class="line">        socket:<span class="literal">null</span>,</span><br><span class="line">        <span class="comment">//让浏览器滚动条保持在最低部</span></span><br><span class="line">        scrollToBottom:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            w.scrollTo(<span class="number">0</span>, <span class="keyword">this</span>.msgObj.clientHeight);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">//退出，本例只是一个简单的刷新</span></span><br><span class="line">        logout:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="comment">//this.socket.disconnect();</span></span><br><span class="line">            location.reload();</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">//提交聊天消息内容</span></span><br><span class="line">        submit:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> content = d.getElementById(<span class="string">"content"</span>).value;</span><br><span class="line">            <span class="keyword">if</span>(content != <span class="string">''</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> obj = &#123;</span><br><span class="line">                    userid: <span class="keyword">this</span>.userid,</span><br><span class="line">                    username: <span class="keyword">this</span>.username,</span><br><span class="line">                    content: content</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">this</span>.socket.emit(<span class="string">'message'</span>, obj);</span><br><span class="line">                d.getElementById(<span class="string">"content"</span>).value = <span class="string">''</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        genUid:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Date</span>().getTime()+<span class="string">""</span>+<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">899</span>+<span class="number">100</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">//更新系统消息，本例中在用户加入、退出的时候调用</span></span><br><span class="line">        updateSysMsg:<span class="function"><span class="keyword">function</span>(<span class="params">o, action</span>)</span>&#123;</span><br><span class="line">            <span class="comment">//当前在线用户列表</span></span><br><span class="line">            <span class="keyword">var</span> onlineUsers = o.onlineUsers;</span><br><span class="line">            <span class="comment">//当前在线人数</span></span><br><span class="line">            <span class="keyword">var</span> onlineCount = o.onlineCount;</span><br><span class="line">            <span class="comment">//新加入用户的信息</span></span><br><span class="line">            <span class="keyword">var</span> user = o.user;</span><br><span class="line">                 </span><br><span class="line">            <span class="comment">//更新在线人数</span></span><br><span class="line">            <span class="keyword">var</span> userhtml = <span class="string">''</span>;</span><br><span class="line">            <span class="keyword">var</span> separator = <span class="string">''</span>;</span><br><span class="line">            <span class="keyword">for</span>(key <span class="keyword">in</span> onlineUsers) &#123;</span><br><span class="line">                <span class="keyword">if</span>(onlineUsers.hasOwnProperty(key))&#123;</span><br><span class="line">                    userhtml += separator+onlineUsers[key];</span><br><span class="line">                    separator = <span class="string">'、'</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            d.getElementById(<span class="string">"onlinecount"</span>).innerHTML = <span class="string">'当前共有 '</span>+onlineCount+<span class="string">' 人在线，在线列表：'</span>+userhtml;</span><br><span class="line">             </span><br><span class="line">            <span class="comment">//添加系统消息</span></span><br><span class="line">            <span class="keyword">var</span> html = <span class="string">''</span>;</span><br><span class="line">            html += <span class="string">'&lt;div class="msg-system"&gt;'</span>;</span><br><span class="line">            html += user.username;</span><br><span class="line">            html += (action == <span class="string">'login'</span>) ? <span class="string">' 加入了聊天室'</span> : <span class="string">' 退出了聊天室'</span>;</span><br><span class="line">            html += <span class="string">'&lt;/div&gt;'</span>;</span><br><span class="line">            <span class="keyword">var</span> section = d.createElement(<span class="string">'section'</span>);</span><br><span class="line">            section.className = <span class="string">'system J-mjrlinkWrap J-cutMsg'</span>;</span><br><span class="line">            section.innerHTML = html;</span><br><span class="line">            <span class="keyword">this</span>.msgObj.appendChild(section);  </span><br><span class="line">            <span class="keyword">this</span>.scrollToBottom();</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">//第一个界面用户提交用户名</span></span><br><span class="line">        usernameSubmit:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> username = d.getElementById(<span class="string">"username"</span>).value;</span><br><span class="line">            <span class="keyword">if</span>(username != <span class="string">""</span>)&#123;</span><br><span class="line">                d.getElementById(<span class="string">"username"</span>).value = <span class="string">''</span>;</span><br><span class="line">                d.getElementById(<span class="string">"loginbox"</span>).style.display = <span class="string">'none'</span>;</span><br><span class="line">                d.getElementById(<span class="string">"chatbox"</span>).style.display = <span class="string">'block'</span>;</span><br><span class="line">                <span class="keyword">this</span>.init(username);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        init:<span class="function"><span class="keyword">function</span>(<span class="params">username</span>)</span>&#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            客户端根据时间和随机数生成uid,这样使得聊天室用户名称可以重复。</span></span><br><span class="line"><span class="comment">            实际项目中，如果是需要用户登录，那么直接采用用户的uid来做标识就可以</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="keyword">this</span>.userid = <span class="keyword">this</span>.genUid();</span><br><span class="line">            <span class="keyword">this</span>.username = username;</span><br><span class="line">             </span><br><span class="line">            d.getElementById(<span class="string">"showusername"</span>).innerHTML = <span class="keyword">this</span>.username;</span><br><span class="line">            <span class="keyword">this</span>.msgObj.style.minHeight = (<span class="keyword">this</span>.screenheight - db.clientHeight + <span class="keyword">this</span>.msgObj.clientHeight) + <span class="string">"px"</span>;</span><br><span class="line">            <span class="keyword">this</span>.scrollToBottom();</span><br><span class="line">             </span><br><span class="line">            <span class="comment">//连接websocket后端服务器</span></span><br><span class="line">            <span class="keyword">this</span>.socket = io.connect(<span class="string">'ws://realtime.plhwin.com:3000'</span>);</span><br><span class="line">             </span><br><span class="line">            <span class="comment">//告诉服务器端有用户登录</span></span><br><span class="line">            <span class="keyword">this</span>.socket.emit(<span class="string">'login'</span>, &#123;<span class="attr">userid</span>:<span class="keyword">this</span>.userid, <span class="attr">username</span>:<span class="keyword">this</span>.username&#125;);</span><br><span class="line">             </span><br><span class="line">            <span class="comment">//监听新用户登录</span></span><br><span class="line">            <span class="keyword">this</span>.socket.on(<span class="string">'login'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">o</span>)</span>&#123;</span><br><span class="line">                CHAT.updateSysMsg(o, <span class="string">'login'</span>); </span><br><span class="line">            &#125;);</span><br><span class="line">             </span><br><span class="line">            <span class="comment">//监听用户退出</span></span><br><span class="line">            <span class="keyword">this</span>.socket.on(<span class="string">'logout'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">o</span>)</span>&#123;</span><br><span class="line">                CHAT.updateSysMsg(o, <span class="string">'logout'</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">             </span><br><span class="line">            <span class="comment">//监听消息发送</span></span><br><span class="line">            <span class="keyword">this</span>.socket.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">var</span> isme = (obj.userid == CHAT.userid) ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">var</span> contentDiv = <span class="string">'&lt;div&gt;'</span>+obj.content+<span class="string">'&lt;/div&gt;'</span>;</span><br><span class="line">                <span class="keyword">var</span> usernameDiv = <span class="string">'&lt;span&gt;'</span>+obj.username+<span class="string">'&lt;/span&gt;'</span>;</span><br><span class="line">                 </span><br><span class="line">                <span class="keyword">var</span> section = d.createElement(<span class="string">'section'</span>);</span><br><span class="line">                <span class="keyword">if</span>(isme)&#123;</span><br><span class="line">                    section.className = <span class="string">'user'</span>;</span><br><span class="line">                    section.innerHTML = contentDiv + usernameDiv;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    section.className = <span class="string">'service'</span>;</span><br><span class="line">                    section.innerHTML = usernameDiv + contentDiv;</span><br><span class="line">                &#125;</span><br><span class="line">                CHAT.msgObj.appendChild(section);</span><br><span class="line">                CHAT.scrollToBottom(); </span><br><span class="line">            &#125;);</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//通过“回车”提交用户名</span></span><br><span class="line">    d.getElementById(<span class="string">"username"</span>).onkeydown = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">        e = e || event;</span><br><span class="line">        <span class="keyword">if</span> (e.keyCode === <span class="number">13</span>) &#123;</span><br><span class="line">            CHAT.usernameSubmit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//通过“回车”提交信息</span></span><br><span class="line">    d.getElementById(<span class="string">"content"</span>).onkeydown = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">        e = e || event;</span><br><span class="line">        <span class="keyword">if</span> (e.keyCode === <span class="number">13</span>) &#123;</span><br><span class="line">            CHAT.submit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></p>
<p>至此所有的编码开发工作全部完成了，在浏览器中打开<a href="http://demo.plhwin.com/chat/" target="_blank" rel="noopener">http://demo.plhwin.com/chat/</a>就可以看到效果了。<br>上面所有的客户端和服务端的代码可以从Github上获得，地址：<a href="https://github.com/plhwin/nodejs-socketio-chat" target="_blank" rel="noopener">https://github.com/plhwin/nodejs-socketio-chat</a><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/plhwin/nodejs-socketio-chat.git</span><br></pre></td></tr></table></figure></p>
<p>下载本地后有两个文件夹 client 和 server，client文件夹是客户端源码，可以放在Nginx/Apache的WebServer中，也可以放在Node.js的WebServer中。后面的server文件夹里的代码是websocket服务端代码，放在Node.js环境中，使用npm安装完 express 和 socket.io 后，node index.js 启动后端服务就可以了。</p>
<p>本例只是一个简单的Demo，留下2个有关项目扩展的思考：<br>1、假设是一个在线客服系统，里面有许多的公司使用你的服务，每个公司自己的用户可以通过一个专属URL地址进入该公司的聊天室，聊天是一对一的，每个公司可以新建多个客服人员，每个客服人员可以同时和客户端的多个用户聊天。<br>2、又假设是一个在线WebIM系统，实现类似微信，qq的功能，客户端可以看到好友在线状态，在线列表，添加好友，删除好友，新建群组等，消息的发送除了支持基本的文字外，还能支持表情、图片和文件。</p>
<p>转载自：<a href="http://www.plhwin.com/2014/05/28/nodejs-socketio/" target="_blank" rel="noopener">http://www.plhwin.com/2014/05/28/nodejs-socketio/</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/09/29/使用Node.js+Socket.IO搭建WebSocket实时应用/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/09/29/初识 Docker - 使用 tenxcloud.com 搭建自己的应用/"><span>初识 Docker - 使用 tenxcloud.com 搭建自己的应用</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/09/29/初识 Docker - 使用 tenxcloud.com 搭建自己的应用/" rel="bookmark">
        <time class="entry-date published" datetime="2015-09-28T23:01:19.000Z">
          2015-09-29
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>2015-09-30 更新:<br>daocloud 提供的配额更慷慨，各位有兴趣的话可以走我的邀请链接: <a href="https://account.daocloud.io/signup?invite_code=r7vcv0n2nenytal22llp" target="_blank" rel="noopener">https://account.daocloud.io/signup?invite_code=r7vcv0n2nenytal22llp</a>，绑定微信的话送一个容器配额，一共三个。</p>
<p>需要搭 WordPress 的，请直接移步 <a href="http://www.freehao123.com/tenxcloud/" target="_blank" rel="noopener">http://www.freehao123.com/tenxcloud/</a></p>
<p>不知道什么是 Docker 的，请移步 <a href="http://baike.baidu.com/view/11854949.htm" target="_blank" rel="noopener">http://baike.baidu.com/view/11854949.htm</a>。我认为这和以前的 PaaS 类云平台(比如 appfog)差不多，都是布置完即成型，所有修改不保存的东西。<br>来看看探针: <a href="http://musics-johnshen.tenxcloud.net/" target="_blank" rel="noopener">http://musics-johnshen.tenxcloud.net/</a> (5M 共享带宽，28 块一个月的，所以要是探针失效了别来找我，多半是我觉得不划算了)<br>好，接下来进入正题，如何在时速云上部署你的 PHP 应用。(其实官方有个 PHP 的 Hello world 的，但哔了狗的不能用)</p>
<p>首先，<a href="/uploads/2015/09/Yahei.zip">下载代码包</a>并使用 git 上传到你喜欢的平台。然后打开时速云，选择构建，点击添加源代码，并登录你的 github 账号(当然你要是想只放个探针可以选快速构建，而不是添加源代码，然后在下一步中照我的填):<br><a href="/uploads/2015/09/Screenshot_2015-09-29-14-31-26.png"><img src="/uploads/2015/09/Screenshot_2015-09-29-14-31-26.png" alt="Screenshot_2015-09-29-14-31-26"></a><br>选择你要构建的项目之后，你可以修改你的镜像名称，然后点击创建:<br><a href="/uploads/2015/09/Screenshot_2015-09-29-14-31-52.png"><img src="/uploads/2015/09/Screenshot_2015-09-29-14-31-52.png" alt="Screenshot_2015-09-29-14-31-52"></a><br>创建完成之后:<br><a href="/uploads/2015/09/Screenshot_2015-09-29-14-32-07.png"><img src="/uploads/2015/09/Screenshot_2015-09-29-14-32-07.png" alt="Screenshot_2015-09-29-14-32-07"></a><br>可点击你的项目的名称进入以下界面并快速部署你的应用:<br><a href="/uploads/2015/09/Screenshot_2015-09-29-14-32-29.png"><img src="/uploads/2015/09/Screenshot_2015-09-29-14-32-29.png" alt="Screenshot_2015-09-29-14-32-29"></a><br>填上服务名称，创建即可:<br><a href="/uploads/2015/09/Screenshot_2015-09-29-14-32-48.png"><img src="/uploads/2015/09/Screenshot_2015-09-29-14-32-48.png" alt="Screenshot_2015-09-29-14-32-48"></a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/VPS-技术/">VPS 技术</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/09/29/初识 Docker - 使用 tenxcloud.com 搭建自己的应用/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/09/24/将树莓派系统迁移至 U 盘上/"><span>将树莓派系统迁移至 U 盘上</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/09/24/将树莓派系统迁移至 U 盘上/" rel="bookmark">
        <time class="entry-date published" datetime="2015-09-24T04:32:16.000Z">
          2015-09-24
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>　　新入手了个 pi 2B，先上张全家福（好吧图有点大）<br><a href="/uploads/2015/09/20150924_195814.jpg"><img src="/uploads/2015/09/20150924_195814-300x169.jpg" alt="20150924_195814"></a><br>　　那啥，把系统移动到 u 盘里的好处应该不用我说了吧，相信各位也应该百度过了。但是！百度下来的各种教程却是各种麻烦，有用 U-Boot 的，有用 BerryBoot 的，反正就是各种奇奇葩葩的第三方。其实，事情并没有那么复杂：</p>
<p>为确保不会发生错误，本文所有语句均在 root 用户下执行**</p>
<p><strong>第一步：给 U 盘分区</strong><br>　　因为 U 盘比较大，所以不想全部用在树莓派上，当然各位要是土豪可以跳过这一步。<br>　　在这里需要注意的是，常用文件分区（FAT32/NTFS/exFAT）一定要分在第一个区，树莓派的 ext3 要分在第二个区，不然傻乎乎的 Windows 会不认识。如图：<br><a href="/uploads/2015/09/QQ图片20150924201713.png"><img src="/uploads/2015/09/QQ图片20150924201713.png" alt="QQ图片20150924201713"></a><br>　　分区时可以不用管树莓派分区的文件系统，因为后续操作会覆盖掉。</p>
<p><strong>第二步：将 sd 卡中的系统迁移至 U 盘</strong><br>　　很简单，用 dd 就行了。在这里我的 U 盘是 sda，第二个分区：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=/dev/mmcblk0p2 of=/dev/sda2 bs=4M</span><br></pre></td></tr></table></figure></p>
<p>　　写完以后，修复 U 盘分区：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">e2fsck -f /dev/sda2</span><br><span class="line">resize2fs /dev/sda2</span><br></pre></td></tr></table></figure></p>
<p><a href="/uploads/2015/09/QQ截图20150924202346.png"><img src="/uploads/2015/09/QQ截图20150924202346.png" alt="QQ截图20150924202346"></a></p>
<p><strong>第三步：重新配置启动设备   重要！！！</strong><br>　　挂载刚刚写完的分区上系统：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir sda2</span><br><span class="line">mount /dev/sda2 sda2</span><br></pre></td></tr></table></figure></p>
<p>　　修改以下两个文件，内容如图：</p>
<ul>
<li>/boot/cmdline.txt</li>
</ul>
<ul>
<li>./sda2/etc/fstab</li>
</ul>
<p><a href="/uploads/2015/09/2015-09-24-120659_480x320_scrot.png"><img src="/uploads/2015/09/2015-09-24-120659_480x320_scrot.png" alt="2015-09-24-120659_480x320_scrot"></a><br>　　注意因为这是迁移完截的图，所以 fstab 的路径有点区别。</p>
<p>　　然后 reboot 一下就大功告成啦。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Linux-Desktop/">Linux Desktop</a>, <a href="/categories/Linux-Desktop/树莓派/">树莓派</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/09/24/将树莓派系统迁移至 U 盘上/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/09/12/【逆向爆菊】某DDOS事件逆向追踪。。。有人深挖过吗？/"><span>【逆向爆菊】某DDOS事件逆向追踪。。。有人深挖过吗？</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/09/12/【逆向爆菊】某DDOS事件逆向追踪。。。有人深挖过吗？/" rel="bookmark">
        <time class="entry-date published" datetime="2015-09-12T05:00:54.000Z">
          2015-09-12
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>鄙人多次处理过各种被黑找幕后黑手事件。。。<br>如某领导早匿名邮件举报，干掉163拿到邮箱找发件人，，，某学生无聊干了当地教育局配合抓人，，，等等。。。<br>这还是第一次逆向DDOS事件。。。<br>某日一友人求助说维护的客户网站遭受SYN，毕竟政府用户有防火墙和IPS，告诉他设置防护就好了。。<br>第二日。。友人又来，说设置了没用。。。<br>给了我远程查看配置，发现某防火墙居然功能模块还有到期事件，正好所有模块到期，这防火墙就等于一台路由器了。。。<br>无奈只得导出日志分析IP手工添加ACL。。。</p>
<p>下面切入正题：<br>IP导出后，朋友自己加ACL，同时提到去年同一时间也有同样攻击。我怀疑攻击者目的，为什么防火墙功能模块刚到期就发起攻击？<br>怀着好奇心。。对导出的攻击IP进行扫描<br><a href="/uploads/2015/09/cache-4283972c60ea687cc15249676ff74e6c_1.jpg"><img src="/uploads/2015/09/cache-4283972c60ea687cc15249676ff74e6c_1-181x300.jpg" alt="-cache-4283972c60ea687cc15249676ff74e6c_1"></a><br>其实如果是国内黑产，不过是1433、3389、3306等常见抓鸡。。ISP封了135 445 等端口SMB服务的利用可能性不大。<br>果真在记录IP中发现一台3306弱口令<br><a href="/uploads/2015/09/cache-af9551f2d9d65052ad7324c78207f2c7_2.jpg"><img src="/uploads/2015/09/cache-af9551f2d9d65052ad7324c78207f2c7_2-300x106.jpg" alt="-cache-af9551f2d9d65052ad7324c78207f2c7_2"></a><br>然后大家就应该知道了。。。UDF.dll提权即可。。<br>由于时间已是凌晨2点，直接命令mysql连接，查了些信息<br><a href="/uploads/2015/09/cache-1161ee2a636574c820a506b4bf3e434b_3.jpg"><img src="/uploads/2015/09/cache-1161ee2a636574c820a506b4bf3e434b_3-300x290.jpg" alt="-cache-1161ee2a636574c820a506b4bf3e434b_3"></a><br><a href="/uploads/2015/09/cache-c016d05db73a755a16f711d837c4db3d_4.jpg"><img src="/uploads/2015/09/cache-c016d05db73a755a16f711d837c4db3d_4-300x273.jpg" alt="-cache-c016d05db73a755a16f711d837c4db3d_4"></a><br>可以看出一些IP。。<br>其中某IP<br><a href="/uploads/2015/09/cache-372565cecc1a67a9185b2a0d40fbc548_5.jpg"><img src="/uploads/2015/09/cache-372565cecc1a67a9185b2a0d40fbc548_5-300x188.jpg" alt="-cache-372565cecc1a67a9185b2a0d40fbc548_5"></a><br>域名对应？？？<br><a href="/uploads/2015/09/cache-f257d616a19f1449cdae297826c9f248_6.jpg"><img src="/uploads/2015/09/cache-f257d616a19f1449cdae297826c9f248_6-252x300.jpg" alt="-cache-f257d616a19f1449cdae297826c9f248_6"></a><br>邮箱对应？？？<br><a href="/uploads/2015/09/cache-5b461e8e2c2932a10a11f5e121963ea8_7.jpg"><img src="/uploads/2015/09/cache-5b461e8e2c2932a10a11f5e121963ea8_7-244x300.jpg" alt="-cache-5b461e8e2c2932a10a11f5e121963ea8_7"></a><br>收款地址？？？<br><a href="/uploads/2015/09/cache-b5b3e354385559e34782748b535d98fc_8.jpg"><img src="/uploads/2015/09/cache-b5b3e354385559e34782748b535d98fc_8-300x233.jpg" alt="-cache-b5b3e354385559e34782748b535d98fc_8"></a><br>淘宝走你？？？<br><a href="/uploads/2015/09/cache-3dc9cbb7c78e980ad40acaaae5d909fb_9.jpg"><img src="/uploads/2015/09/cache-3dc9cbb7c78e980ad40acaaae5d909fb_9-300x142.jpg" alt="-cache-3dc9cbb7c78e980ad40acaaae5d909fb_9"></a><br>还用多少几句吗？？<br>蒋华同学请小心了。。。<br>可惜没有下载病毒样本与其他进一步证据保留。。。否则大家都懂。。。</p>
<p>转载自 <a href="http://zone.wooyun.org/content/5808" target="_blank" rel="noopener">http://zone.wooyun.org/content/5808</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/杂七杂八/">杂七杂八</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/09/12/【逆向爆菊】某DDOS事件逆向追踪。。。有人深挖过吗？/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/09/07/CentOS 下 yum 安装 PostgreSQL/"><span>CentOS 下 yum 安装 PostgreSQL</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/09/07/CentOS 下 yum 安装 PostgreSQL/" rel="bookmark">
        <time class="entry-date published" datetime="2015-09-07T04:50:25.000Z">
          2015-09-07
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p><strong>Configure YUM repository</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/yum.repos.d/CentOS-Base.repo</span><br></pre></td></tr></table></figure></p>
<p>[base] and [updates] sections添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exclude=postgresql*</span><br></pre></td></tr></table></figure></p>
<p><strong>Install PGDG RPM file</strong><br>go <a href="http://yum.postgresql.org" target="_blank" rel="noopener">http://yum.postgresql.org</a> and find your correct RPM.<br>For example, to install PostgreSQL 9.4 on CentOS 6 64-bit:<br>打开 <a href="http://yum.postgresql.org/repopackages.php#pg94" target="_blank" rel="noopener">http://yum.postgresql.org/repopackages.php#pg94</a> 后找到 CentOS 6 - x86_64<br>then:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall http://yum.postgresql.org/9.4/redhat/rhel-6-x86_64/pgdg-centos94-9.4-1.noarch.rpm</span><br></pre></td></tr></table></figure></p>
<p><strong>Install PostgreSQL</strong><br>list available packages:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum list postgres*</span><br></pre></td></tr></table></figure></p>
<p>For example, to install a basic PostgreSQL 9.4 server:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install postgresql94-server</span><br></pre></td></tr></table></figure></p>
<p>Other packages can be installed according to your needs.</p>
<p><strong>配置</strong><br>After installing the packages, a database needs to be initialized and configured.<br>PostgreSQL data directory（/var/lib/pgsql/9.4/data） contains all of the data files for the database.</p>
<p><strong>Initialize</strong><br>The first command (only needed once) is to initialize the database：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service postgresql-9.4 initdb</span><br></pre></td></tr></table></figure></p>
<p>正在初始化数据库：                                         [确定]</p>
<p><strong>Startup</strong><br>开机启动：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chkconfig postgresql-9.4 on</span><br><span class="line">service postgresql-9.4 start</span><br></pre></td></tr></table></figure></p>
<p>转载自 <a href="http://www.centoscn.com/CentosServer/sql/2014/0923/3821.html" target="_blank" rel="noopener">http://www.centoscn.com/CentosServer/sql/2014/0923/3821.html</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/VPS-技术/">VPS 技术</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/09/07/CentOS 下 yum 安装 PostgreSQL/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/08/05/Wifidog Portal认证示例PHP脚本/"><span>Wifidog Portal认证示例PHP脚本</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/08/05/Wifidog Portal认证示例PHP脚本/" rel="bookmark">
        <time class="entry-date published" datetime="2015-08-05T06:58:15.000Z">
          2015-08-05
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>在上一篇文章“ OpenWRT下实现Portal认证(WEB认证) ”发布之后，很多人留言和发邮件与我交流，我感到很是欣慰。我之所以写上一篇文章的目的，一方面Wifidog是很好的解决方案，虽然有很成熟的应用，但相关技术性的文章很少，官方文档也不全。已完成开发的一般也就做成商业解决方案收费，让很多爱折腾的极客难以入手。实际上Wifidog的功能我还没发掘完，如果你有能力，你同意通过各种分析手段尽心分析，甚至是自行解读源代码。我在写了上一篇文章，我自行写了一些PHP测试代码，测试Portal功能能否正确实现，当然我没有公布测试代码，初衷是希望授之以鱼不如授之以渔，不过鉴于给个测试代码可能对初学者更有帮助，另外也有很多人来邮询问，故经修改公开供读者学习。<br>声明：代码属于测试代码，缺乏安全性等方面的优化，用于线上环境请慎重，因此而出现的任何问题我当然不会负责。转载请说明出处。<br>PHP脚本，Portal服务器需要有Apache或Nginx环境，当然如果你会配置，IIS也行，另外需要使用数据库存储用户的用户名和密码，我选择使用常用的MySQL。<br>先介绍数据库的结构，我构建的数据库名是portal，表名是User，用于记录等录用用户的用户名、密码等的信息:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> portal;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`User`</span> (</span><br><span class="line"><span class="string">`Username`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line"><span class="string">`Password`</span> <span class="built_in">text</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line"><span class="string">`Token`</span> <span class="built_in">text</span>,</span><br><span class="line"><span class="string">`LoginTime`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line"><span class="string">`Gw_address`</span> <span class="built_in">text</span>,</span><br><span class="line"><span class="string">`Gw_port`</span> <span class="built_in">text</span>,</span><br><span class="line"><span class="string">`Gw_id`</span> <span class="built_in">text</span>,</span><br><span class="line"><span class="string">`Mac`</span> <span class="built_in">text</span>,</span><br><span class="line"><span class="string">`Url`</span> <span class="built_in">text</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (<span class="string">`Username`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure></p>
<p>首先介绍的是登陆脚本，即上一篇文章介绍的LoginScriptPathFragment配置项配置的脚本(详细介绍见上一篇文章)。<br>auth.php，主要用于认证服务器验证路由网关提交的token。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="comment">//首先获取URL传递过来的参数，包括stage、ip、mac、token、incoming、outgoing和gw_id.</span></span><br><span class="line">	$stage = <span class="keyword">isset</span>($_GET[<span class="string">"stage"</span>]) ? $_GET[<span class="string">"stage"</span>] : <span class="keyword">null</span>;</span><br><span class="line">	$ip = <span class="keyword">isset</span>($_GET[<span class="string">"ip"</span>]) ? $_GET[<span class="string">"ip"</span>] : <span class="keyword">null</span>;</span><br><span class="line">	$mac = <span class="keyword">isset</span>($_GET[<span class="string">"mac"</span>]) ? $_GET[<span class="string">"mac"</span>] : <span class="keyword">null</span>;</span><br><span class="line">	$token = <span class="keyword">isset</span>($_GET[<span class="string">"token"</span>]) ? $_GET[<span class="string">"token"</span>] : <span class="keyword">null</span>;</span><br><span class="line">	$incoming = <span class="keyword">isset</span>($_GET[<span class="string">"incoming"</span>]) ? $_GET[<span class="string">"incoming"</span>] : <span class="keyword">null</span>;</span><br><span class="line">	$outgoing = <span class="keyword">isset</span>($_GET[<span class="string">"outgoing"</span>]) ? $_GET[<span class="string">"outgoing"</span>] : <span class="keyword">null</span>;</span><br><span class="line">	$gw_id = <span class="keyword">isset</span>($_GET[<span class="string">"gw_id"</span>]) ? $_GET[<span class="string">"gw_id"</span>] : <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">//mac和token是必需参数，不能为空，只有mac和token均不为空才有可能通过验证，缺失参数将不显示登录表单.</span></span><br><span class="line">	<span class="keyword">if</span>(!<span class="keyword">empty</span>($mac) &amp;&amp; !<span class="keyword">empty</span>($token))&#123;</span><br><span class="line">		<span class="comment">//mysql连接，相应的参数mysql_host、mysql_user和mysql_password需要换成你自己的参数.</span></span><br><span class="line">		$con = mysql_connect(‘mysql_host’, ‘mysql_user’, ‘mysql_password’);</span><br><span class="line">		<span class="comment">//数据库连接失败，验证不通过.</span></span><br><span class="line">		<span class="keyword">if</span>(!$con)&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"Auth: 0"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="comment">//选择mysql数据库，如果你的数据库名不是portal，请自行更改.</span></span><br><span class="line">			mysql_select_db(‘portal’, $con);</span><br><span class="line">			<span class="comment">//用户登陆成功后，会把用户的参数(ip、mac和系统自动生成的token等)记录到数据库，系统主要通过mac识别用户，当然这种方式在大规模系统中可能存在漏洞.</span></span><br><span class="line">			$result = mysql_query(<span class="string">"SELECT * FROM User WHERE Mac='"</span>.$mac.<span class="string">"' AND Token='"</span>.$token.<span class="string">"'"</span>);</span><br><span class="line">			<span class="comment">//如果token匹配，验证通过，否则验证失败.</span></span><br><span class="line">			<span class="keyword">if</span>(!<span class="keyword">empty</span>($result) &amp;&amp; mysql_num_rows($result) != <span class="number">0</span>)&#123;</span><br><span class="line">				<span class="keyword">echo</span> <span class="string">"Auth: 1"</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="keyword">echo</span> <span class="string">"Auth: 0"</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"Auth: 0"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>接下来介绍的是登陆成功脚本，即上文介绍的PortalScriptPathFragment配置项配置的脚本(详细介绍见上一篇文章)。<br>portal.php，主要作用是告知用户登录成功，并跳转用户登录前访问的页面。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="comment">//告知用户登陆成功.</span></span><br><span class="line">	<span class="comment">//echo ‘登录成功’;</span></span><br><span class="line">	<span class="comment">//认证前用户访问任意url，然后被重定向登录页面，session记录的是这个“任意url”.</span></span><br><span class="line">	$url = $_SESSION[<span class="string">"url"</span>];</span><br><span class="line">	<span class="comment">//跳转到登陆前页面.</span></span><br><span class="line">	header(<span class="string">"Location: "</span>.$url);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>当然，这个脚本没有任何界面，为提升用户体验，你可以设计一个好的界面，显示登陆成功信息。</p>
<p>接下来介绍的是错误信息展示脚本，即上文介绍的MsgScriptPathFragment配置项配置的脚本，(详细介绍见上一篇文章)。<br>gw_message.php，主要作用是当认证过程出现错误的时候，向用户显示用户信息。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$message = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">"message"</span>]))&#123;</span><br><span class="line">		$message = $_GET[<span class="string">"message"</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">echo</span> $message;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>脚本非常简单，错误信息就在message参数中，告知用户即可。当然这个错误信息是英文的，如有需要，可以做做翻译，以提升用户体验。这个脚本同样没有任何界面，需自行设计。</p>
<p>接下来介绍的是心跳脚本，即上文介绍的PingScriptPathFragment配置项配置的脚本，(详细介绍见上一篇文章)。<br>ping.php，其主要作用是路由确认认证服务器仍然存活，没有死机，另外一个功能是认证服务器可以收集路由的负载等的信息。路由器会定时访问这个脚本，脚本必须回复Pong，否则将认为认证服务器失效而出错。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">echo</span> ‘Pong’;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>最后介绍的是登陆脚本，即上文介绍的AuthScriptPathFragment配置项配置的脚本，(详细介绍见上一篇文章)。<br>login.php，主要作用是显示登录界面，用户登陆成功后，跳转到路由器网关的特定接口。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="comment">//获取url传递过来的参数</span></span><br><span class="line">	$gw_address = <span class="keyword">isset</span>($_GET[<span class="string">"gw_address"</span>]) ? $_GET[<span class="string">"gw_address"</span>] : <span class="keyword">null</span>;</span><br><span class="line">	$gw_port = <span class="keyword">isset</span>($_GET[<span class="string">"gw_port"</span>]) ? $_GET[<span class="string">"gw_port"</span>] : <span class="keyword">null</span>;</span><br><span class="line">	$gw_id = <span class="keyword">isset</span>($_GET[<span class="string">"gw_id"</span>]) ? $_GET[<span class="string">"gw_id"</span>] : <span class="keyword">null</span>;</span><br><span class="line">	$mac = <span class="keyword">isset</span>(<span class="keyword">isset</span>($_GET[<span class="string">"mac"</span>]) ? <span class="keyword">isset</span>($_GET[<span class="string">"mac"</span>] : <span class="keyword">null</span>;</span><br><span class="line">	$url = <span class="keyword">isset</span>($_GET[<span class="string">"url"</span>]) ? $_GET[<span class="string">"url"</span>] : <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">//gw_address、gw_port、gw_id和mac是必需参数，缺少不能认证成功.</span></span><br><span class="line">	<span class="keyword">if</span>(!<span class="keyword">empty</span>($gw_address) &amp;&amp; !<span class="keyword">empty</span>($gw_port) &amp;&amp; !<span class="keyword">empty</span>($gw_id) &amp;&amp; !<span class="keyword">empty</span>($mac))&#123;</span><br><span class="line">		<span class="comment">//参数初始化</span></span><br><span class="line">		$post_username = <span class="keyword">null</span>;</span><br><span class="line">		$post_password = <span class="keyword">null</span>;</span><br><span class="line">		$error_message = <span class="keyword">null</span>;</span><br><span class="line">		<span class="comment">//如果用户提交用户名和密码，进行验证</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"username"</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">"password"</span>]))&#123;</span><br><span class="line">			$post_username = $_POST[<span class="string">"username"</span>];</span><br><span class="line">			$post_password = $_POST[<span class="string">"password"</span>];</span><br><span class="line">			<span class="comment">//mysql数据库连接，相应的参数mysql_host、mysql_user和mysql_password需要换成你自己的参数.</span></span><br><span class="line">			$con = mysql_connect(‘mysql_host’, ‘mysql_user’, ‘mysql_password’);</span><br><span class="line">			<span class="comment">//数据库连接失败，展示错误信息</span></span><br><span class="line">			<span class="keyword">if</span>(!$con)&#123;</span><br><span class="line">				$error_message = <span class="string">"数据库连接错误!"</span>.mysql_error();</span><br><span class="line">				<span class="comment">//login_view.php展示的是登陆表单(下文介绍)，如有错误，展示错误信息.</span></span><br><span class="line">				<span class="keyword">include</span>(<span class="string">"login_view.php"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="comment">//选择mysql数据库，如果你的数据库名不是portal，请自行更改.</span></span><br><span class="line">				mysql_select_db(‘portal’, $con);</span><br><span class="line">				<span class="comment">//用户名和密码验证.</span></span><br><span class="line">				$result = mysql_query(<span class="string">"SELECT * FROM User WHERE Username='"</span>.$post_username.<span class="string">"' AND Password='"</span>.$post_password.<span class="string">"'"</span>);</span><br><span class="line">				<span class="keyword">if</span>(!<span class="keyword">empty</span>($result) &amp;&amp; mysql_num_rows($result) != <span class="number">0</span>)&#123;</span><br><span class="line">					<span class="comment">//用户名和密码验证成功，生成随机token.</span></span><br><span class="line">					$token = <span class="string">""</span>;</span><br><span class="line">					$pattern=<span class="string">"1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLOMNOPQRSTUVWXYZ"</span>;</span><br><span class="line">					<span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">32</span>;$i++)&#123;</span><br><span class="line">						$token .= $pattern&#123;mt_rand(<span class="number">0</span>,<span class="number">35</span>)&#125;;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="comment">//把token等参数写入数据库，已被用于后续验证(上文提到的auth.php).</span></span><br><span class="line">					mysql_query(<span class="string">"Update User SET Token='"</span>.$token.<span class="string">"', LoginTime='"</span>.date(<span class="string">"Y-m-d H:i:s"</span>).<span class="string">"', Gw_address='"</span>.$gw_address.<span class="string">"', Gw_port='"</span>.$gw_port.<span class="string">"', Gw_id='"</span>.$gw_id.<span class="string">"', Mac='"</span>.$mac.<span class="string">"', Url='"</span>.$url.<span class="string">"' WHERE Username='"</span>.$post_username.<span class="string">"'"</span>);</span><br><span class="line">					$error_message = mysql_error();</span><br><span class="line">					<span class="comment">//把用户名和url存进session，以备后续使用.</span></span><br><span class="line">					session_start();</span><br><span class="line">					$_SESSION[<span class="string">'username'</span>] = $post_username;</span><br><span class="line">					$_SESSION[<span class="string">'url'</span>] = $url;</span><br><span class="line">					<span class="comment">//登陆成功，跳转到路由网管指定的页面.</span></span><br><span class="line">					header(<span class="string">"Location: http://"</span>.$gw_address.<span class="string">":"</span>.$gw_port.<span class="string">"/wifidog/auth?token="</span>.$token);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span>&#123;</span><br><span class="line">					<span class="comment">//登录失败，显示错误信息.</span></span><br><span class="line">					$error_message = <span class="string">"用户名或密码错误！"</span>;</span><br><span class="line">					<span class="keyword">include</span>(<span class="string">"login_view.php"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">include</span>(<span class="string">"login_view.php"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>Login_view.php登陆表单。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"language"</span> <span class="attr">content</span>=<span class="string">"en"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>Portal Login<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"&lt;?php echo "</span><span class="attr">login.php</span>?<span class="attr">gw_address</span>=<span class="string">$gw_address&amp;gw_port</span>=<span class="string">$gw_port&amp;gw_id</span>=<span class="string">$gw_id&amp;mac</span>=<span class="string">$mac&amp;url</span>=<span class="string">$url</span>"; ?&gt;</span>"&gt;</span><br><span class="line">		<span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"username"</span>&gt;</span>Username<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"username"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"&lt;?php echo $post_username; ?&gt;"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"password"</span>&gt;</span>Password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">id</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"&lt;?php echo $post_password; ?&gt;"</span>/&gt;</span></span><br><span class="line">		<span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">			<span class="keyword">if</span>(!<span class="keyword">empty</span>($error_message))&#123;</span></span><br><span class="line"><span class="php">				<span class="keyword">echo</span> <span class="string">"&lt;h4&gt;$error_message&lt;/h4&gt;"</span>;</span></span><br><span class="line"><span class="php">			&#125;</span></span><br><span class="line"><span class="php">		<span class="meta">?&gt;</span></span></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Submit"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>这大致就是一个简单的认证系统脚本。再次啰唆，脚本安全性、稳定现等均得不到保证，不能防范sql注入等的黑客主机，仅供交流和测试，线上使用需慎重。转载请注明出处。当然，系统仍然有位开发的功能，有待各位自行发掘。</p>
<p>转载自 <a href="http://talk.withme.me/?p=267" target="_blank" rel="noopener">http://talk.withme.me/?p=267</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/openwrt/">openwrt</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/08/05/Wifidog Portal认证示例PHP脚本/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>




<nav class="pagination">
  
  <a href="/page/6/" class="pagination-prev">上一页</a>
  
  
  <a href="/page/8/" class="pagination-next">下一页</a>
  
</nav>
    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2021 403 Forbidden
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>