<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 2 页 | 博客</title>

  
  <meta name="author" content="403 Forbidden">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="博客"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">博客</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/categories">分类</a></li>
      
        <li><a href="/about.html">关于</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    
  <article>

  
    
    <h3 class="article-title"><a href="/2017/03/11/PHP 无极分类生成树状数组/"><span>PHP 无极分类生成树状数组</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2017/03/11/PHP 无极分类生成树状数组/" rel="bookmark">
        <time class="entry-date published" datetime="2017-03-11T06:35:49.000Z">
          2017-03-11
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$arr=[</span><br><span class="line">   [<span class="string">'id'</span> =&gt; <span class="number">1</span>, <span class="string">'text'</span> =&gt; <span class="string">'Parent 1'</span>, <span class="string">'pid'</span> =&gt; <span class="number">0</span>],</span><br><span class="line">   [<span class="string">'id'</span> =&gt; <span class="number">2</span>, <span class="string">'text'</span> =&gt; <span class="string">'Parent 2'</span>, <span class="string">'pid'</span> =&gt; <span class="number">0</span>],</span><br><span class="line">   [<span class="string">'id'</span> =&gt; <span class="number">3</span>, <span class="string">'text'</span> =&gt; <span class="string">'Parent 3'</span>, <span class="string">'pid'</span> =&gt; <span class="number">0</span>],</span><br><span class="line">   [<span class="string">'id'</span> =&gt; <span class="number">4</span>, <span class="string">'text'</span> =&gt; <span class="string">'Child 1'</span>, <span class="string">'pid'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">   [<span class="string">'id'</span> =&gt; <span class="number">5</span>, <span class="string">'text'</span> =&gt; <span class="string">'Parent 4'</span>, <span class="string">'pid'</span> =&gt; <span class="number">0</span>],</span><br><span class="line">   [<span class="string">'id'</span> =&gt; <span class="number">6</span>, <span class="string">'text'</span> =&gt; <span class="string">'Child 2'</span>, <span class="string">'pid'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">   [<span class="string">'id'</span> =&gt; <span class="number">7</span>, <span class="string">'text'</span> =&gt; <span class="string">'Child 3'</span>, <span class="string">'pid'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">   [<span class="string">'id'</span> =&gt; <span class="number">8</span>, <span class="string">'text'</span> =&gt; <span class="string">'Parent 5'</span>, <span class="string">'pid'</span> =&gt; <span class="number">0</span>],</span><br><span class="line">   [<span class="string">'id'</span> =&gt; <span class="number">9</span>, <span class="string">'text'</span> =&gt; <span class="string">'Child 1'</span>, <span class="string">'pid'</span> =&gt; <span class="number">2</span>],</span><br><span class="line">   [<span class="string">'id'</span> =&gt; <span class="number">10</span>, <span class="string">'text'</span> =&gt; <span class="string">'Child 4'</span>, <span class="string">'pid'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">   [<span class="string">'id'</span> =&gt; <span class="number">11</span>, <span class="string">'text'</span> =&gt; <span class="string">'Child 1'</span>, <span class="string">'pid'</span> =&gt; <span class="number">5</span>],</span><br><span class="line">   [<span class="string">'id'</span> =&gt; <span class="number">12</span>, <span class="string">'text'</span> =&gt; <span class="string">'GrandChild 1'</span>, <span class="string">'pid'</span> =&gt; <span class="number">10</span>]</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">createTree</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $table = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">tree</span><span class="params">($pid = <span class="number">0</span>)</span> </span>&#123;</span><br><span class="line">        $tree = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">self</span>::$table <span class="keyword">as</span> $row) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($row[<span class="string">'pid'</span>] === $pid) &#123;</span><br><span class="line">                $tmp = <span class="keyword">self</span>::tree($row[<span class="string">'id'</span>]);</span><br><span class="line">                <span class="keyword">if</span> ($tmp) &#123;</span><br><span class="line">                    $row[<span class="string">'children'</span>] = $tmp;</span><br><span class="line">                &#125;</span><br><span class="line">                $tree[] = $row;                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $tree;        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($table)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">self</span>::$table = $table;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::tree();        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var_dump(createTree::get($arr));</span><br></pre></td></tr></table></figure>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2017/03/11/PHP 无极分类生成树状数组/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/12/27/一个简单的 MySQL 队列问题/"><span>一个简单的 MySQL 队列问题</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/12/27/一个简单的 MySQL 队列问题/" rel="bookmark">
        <time class="entry-date published" datetime="2016-12-26T23:47:23.000Z">
          2016-12-27
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>最近有个朋友要实现队列任务方面的工作，我们就 mysql(innodb) 的事务和锁的特性聊了一些有趣的话题。<br>其中，最终的解决方案来自大神 <a href="https://github.com/fengmk2" target="_blank" rel="noopener">https://github.com/fengmk2</a> 之前的一个队列实现。 我做了一个小改进，使得之前表级锁的表现可以恢复到行级锁水平。</p>
<p>任务的大致描述是这样的：<br>有一个表，里面存了很多的用户id，大概100w条，表的结构简化如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user_block_status &#123;</span><br><span class="line">  user_id <span class="built_in">bigint</span> // 用户的<span class="keyword">id</span></span><br><span class="line">  <span class="keyword">status</span> <span class="built_in">int</span> // 用户的状态。<span class="number">1</span> ok <span class="number">2</span> <span class="keyword">not</span> ok</span><br><span class="line">  updated_time <span class="keyword">timestamp</span> // 更新时间戳</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个表里面，每隔10秒就要去检查用户是否存在违规页面。如果存在的话，则需要把 status 置为 2，默认是 1。<br>有 100 个 worker 会并发地从表里面读取 user_id，所以我们要设计一个策略，使得这 100 个 worker 在并发时， 读到的是独立的 100 个条目。</p>
<p><strong>方案1</strong><br>一开始的方案是这样的：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// 这一句不一定会发请求，可能会优化成跟接下来的第一个 query 一起发出</span><br><span class="line">sql.begin_transaction</span><br><span class="line"></span><br><span class="line">// 第一次io发生。</span><br><span class="line">// 如果一个用户在 10s 内没有被更新，那么取出来</span><br><span class="line">// 这时候由于程序拿得到 user_id 的值，所以网络io是发生了的。否则拿不到 user_id 的值</span><br><span class="line">outdate_time = now() - 10s</span><br><span class="line">line = sql.query('<span class="keyword">select</span> user_id <span class="keyword">where</span> updated_time &lt; ? <span class="keyword">order</span> <span class="keyword">by</span> updated_time <span class="keyword">asc</span> <span class="keyword">limit</span> <span class="number">1</span><span class="string">', [outdate_time])</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// 第二次 io 发生</span></span><br><span class="line"><span class="string">// 更新这一行的 updated_time，免得被其他worker重复读取</span></span><br><span class="line"><span class="string">user_id = line.user_id</span></span><br><span class="line"><span class="string">sql.query('</span><span class="keyword">update</span> user_block_status <span class="keyword">set</span> updated_time=<span class="keyword">now</span>() <span class="keyword">where</span> user_id = ?<span class="string">',</span></span><br><span class="line"><span class="string">  [user_id])</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// 第三次 io 发生</span></span><br><span class="line"><span class="string">sql.commit</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// do something with user_id</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到，这个地方我们发起了 3 次 io 请求。当然，请求数不是很关键，因为请求数以及对应的时间是一个恒定量， 而随着 worker 的增加，这一块并不会带来额外的性能瓶颈。但由于我们使用了事务，所以当 worker 由 100 增加到 1000 的时候，数据库由于存在大量的事务操作，这些事务都需要掌握写锁，所以有潜在的写锁排队问题。<br>而且关键是，方案是不可行的，根本没有起到队列的效果。<br>为什么呢？我们假设网络io无限快，而数据库每条语句的执行时间是1s，那么我们这个事务的执行时间是 2s。 这时如果 3 个 worker 并发地在同一秒（00:00）执行，那么假设 worker1 读到的 user_id 是 10086， 由于读锁是共享的，worker2 和 worker3 读到的 user_id 也是 10086。这时他们三个都想要更新 10086 的值， 而 worker1 抢先加了写锁，所以 worker2 和 worker3 就需要等待 worker1 的事务执行完毕， 才能重新获得 10086 的写锁并进行写入。 所以当 worker2 执行的时候，是 00:02 的时候，当 worker3 执行的时候，是 00:04 的时刻。 而且由于他们都是在对 10086 进行更新，所以没有起到队列的效果。<br>这里的查询条件太特殊，导致所有并发的事务需要的都是同一条数据， 这时候 innodb 行级锁的特性也没有发挥出来。<br>这个方案不仅并发时的表现类似表级锁的特性，而且也没有达到队列的效果。</p>
<p><strong>方案2</strong><br>将 update 语句在先，select 语句在后。<br>update 语句改成<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">outdate_time = now() - 10s</span><br><span class="line">result = sql.query('<span class="keyword">update</span> user_block_status <span class="keyword">set</span> updated_time=<span class="keyword">now</span>() <span class="keyword">where</span> updated_time &lt; ?   <span class="keyword">order</span> <span class="keyword">by</span> updated_time <span class="keyword">asc</span> <span class="keyword">limit</span> <span class="number">1</span><span class="string">',</span></span><br><span class="line"><span class="string">  [outdate_time])</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## each worker can get different result.user_id</span></span><br></pre></td></tr></table></figure></p>
<p>这样在 update 的时候，3 个 worker 会排队，分别更新不同的 user_id 条目。然后返回来的 也是不同的 user_id。<br>可关键是，update 语句并不会将被 update 了的 id 返回给程序，所以我们后面的 select 语句拿不到对应的 user_id。 这个方案先否决。</p>
<p><strong>方案3</strong><br>方案1的基础上，在 select 语句中，手工地干扰一下，使得不同的 worker 取到不同的条目<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">outdate_time = now() - 10s</span><br><span class="line">random_number = random_int(0, worker_count * 2)</span><br><span class="line">line = sql.query('<span class="keyword">select</span> user_id <span class="keyword">where</span> updated_time &lt; ?  <span class="keyword">order</span> <span class="keyword">by</span> updated_time <span class="keyword">asc</span> <span class="keyword">limit</span> <span class="number">1</span> <span class="keyword">offset</span> ?<span class="string">',</span></span><br><span class="line"><span class="string">  [outdate_time, random_number])</span></span><br></pre></td></tr></table></figure></p>
<p>这时，我们的 worker 有很大的几率可以取出不同 user_id。但这里也还有个问题就是，很可能两个 worker 的 random_number 是同一个值。那么就发生了两次重复读取，不过对于我们的业务来说，重复读取只会造成资源的浪费， 而不会带来数据一致性的问题。只要尽量减少重复读的几率，那么这个方案就是可被接受的。<br>其中 worker_count * 2 是拍脑袋决定的数，如果数据库中始终有大量需要处理的数据，可以加大点。</p>
<p><strong>方案4</strong><br>方案3还是挺不完美的，虽然能解决问题，但是从概念上来说，我们需要的是队列。 队列的意思就是：排队！排队！排队！<br>方案3只是从业务逻辑层面出发，做出了一些规避，模拟了我们需要的效果。<br>那么回到方案2，其实方案2是更接近队列的。因为不同的 worker 真正在等待另一个 worker 更新东西。 可方案2无奈的是，我们拿不到被更新的id。那么有没有办法拿到呢？<br>其实是有的，用 mysql 的 LAST_INSERT_ID() 函数。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LAST_INSERT_ID(): Value of the AUTOINCREMENT column for the last <span class="keyword">INSERT</span></span><br></pre></td></tr></table></figure></p>
<p>关于这个函数可以看看 <a href="https://dev.mysql.com/doc/refman/5.7/en/information-functions.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/information-functions.html</a> 这里的详细介绍。<br>这个函数本来的含义是，拿到 AUTO_INCREMENT 那一列的最新值。也就是我们最新 insert 进表的那个 id。 但实际上，它也可以作为一个 sql 语句中的变量来使用，它可以被赋值，然后取出。 而且它的作用域是同一 connection 内，这样我们多个 worker 如果对 LAST_INSERT_ID 赋了不同的值， 也不会互相干扰，因为不同的 worker 使用不同的 connection。<br>这时，我们的查询在方案2的基础上就变成：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sql.begin_transaction</span><br><span class="line"></span><br><span class="line">outdate_time = now() - 10s</span><br><span class="line">sql.query('<span class="keyword">update</span> user_block_status <span class="keyword">set</span> updated_time=<span class="keyword">now</span>()，</span><br><span class="line"> <span class="keyword">id</span>=<span class="keyword">LAST_INSERT_ID</span>(<span class="keyword">id</span>) <span class="keyword">where</span> updated_time &lt; ?  <span class="keyword">order</span> <span class="keyword">by</span> updated_time <span class="keyword">asc</span> <span class="keyword">limit</span> <span class="number">1</span><span class="string">',</span></span><br><span class="line"><span class="string">  [outdate_time])</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">line = sql.query('</span><span class="keyword">select</span> user_id <span class="keyword">where</span> <span class="keyword">id</span> = <span class="keyword">LAST_INSERT_ID</span>()<span class="string">')</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## do sth with line.user_id</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">sql.commit</span></span><br></pre></td></tr></table></figure></p>
<p>ok，已经能排队了，业务上已经可以满足了。<br>目前性能上说，网络io还是三个，而且，【行级锁】没有被利用的特定依然存在。 写锁依然要排队，为什么这么说？因为不管 worker 有多少个，当他们并发的时候，where 条件都始终把它们 指向同一行数据，所以还是要为了同一行数据排队。即使目前我们已经达成了【排队之后，互相更新不同条目】这个目的。<br>方案4就总的性价比来说，目前跟方案3相比，还不一定谁好谁坏。 方案4的性能在于多个worker抢一个锁，大家总是等；方案3是无脑乱取，造成资源浪费，降低worker的效率，浪费机器。<br>什么情况下方案3好？ 如果总是有一大堆数据没有被处理的话，那么把方案3的乱取范围开大点，就能更好避免浪费。 而当一大堆数据等待处理的时候，方案4却不停在排队，这就等于堵住了。<br>还有一种情况就是，方案4的写锁排队已经成为瓶颈。但其实这跟上面是一回事，当总是有一大堆 worker 来取 东西的话，说明就是有一大堆数据没有被处理。否则开那么多 worker 干嘛。<br>什么情况下方案4好？ 前提就是，写锁排队并不成为瓶颈。如果要处理的数据并不是那么多，那么使用方案4的话，可以降低我们需要的 worker 数量，节约机器。 而且 worker 数量评估可以更加理性。</p>
<p><strong>方案5</strong><br>那么，我们把方案3的 offset 思想加进来吧。可惜啊可惜，update 语法只支持 limit，不支持 offset。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> [<span class="keyword">LOW_PRIORITY</span>] [<span class="keyword">IGNORE</span>] table_reference</span><br><span class="line">    <span class="keyword">SET</span> col_name1=&#123;expr1|<span class="keyword">DEFAULT</span>&#125; [, col_name2=&#123;expr2|<span class="keyword">DEFAULT</span>&#125;] ...</span><br><span class="line">    [<span class="keyword">WHERE</span> where_condition]</span><br><span class="line">    [<span class="keyword">ORDER</span> <span class="keyword">BY</span> ...]</span><br><span class="line">    [<span class="keyword">LIMIT</span> <span class="keyword">row_count</span>]</span><br></pre></td></tr></table></figure></p>
<p>那就绕一绕。<br>不用 offset，而是通过更改 outdate_time 的值，让他们获得不同的行数据。<br>我们的程序是要求 10s 算作过期，那么 11s、20s、30s 肯定也算过期吧。那就这样写：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 在 10 到 30s 之间随机取值</span><br><span class="line">outdate_time = now() - (random(10, 30))s</span><br><span class="line">sql.query('<span class="keyword">update</span> user_block_status <span class="keyword">set</span> updated_time=<span class="keyword">now</span>()，</span><br><span class="line"> <span class="keyword">id</span>=<span class="keyword">LAST_INSERT_ID</span>(<span class="keyword">id</span>) <span class="keyword">where</span> updated_time &lt; ?  <span class="keyword">order</span> <span class="keyword">by</span> updated_time <span class="keyword">asc</span>  <span class="keyword">limit</span> <span class="number">1</span><span class="string">',</span></span><br><span class="line"><span class="string">  [outdate_time])</span></span><br><span class="line"><span class="string">where updated_time &lt; now() - 10s 与 where updated_time &lt; now() - 12s 与 where updated_time &lt; now() - 15s</span></span><br><span class="line"><span class="string">//（不要在 where 条件里面写计算，这只是示例） 还是有可能锁定同一条数据。但至少，这个方案既利用上了行级锁，也不会造成多个 worker 处理同一 user_id 的 资源浪费。</span></span><br></pre></td></tr></table></figure></p>
<p><strong>方案6</strong><br>锁的问题差不多就这么解决了。<br>我们再回头看看，发现还有个 io 问题可以再弄弄。现在还是 3 个 io 嘛。<br>其实到了现在这步，begin_transaction 可以去掉了。因为我们只有一个涉及写锁的操作在里面，这个操作本身作为单一语句， 就已经是原子性的了。<br>但由于我们利用了 LAST_INSERT_ID，所以我们要保证 update 语句和它之后的 select 语句在同一个 connection 中。<br>很多的 mysql 库实现都是用了连接池的，所以同一段代码中的两条 sql 有可能会利用两条 connection， 导致得到我们非预期的 user_id。<br>但就我们的业务来说，LAST_INSERT_ID 混了其实是没关系的。每个 worker 始终还是会得到一个 unique 的 user_id。 这就够了。那么我们也不必加一些多余的逻辑，保证这两条语句取到同一个 connection。<br>这时，io 操作从 3，降低到了 2。<br>那么，有没有可能降到 1 呢。<br>其实也可以啊…………因为基本所有 mysql 库都支持 multistatements 特性。<br>我们可以在一条 query 写两个语句，返回接口会是一个数组，分别表示这两个语句的值。<br>类似这样，sql.query(‘update …..; select ….;’)。这是支持的。而且这么一来， 同一 connection 的问题也解决了。避免为以后留坑。<br>重写方案<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">outdate_time = now() - (random(10, 30))s</span><br><span class="line">result = sql.query('<span class="keyword">update</span> user_block_status <span class="keyword">set</span> updated_time=<span class="keyword">now</span>()，</span><br><span class="line"> user_id=<span class="keyword">LAST_INSERT_ID</span>(user_id) <span class="keyword">where</span> updated_time &lt; ?  <span class="keyword">order</span> <span class="keyword">by</span> updated_time <span class="keyword">asc</span> <span class="keyword">limit</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">select</span> * <span class="keyword">from</span> user_block_status <span class="keyword">where</span> user_id = <span class="keyword">LAST_INSERT_ID</span>()<span class="string">',</span></span><br><span class="line"><span class="string">  [outdate_time])</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// do something with result[1].user_id</span></span><br></pre></td></tr></table></figure></p>
<p>。。。。。。。。。。。。。<br>还是有坑的。。。。。。。。。。。。。。。<br>如果 where updated_time &lt; ? 一条都不命中，那么会发生什么结果？<br>首先，update 没有改变任何行。而 LAST_INSERT_ID 还是会返回一个合理的 id，有可能是真正的 LAST_INSERT_ID， 也可能是这条 connection 中上次手工设置的。<br>在这里可以多说一下 LAST_INSERT_ID 的特性。默认情况下，LAST_INSERT_ID() 不带参数会返回最新插入那条的 id。 带参数的情况下 LAST_INSERT_ID(id) 本身的返回值就是参数，然后在接下来的调用中，如果不发生任何 insert，那么 值会在 connection 中一直保持。如果发生了 insert，就会被更新。<br>如果不处理这个 update nothing 的异常情况，当队列全部被处理完的时候， 我们的 worker 会一直工作，不会停下来。所以我们要在取 LAST_INSERT_ID 的值时， 判断一下上一条 update 语句到底有没有发生作用。<br>这时候我们需要用到另一个跟 LAST_INSERT_ID 一起出现在文档中的函数，<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROW_COUNT(): The number of rows updated</span><br></pre></td></tr></table></figure></p>
<p>判断一下 ROW_COUNT，如果是 0 的话，就条件不符，这时候我们在程序里面拿到的值就是空。<br>最终方案<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">outdate_time = now() - (random(10, 30))s</span><br><span class="line">result = sql.query('<span class="keyword">update</span> user_block_status <span class="keyword">set</span> updated_time=<span class="keyword">now</span>()，</span><br><span class="line">  user_id=<span class="keyword">LAST_INSERT_ID</span>(user_id) <span class="keyword">where</span> updated_time &lt; ?  <span class="keyword">order</span> <span class="keyword">by</span> updated_time <span class="keyword">asc</span> <span class="keyword">limit</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">select</span> * <span class="keyword">from</span> user_block_status <span class="keyword">where</span> user_id = <span class="keyword">LAST_INSERT_ID</span>()</span><br><span class="line">    <span class="keyword">and</span> <span class="keyword">ROW_COUNT</span>() &lt;&gt; <span class="number">0</span><span class="string">',</span></span><br><span class="line"><span class="string">  [outdate_time])</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// do something with result[1].user_id</span></span><br></pre></td></tr></table></figure></p>
<p>当然，mysql 用来解决这种队列问题可能不是一个好的方案。队列相关的知识，我还在努力学习中。<br>参考资料：</p>
<ul>
<li><a href="http://www.cnblogs.com/zhoujinyi/p/3437475.html" target="_blank" rel="noopener">http://www.cnblogs.com/zhoujinyi/p/3437475.html</a></li>
</ul>
<ul>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/information-functions.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/information-functions.html</a></li>
</ul>
<p>转载自 <a href="https://ruby-china.org/topics/27814" target="_blank" rel="noopener">https://ruby-china.org/topics/27814</a></p>
<p>附：虽然用的是 ruby 语言，但其中最关键的还是 sql 语句。最近做个基于 laravel 的应用中使用到了队列的概念，因为对并发要求不高，所以直接用了 MariaDB，记下源码留作备用：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">api</span>\<span class="title">v1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">DB</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">server</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(Request $request)</span> </span>&#123;</span><br><span class="line">        $inputFilters = [</span><br><span class="line">            <span class="string">"gid"</span> =&gt; [<span class="string">"filter"</span> =&gt; FILTER_VALIDATE_INT, <span class="string">"options"</span> =&gt; [<span class="string">'min_range'</span> =&gt; <span class="number">1</span>]],</span><br><span class="line">            <span class="string">"sid"</span> =&gt; [<span class="string">"filter"</span> =&gt; FILTER_VALIDATE_INT, <span class="string">"options"</span> =&gt; [<span class="string">'min_range'</span> =&gt; <span class="number">1</span>]]</span><br><span class="line">        ];</span><br><span class="line">        $inputData = $request-&gt;all();</span><br><span class="line">        $insertData = filter_var_array($inputData, $inputFilters);</span><br><span class="line">        <span class="keyword">foreach</span> ($insertData <span class="keyword">as</span> $value) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!$value) &#123;</span><br><span class="line">                <span class="keyword">return</span> response()-&gt;json([<span class="string">"errno"</span> =&gt; <span class="number">-1</span>], <span class="number">500</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        DB::table(<span class="string">'srv'</span>)</span><br><span class="line">            -&gt;where([</span><br><span class="line">                [<span class="string">'conf'</span>, <span class="string">'='</span>, $insertData[<span class="string">"gid"</span>]],</span><br><span class="line">                [<span class="string">'state'</span>, <span class="string">'='</span>, <span class="string">'0'</span>],</span><br><span class="line">                [<span class="string">'power'</span>, <span class="string">'='</span>, <span class="string">'0'</span>]</span><br><span class="line">            ])</span><br><span class="line">            -&gt;orderBy(<span class="string">'id'</span>, <span class="string">'desc'</span>)</span><br><span class="line">            -&gt;take(<span class="number">1</span>)</span><br><span class="line">            -&gt;update([</span><br><span class="line">                <span class="string">'state'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">                <span class="string">'power'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">                <span class="string">'sid'</span> =&gt; $insertData[<span class="string">"sid"</span>],</span><br><span class="line">                <span class="string">'id'</span> =&gt; DB::raw(<span class="string">'LAST_INSERT_ID(id)'</span>)</span><br><span class="line">            ]);</span><br><span class="line">        $data = DB::table(<span class="string">'srv'</span>)</span><br><span class="line">                    -&gt;where([</span><br><span class="line">                        [<span class="string">'id'</span>, <span class="string">'='</span>, DB::raw(<span class="string">'LAST_INSERT_ID()'</span>)],</span><br><span class="line">                        [DB::raw(<span class="string">'ROW_COUNT()'</span>), <span class="string">'&lt;&gt;'</span>, <span class="number">0</span>]</span><br><span class="line">                    ])</span><br><span class="line">                    -&gt;first();</span><br><span class="line">        <span class="keyword">if</span> (!$data) &#123;</span><br><span class="line">            <span class="keyword">return</span> response()-&gt;json([<span class="string">"errno"</span> =&gt; <span class="number">-2</span>], <span class="number">500</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> response()-&gt;json([<span class="string">"errno"</span> =&gt; <span class="number">0</span>, <span class="string">"data"</span> =&gt; $data]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/12/27/一个简单的 MySQL 队列问题/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/12/23/jQuery(selector).html() 过滤 script tag 的解决方法/"><span>jQuery(selector).html() 过滤 script tag 的解决方法</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/12/23/jQuery(selector).html() 过滤 script tag 的解决方法/" rel="bookmark">
        <time class="entry-date published" datetime="2016-12-23T09:59:20.000Z">
          2016-12-23
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>　　之前用 pjax 做个项目，使用了 .html() 方法将获取到的数据插入 container。但是却发现其会自动过滤 script tag，现找到解决方法 (<a href="http://stackoverflow.com/questions/4079179/jquery-html-strips-out-script-tags" target="_blank" rel="noopener">jquery html() strips out script tags</a>)，在此记录一下<br>　　以下是我应用到项目里的部分代码，对 stackoverflow 的答案多进行了一次判断<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).on(<span class="string">"pjax:end"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event, data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> responseDom = $(data.responseText);</span><br><span class="line">    <span class="keyword">if</span> (!$(event.target).filter(<span class="string">"script"</span>).length) &#123;</span><br><span class="line">        responseDom.filter(<span class="string">'script'</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.src) &#123;</span><br><span class="line">                <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>), i, attrName, attrValue, attrs = <span class="keyword">this</span>.attributes;</span><br><span class="line">                <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; attrs.length; i++) &#123;</span><br><span class="line">                    attrName = attrs[i].name;</span><br><span class="line">                    attrValue = attrs[i].value;</span><br><span class="line">                    script[attrName] = attrValue;</span><br><span class="line">                &#125;</span><br><span class="line">                event.target.appendChild(script);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $.globalEval(<span class="keyword">this</span>.text || <span class="keyword">this</span>.textContent || <span class="keyword">this</span>.innerHTML || <span class="string">''</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/12/23/jQuery(selector).html() 过滤 script tag 的解决方法/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/10/27/安装 Laravel，撞墙，采用 Packageist 的中国镜像/"><span>安装 Laravel，撞墙，采用 Packageist 的中国镜像</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/10/27/安装 Laravel，撞墙，采用 Packageist 的中国镜像/" rel="bookmark">
        <time class="entry-date published" datetime="2016-10-26T19:11:00.000Z">
          2016-10-27
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>参考：</p>
<ul>
<li><a href="https://laravel.com/docs/5.2" target="_blank" rel="noopener">https://laravel.com/docs/5.2</a> – 英文手册</li>
</ul>
<ul>
<li><a href="http://laravel-china.org/docs/5.1" target="_blank" rel="noopener">http://laravel-china.org/docs/5.1</a> – 中文手册</li>
</ul>
<ul>
<li><a href="http://pkg.phpcomposer.com/" target="_blank" rel="noopener">http://pkg.phpcomposer.com/</a> – Packagist / Composer 中国全量镜像内（绕过垃圾的墙）</li>
</ul>
<p><strong>安装 Laravel，创建 blog 项目</strong><br>安装方法有两种：</p>
<ol>
<li>全局安装 Laravel Installer，然后用下面的指令创建新项目： laravel new blog</li>
</ol>
<ol start="2">
<li>不安装啥，直接用 Composer 创建新项目：composer create-project –prefer-dist laravel/laravel blog</li>
</ol>
<p>看起来第一种方案比较好，然而：<br>！说明！由于墙的存在，全局安装 Laravel Installer 的方案可能不会成功。</p>
<p><strong>全局安装 Laravel Installer</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer global require "laravel/installer"</span><br></pre></td></tr></table></figure></p>
<p><strong>执行命令</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">laravel new blog</span><br></pre></td></tr></table></figure></p>
<p>悲剧了，出现错误：<br>cURL error 7: Failed to connect to cabinet.laravel.com port 80: Timed out……<br>直接用 Composer 创建 Laravel 项目</p>
<p>参照网上的方案，先执行加速 composer 的执行（用国内的镜像，好人呐！）：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer config -g repo.packagist composer https://packagist.phpcomposer.com</span><br></pre></td></tr></table></figure></p>
<p>然后执行<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer global require "laravel/installer"</span><br></pre></td></tr></table></figure></p>
<p>创建项目</p>
<p>转载自 <a href="http://blog.sina.com.cn/s/blog_6262a50e0102ws9z.html" target="_blank" rel="noopener">http://blog.sina.com.cn/s/blog_6262a50e0102ws9z.html</a>，有删改</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/10/27/安装 Laravel，撞墙，采用 Packageist 的中国镜像/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/10/23/CentOS 7 grub Linux 修改默认的启动操作系统/"><span>CentOS 7 grub Linux 修改默认的启动操作系统</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/10/23/CentOS 7 grub Linux 修改默认的启动操作系统/" rel="bookmark">
        <time class="entry-date published" datetime="2016-10-23T07:36:42.000Z">
          2016-10-23
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>可以用下面的方法修改grub默认的启动OS。</p>
<p><strong>查看当前的启动内核</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# grub2-editenvlist</span><br><span class="line">saved_entry=CentOS Linux(3.10.0-123.20.1.el7.x86_64) 7 (Core)</span><br></pre></td></tr></table></figure></p>
<p><strong>查找要默认启动的操作系统名字</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cat /etc/grub2.cfg | grep 3.4.44</span><br><span class="line">menuentry &apos;CentOS Linux (3.4.44) 7(Core)&apos; --class centos --class gnu-linux --class gnu --class os--unrestricted $menuentry_id_option&apos;gnulinux-3.10.0-123.el7.x86_64-advanced-e3146a2a-a237-4081-ba08-dbf258de434a&apos;&#123;</span><br><span class="line">        linux16 /vmlinuz-3.4.44 root=/dev/mapper/centos-rootro rd.lvm.lv=centos/swap vconsole.font=latarcyrheb-sun16 rd.lvm.lv=centos/rootcrashkernel=auto  vconsole.keymap=us rhgbquiet LANG=en_US.UTF-8</span><br><span class="line">        initrd16 /initramfs-3.4.44.img</span><br></pre></td></tr></table></figure></p>
<p><strong>设置新的默认启动操作系统选项</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# grub2-set-default  &quot;CentOSLinux (3.4.44) 7 (Core)&quot;</span><br></pre></td></tr></table></figure></p>
<p><strong>查看是否生效</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# grub2-editenv list</span><br><span class="line">saved_entry=CentOS Linux (3.4.44) 7 (Core)</span><br></pre></td></tr></table></figure></p>
<p>转载自 <a href="http://blog.csdn.net/wjw7869/article/details/47302107" target="_blank" rel="noopener">http://blog.csdn.net/wjw7869/article/details/47302107</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/VPS-技术/">VPS 技术</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/10/23/CentOS 7 grub Linux 修改默认的启动操作系统/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/09/10/CentOS 7 主机名的修改/"><span>CentOS 7 主机名的修改</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/09/10/CentOS 7 主机名的修改/" rel="bookmark">
        <time class="entry-date published" datetime="2016-09-10T09:58:55.000Z">
          2016-09-10
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>如何在CentOS 7上修改主机名</p>
<p>在CentOS中，有三种定义的主机名:静态的（static），瞬态的（transient），和灵活的（pretty）。“静态”主机名也称为内核主机名，是系统在启动时从/etc/hostname自动初始化的主机名。“瞬态”主机名是在系统运行时临时分配的主机名，例如，通过DHCP或mDNS服务器分配。静态主机名和瞬态主机名都遵从作为互联网域名同样的字符限制规则。而另一方面，“灵活”主机名则允许使用自由形式（包括特殊/空白字符）的主机名，以展示给终端用户（如Linuxidc）。</p>
<p>在CentOS 7中，有个叫hostnamectl的命令行工具，它允许你查看或修改与主机名相关的配置。</p>
<p>1.要查看主机名相关的设置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# hostnamectl  </span><br><span class="line"></span><br><span class="line">  Static hostname: localhost.localdomain</span><br><span class="line">        Icon name: computer</span><br><span class="line">          Chassis: n/a</span><br><span class="line">        Machine ID: 80a4fa4970614cf6be9597ecd6f097a9</span><br><span class="line">          Boot ID: 28420e272e1847a583718262758bd0f7</span><br><span class="line">    Virtualization: vmware</span><br><span class="line">  Operating System: CentOS Linux 7 (Core)</span><br><span class="line">      CPE OS Name: cpe:/o:centos:centos:7</span><br><span class="line">            Kernel: Linux 3.10.0-123.el7.x86_64</span><br><span class="line">      Architecture: x86_64</span><br></pre></td></tr></table></figure></p>
<p>或</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# hostnamectl status</span><br><span class="line">  Static hostname: localhost.localdomain</span><br><span class="line">        Icon name: computer</span><br><span class="line">          Chassis: n/a</span><br><span class="line">        Machine ID: 80a4fa4970614cf6be9597ecd6f097a9</span><br><span class="line">          Boot ID: 28420e272e1847a583718262758bd0f7</span><br><span class="line">    Virtualization: vmware</span><br><span class="line">  Operating System: CentOS Linux 7 (Core)</span><br><span class="line">      CPE OS Name: cpe:/o:centos:centos:7</span><br><span class="line">            Kernel: Linux 3.10.0-123.el7.x86_64</span><br><span class="line">      Architecture: x86_64</span><br></pre></td></tr></table></figure>
<p>2.只查看静态、瞬态或灵活主机名，分别使用“–static”，“–transient”或“–pretty”选项。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# hostnamectl --static</span><br><span class="line">localhost.localdomain</span><br><span class="line">[root@localhost ~]# hostnamectl --transient</span><br><span class="line">localhost.localdomain</span><br><span class="line">[root@localhost ~]# hostnamectl --pretty</span><br></pre></td></tr></table></figure></p>
<p>3.要同时修改所有三个主机名：静态、瞬态和灵活主机名：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# hostnamectl set-hostname Linuxidc</span><br><span class="line">[root@localhost ~]# hostnamectl --pretty</span><br><span class="line">Linuxidc</span><br><span class="line">[root@localhost ~]# hostnamectl --static</span><br><span class="line">Linuxidc</span><br><span class="line">[root@localhost ~]# hostnamectl --transient</span><br><span class="line">Linuxidc</span><br></pre></td></tr></table></figure></p>
<p>就像上面展示的那样，在修改静态/瞬态主机名时，任何特殊字符或空白字符会被移除，而提供的参数中的任何大写字母会自动转化为小写。一旦修改了静态主机名，/etc/hostname 将被自动更新。然而，/etc/hosts 不会更新以保存所做的修改，所以你每次在修改主机名后一定要手动更新/etc/hosts，之后再重启CentOS 7。否则系统再启动时会很慢。</p>
<p>4.手动更新/etc/hosts<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line"></span><br><span class="line">127.0.0.1      Linuxidc  hunk_zhu</span><br><span class="line">#127.0.0.1  localhost localhost.localdomain localhost4 localhost4.localdomain</span><br><span class="line">::1        localhost localhost.localdomain localhost6 localhost6.localdomai</span><br></pre></td></tr></table></figure></p>
<p>5.重启CentOS 7 之后（reboot -f ），<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@Linuxidc ~]# hostname</span><br><span class="line">Linuxidc</span><br><span class="line">[root@hunk_zhu ~]# hostnamectl --transient </span><br><span class="line">Linuxidc</span><br><span class="line">[root@hunk_zhu ~]# hostnamectl --static</span><br><span class="line">Linuxidc</span><br><span class="line">[root@hunk_zhu ~]# hostnamectl --pretty</span><br><span class="line">Linuxidc</span><br></pre></td></tr></table></figure></p>
<p>6.如果你只想修改特定的主机名（静态，瞬态或灵活），你可以使用“–static”，“–transient”或“–pretty”选项。<br>例如，要永久修改主机名，你可以修改静态主机名：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# hostnamectl --static set-hostname Linuxidc</span><br><span class="line">重启CentOS 7 之后（reboot -f ），</span><br><span class="line">[root@Linuxidc ~]# hostnamectl --static</span><br><span class="line">Linuxidc</span><br><span class="line">[root@Hunk_zhu ~]# hostnamectl --transient</span><br><span class="line">Linuxidc</span><br><span class="line">[root@Hunk_zhu ~]# hostnamectl --pretty</span><br><span class="line">Linuxidc</span><br><span class="line">[root@Hunk_zhu ~]# hostname</span><br></pre></td></tr></table></figure></p>
<p>其实，你不必重启机器以激活永久主机名修改。上面的命令会立即修改内核主机名。注销并重新登入后在命令行提示来观察新的静态主机名。</p>
<p>转载自 <a href="http://www.linuxidc.com/Linux/2014-11/109238.htm" target="_blank" rel="noopener">http://www.linuxidc.com/Linux/2014-11/109238.htm</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/VPS-技术/">VPS 技术</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/09/10/CentOS 7 主机名的修改/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/09/10/编译wndr4300 openwrt 15.05固件/"><span>编译wndr4300 openwrt 15.05固件</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/09/10/编译wndr4300 openwrt 15.05固件/" rel="bookmark">
        <time class="entry-date published" datetime="2016-09-10T06:59:05.000Z">
          2016-09-10
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>为wndr4300编译openwrt 15.05系统，内容如下:</p>
<p>操作环境 ubuntu 14.04 64位</p>
<ol>
<li><p>安装依赖包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install subversion build-essential libncurses5-dev zlib1g-dev gawk git ccache gettext libssl-dev xsltproc</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载源码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /home</span><br><span class="line">git clone git://git.openwrt.org/15.05/openwrt.git</span><br><span class="line">cd openwrt</span><br><span class="line">git checkout 15.05</span><br><span class="line">./scripts/feeds update -a</span><br><span class="line">./scripts/feeds install luci</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译 获取官方配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://downloads.openwrt.org/chaos_calmer/15.05/ar71xx/nand/config.diff</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>将 config.diffg 文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_TARGET_ar71xx_nand_R6100=y</span><br></pre></td></tr></table></figure></p>
<p>修改为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_TARGET_ar71xx_nand_WNDR4300=y</span><br></pre></td></tr></table></figure></p>
<p>生成配置<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat config.diff &gt;&gt; .config</span><br><span class="line">make defconfig</span><br></pre></td></tr></table></figure></p>
<p>修改 /root 为128MB<br>修改 target/linux/ar71xx/image/Makefile 文件, 修改 wndr4300_mtdlayout 中 23552k(ubi) 为 120832k(ubi)， 25600k@0x6c0000(firmware) 为 122880k@0x6c0000(firmware)</p>
<p>也可以使用配置向导<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></table></figure></p>
<p>运行编译<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make V=99</span><br></pre></td></tr></table></figure></p>
<ol start="4">
<li>生成文件位置<br>最后文件生成在 bin 目录下： openwrt/bin/ar71xx/openwrt-15.05-ar71xx-nand-wndr4300-squashfs-sysupgrade.tar openwrt/bin/ar71xx/openwrt-15.05-ar71xx-nand-wndr4300-ubi-factory.img</li>
</ol>
<p>转载自 <a href="http://www.jayclub.net/make-wndr4300-openwrt-15-05.html" target="_blank" rel="noopener">http://www.jayclub.net/make-wndr4300-openwrt-15-05.html</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/openwrt/">openwrt</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/09/10/编译wndr4300 openwrt 15.05固件/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/08/09/针对 bs 的 collapse 写了个添加项的 func/"><span>针对 bs 的 collapse 写了个添加项的 func</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/08/09/针对 bs 的 collapse 写了个添加项的 func/" rel="bookmark">
        <time class="entry-date published" datetime="2016-08-09T09:42:58.000Z">
          2016-08-09
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>最近在做个项目，用到了 bs 的 collapse，模拟了 select 的操作。但是其中选择的项不是很方便更改，于是写了个 function 来更改其中的 li。在这做个笔记，避免日后忘记，大神见笑。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> createPanel=<span class="function"><span class="keyword">function</span>(<span class="params">to,id,title,lis</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> collapseIn=<span class="keyword">typeof</span> <span class="built_in">arguments</span>[<span class="number">4</span>]!==<span class="string">"undefined"</span>?<span class="built_in">arguments</span>[<span class="number">4</span>]:$(<span class="string">"#"</span>+to+<span class="string">" .panel"</span>).length?<span class="number">1</span>:<span class="number">0</span>;</span><br><span class="line">    $(<span class="string">"#"</span>+to).append($(<span class="string">'&lt;div class="panel panel-default" id="panel_'</span>+to+<span class="string">'_'</span>+id+<span class="string">'"&gt;&lt;div class="panel-heading" role="tab" id="heading_'</span>+to+<span class="string">'_'</span>+id+<span class="string">'"&gt;&lt;h4 class="panel-title"&gt;&lt;a'</span>+(collapseIn?<span class="string">''</span>:<span class="string">' class="collapsed"'</span>)+<span class="string">' role="button" data-toggle="collapse" data-parent="#'</span>+to+<span class="string">'" href="#collapse_'</span>+to+<span class="string">'_'</span>+id+<span class="string">'" aria-expanded="'</span>+(collapseIn?<span class="string">'false'</span>:<span class="string">'true'</span>)+<span class="string">'" aria-controls="collapse_'</span>+to+<span class="string">'_'</span>+id+<span class="string">'"&gt;'</span>+title+<span class="string">'&lt;/a&gt;&lt;/h4&gt;&lt;/div&gt;&lt;div id="collapse_'</span>+to+<span class="string">'_'</span>+id+<span class="string">'" class="panel-collapse collapse'</span>+(collapseIn?<span class="string">''</span>:<span class="string">' in'</span>)+<span class="string">'" role="tabpanel" aria-labelledby="heading_'</span>+to+<span class="string">'_'</span>+id+<span class="string">'"&gt;&lt;ul class="list-group"&gt;'</span>+((<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">var</span> op=<span class="string">""</span>; <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> lis) &#123; op+=<span class="string">'&lt;li class="list-group-item" data-menuid="'</span>+i+<span class="string">'"&gt;'</span>+lis[i]+<span class="string">'&lt;/li&gt;'</span>; &#125; <span class="keyword">return</span> op; &#125;)())+<span class="string">'&lt;/ul&gt;&lt;/div&gt;&lt;/div&gt;'</span>));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>用法：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mixed createPanel ( string appendToDomId, mixed panelId, mixed title, object liData, [ bool collapseIn ] )</span><br></pre></td></tr></table></figure></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-group"</span> <span class="attr">id</span>=<span class="string">"subject"</span> <span class="attr">role</span>=<span class="string">"tablist"</span> <span class="attr">aria-multiselectable</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">createPanel(<span class="string">"subject"</span>,<span class="number">0</span>,<span class="string">"学科1"</span>,&#123;<span class="number">1</span>:<span class="string">"Chinese"</span>,<span class="number">2</span>:<span class="string">"English"</span>,<span class="number">3</span>:<span class="string">"German"</span>&#125;,<span class="literal">true</span>);</span><br><span class="line">createPanel(<span class="string">"subject"</span>,<span class="string">"1"</span>,<span class="string">"学科2"</span>,&#123;<span class="number">1</span>:<span class="string">"Physics"</span>,<span class="number">2</span>:<span class="string">"Economics"</span>&#125;);</span><br></pre></td></tr></table></figure>
<p>我不忍吐槽 bs 的文档，汉化根本不完全。。。这是原文档链接 <a href="http://v3.bootcss.com/javascript/#collapse" target="_blank" rel="noopener">http://v3.bootcss.com/javascript/#collapse</a>。嗯，就这样吧。。。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/08/09/针对 bs 的 collapse 写了个添加项的 func/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/07/25/iptables防火墙规则的添加、删除、修改、保存/"><span>iptables防火墙规则的添加、删除、修改、保存</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/07/25/iptables防火墙规则的添加、删除、修改、保存/" rel="bookmark">
        <time class="entry-date published" datetime="2016-07-24T19:08:02.000Z">
          2016-07-25
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>本文介绍iptables这个Linux下最强大的防火墙工具，包括配置iptables三个链条的默认规则、添加iptables规则、修改规则、删除规则等。</p>
<p><strong>一、查看规则集</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables --list -n // 加一个-n以数字形式显示IP和端口，看起来更舒服</span><br></pre></td></tr></table></figure></p>
<p><strong>二、配置默认规则</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -P INPUT DROP  // 不允许进</span><br><span class="line">iptables -P FORWARD DROP  // 不允许转发</span><br><span class="line">iptables -P OUTPUT ACCEPT  // 允许出</span><br></pre></td></tr></table></figure></p>
<p><strong>三、增加规则</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s 192.168.0.0/24 -j ACCEPT</span><br><span class="line">//允许源IP地址为192.168.0.0/24网段的包流进（包括所有的协议，这里也可以指定单个IP）</span><br><span class="line">iptables -A INPUT -d 192.168.0.22 -j ACCEPT</span><br><span class="line">//允许所有的IP到192.168.0.22的访问</span><br><span class="line">iptables -A INPUT -p tcp --dport 80 -j ACCEPT </span><br><span class="line">//开放本机80端口</span><br><span class="line">iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<pre><code>//开放本机的ICMP协议
</code></pre><p><strong>四、删除规则</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -D INPUT -s 192.168.0.21 -j ACCEPT</span><br><span class="line">//删除刚才建立的第一条规则</span><br></pre></td></tr></table></figure></p>
<p><strong>五、规则的保存</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables -F</span><br><span class="line">//清空规则缓冲区（这个操作会将上面的增加操作全部清空，若须保留建议先执行一下句：保存）</span><br><span class="line">service iptables save</span><br><span class="line">//将规则保存在/etc/sysconfig/iptables文件里</span><br><span class="line">service iptables restart</span><br><span class="line">//重启Iptables服务</span><br></pre></td></tr></table></figure></p>
<p>最后说明一下，iptables防火墙的配置文件存放于：/etc/sysconfig/iptables</p>
<p>转载自 <a href="http://www.splaybow.com/post/iptables-rule-add-delete-modify-save.html" target="_blank" rel="noopener">http://www.splaybow.com/post/iptables-rule-add-delete-modify-save.html</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/VPS-技术/">VPS 技术</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/07/25/iptables防火墙规则的添加、删除、修改、保存/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/07/24/百度 Fex 的 webUploader 上传文件携带其他参数/"><span>百度 Fex 的 webUploader 上传文件携带其他参数</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/07/24/百度 Fex 的 webUploader 上传文件携带其他参数/" rel="bookmark">
        <time class="entry-date published" datetime="2016-07-24T06:27:10.000Z">
          2016-07-24
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>目前有两种设置的方法。</p>
<p>全局设置，就是每个文件上传的时候都会携带的。通过修改options.formData来控制。比如如下demo添加一个uid=123。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化的时候直接添加</span></span><br><span class="line"><span class="keyword">var</span> uploader = <span class="keyword">new</span> WebUploader.Uploader(&#123;</span><br><span class="line">    ...</span><br><span class="line">    formData: &#123;</span><br><span class="line">        uid: <span class="number">123</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化以后添加</span></span><br><span class="line">uploader.options.formData.uid = <span class="number">123</span>;</span><br><span class="line">局部设置，给每个独立的文件上传设置。通过绑定一个uploadBeforeSend事件来添加。</span><br><span class="line"></span><br><span class="line">uploader.on( <span class="string">'uploadBeforeSend'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"> block, data </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// block为分块数据。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// file为分块对应的file对象。</span></span><br><span class="line">    <span class="keyword">var</span> file = block.file;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改data可以控制发送哪些携带数据。</span></span><br><span class="line">    data.uid = <span class="number">123</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将存在file对象中的md5数据携带发送过去。</span></span><br><span class="line">    <span class="comment">// data.fileMd5 = file.md5;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除其他数据</span></span><br><span class="line">    <span class="comment">// delete data.key;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>转载自 <a href="https://github.com/fex-team/webuploader/issues/145" target="_blank" rel="noopener">https://github.com/fex-team/webuploader/issues/145</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/07/24/百度 Fex 的 webUploader 上传文件携带其他参数/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>




<nav class="pagination">
  
  <a href="/" class="pagination-prev">上一页</a>
  
  
  <a href="/page/3/" class="pagination-next">下一页</a>
  
</nav>
    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2019 403 Forbidden
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>