<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 8 页 | 博客</title>

  
  <meta name="author" content="403 Forbidden">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="博客"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">博客</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/categories">分类</a></li>
      
        <li><a href="/about.html">关于</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    
  <article>

  
    
    <h3 class="article-title"><a href="/2015/06/09/运维角度浅谈：MySQL数据库优化（转）/"><span>运维角度浅谈：MySQL数据库优化（转）</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/06/09/运维角度浅谈：MySQL数据库优化（转）/" rel="bookmark">
        <time class="entry-date published" datetime="2015-06-09T06:23:00.000Z">
          2015-06-09
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>本博文主要谈MySQL数据库发展周期中所面临的问题及优化方案，暂且抛开前端应用不说，大致分为以下五个阶段：</p>
<p><strong>1、数据库表设计</strong><br>项目立项后，开发部根据产品部需求开发项目，开发工程师工作其中一部分就是对表结构设计。对于数据库来说，这点很重要，如果设计不当，会直接影响访问速度和用户体验。影响的因素很多，比如慢查询、低效的查询语句、没有适当建立索引、数据库堵塞（死锁）等。当然，有测试工程师的团队，会做压力测试，找bug。对于没有测试工程师的团队来说，大多数开发工程师初期不会太多考虑数据库设计是否合理，而是尽快完成功能实现和交付，等项目有一定访问量后，隐藏的问题就会暴露，这时再去修改就不是这么容易的事了。</p>
<p><strong>2、数据库部署</strong><br>该运维工程师出场了，项目初期访问量不会很大，所以单台部署足以应对在1500左右的QPS（每秒查询率）。考虑到高可用性，可采用MySQL主从复制+Keepalived做双击热备，常见集群软件有Keepalived、Heartbeat。<br>双机热备博文：<a href="http://lizhenliang.blog.51cto.com/7876557/1362313" target="_blank" rel="noopener">http://lizhenliang.blog.51cto.com/7876557/1362313</a></p>
<p><strong>3、数据库性能优化</strong><br>如果将MySQL部署到普通的X86服务器上，在不经过任何优化情况下，MySQL理论值正常可以处理2000左右QPS，经过优化后，有可能会提升到2500左右QPS，否则，访问量当达到1500左右并发连接时，数据库处理性能就会变慢，而且硬件资源还很富裕，这时就该考虑软件问题了。那么怎样让数据库最大化发挥性能呢？一方面可以单台运行多个MySQL实例让服务器性能发挥到最大化，另一方面是对数据库进行优化，往往操作系统和数据库默认配置都比较保守，会对数据库发挥有一定限制，可对这些配置进行适当的调整，尽可能的处理更多连接数。</p>
<p>具体优化有以下三个层面：<br><strong>3.1 数据库配置优化</strong><br>MySQL常用有两种存储引擎，一个是MyISAM，不支持事务处理，读性能处理快，表级别锁。另一个是InnoDB，支持事务处理（ACID），设计目标是为处理大容量数据发挥最大化性能，行级别锁。</p>
<p>表锁：开销小，锁定粒度大，发生死锁概率高，相对并发也低。<br>行锁：开销大，锁定粒度小，发生死锁概率低，相对并发也高。</p>
<p>为什么会出现表锁和行锁呢？主要是为了保证数据的完整性，举个例子，一个用户在操作一张表，其他用户也想操作这张表，那么就要等第一个用户操作完，其他用户才能操作，表锁和行锁就是这个作用。否则多个用户同时操作一张表，肯定会数据产生冲突或者异常。<br>根据以上看来，使用InnoDB存储引擎是最好的选择，也是MySQL5.5以后版本中默认存储引擎。每个存储引擎相关联参数比较多，以下列出主要影响数据库性能的参数。</p>
<p>公共参数默认值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">max_connections = 151</span><br><span class="line">#同时处理最大连接数，推荐设置最大连接数是上限连接数的80%左右</span><br><span class="line">sort_buffer_size = 2M</span><br><span class="line">#查询排序时缓冲区大小，只对order by和group by起作用，可增大此值为16M</span><br><span class="line">query_cache_limit = 1M</span><br><span class="line">#查询缓存限制，只有1M以下查询结果才会被缓存，以免结果数据较大把缓存池覆盖</span><br><span class="line">query_cache_size = 16M</span><br><span class="line">#查看缓冲区大小，用于缓存SELECT查询结果，下一次有同样SELECT查询将直接从缓存池返回结果，可适当成倍增加此值</span><br><span class="line">open_files_limit = 1024</span><br><span class="line">#打开文件数限制，如果show global status like &apos;open_files&apos;查看的值等于或者大于open_files_limit值时，程序会无法连接数据库或卡死</span><br></pre></td></tr></table></figure></p>
<p>MyISAM参数默认值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">key_buffer_size = 16M</span><br><span class="line">#索引缓存区大小，一般设置物理内存的30-40%</span><br><span class="line">read_buffer_size = 128K</span><br><span class="line">#读操作缓冲区大小，推荐设置16M或32M</span><br></pre></td></tr></table></figure></p>
<p>InnoDB参数默认值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">innodb_buffer_pool_size = 128M</span><br><span class="line">#索引和数据缓冲区大小，一般设置物理内存的60%-70%</span><br><span class="line">innodb_buffer_pool_instances = 1</span><br><span class="line">#缓冲池实例个数，推荐设置4个或8个</span><br><span class="line">innodb_flush_log_at_trx_commit = 1</span><br><span class="line">#关键参数，0代表大约每秒写入到日志并同步到磁盘，数据库故障会丢失1秒左右事务数据。1为每执行一条SQL后写入到日志并同步到磁盘，I/O开销大，执行完SQL要等待日志读写，效率低。2代表只把日志写入到系统缓存区，再每秒同步到磁盘，效率很高，如果服务器故障，才会丢失事务数据。对数据安全性要求不是很高的推荐设置2，性能高，修改后效果明显。</span><br><span class="line">innodb_file_per_table = OFF</span><br><span class="line">#默认是共享表空间，共享表空间idbdata文件不断增大，影响一定的I/O性能。推荐开启独立表空间模式，每个表的索引和数据都存在自己独立的表空间中，可以实现单表在不同数据库中移动。</span><br><span class="line">innodb_log_buffer_size = 8M</span><br><span class="line">#日志缓冲区大小，由于日志最长每秒钟刷新一次，所以一般不用超过16M</span><br></pre></td></tr></table></figure></p>
<p><strong>3.2 系统内核优化</strong><br>大多数MySQL都部署在linux系统上，所以操作系统的一些参数也会影响到MySQL性能，以下对linux内核进行适当优化。</p>
<p><strong>3.3 硬件配置</strong><br>加大物理内存，提高文件系统性能。linux内核会从内存中分配出缓存区（系统缓存和数据缓存）来存放热数据，通过文件系统延迟写入机制，等满足条件时（如缓存区大小到达一定百分比或者执行sync命令）才会同步到磁盘。也就是说物理内存越大，分配缓存区越大，缓存数据越多。当然，服务器故障会丢失一定的缓存数据。<br>SSD硬盘代替SAS硬盘，将RAID级别调整为RAID1+0，相对于RAID1和RAID5有更好的读写性能（IOPS），毕竟数据库的压力主要来自磁盘I/O方面。</p>
<p><strong>4、数据库架构扩展</strong><br>随着业务量越来越大，单台数据库服务器性能已无法满足业务需求，该考虑加机器了，该做集群了~~~。主要思想是分解单台数据库负载，突破磁盘I/O性能，热数据存放缓存中，降低磁盘I/O访问频率。</p>
<p><strong>4.1 主从复制与读写分离</strong><br>因为生产环境中，数据库大多都是读操作，所以部署一主多从架构，主数据库负责写操作，并做双击热备，多台从数据库做负载均衡，负责读操作，主流的负载均衡器有LVS、HAProxy、Nginx。怎么来实现读写分离呢？大多数企业是在代码层面实现读写分离，效率比较高。另一个种方式通过代理程序实现读写分离，企业中应用较少，常见代理程序有MySQL Proxy、Amoeba。在这样数据库集群架构中，大大增加数据库高并发能力，解决单台性能瓶颈问题。如果从数据库一台从库能处理2000 QPS，那么5台就能处理1w QPS，数据库横向扩展性也很容易。<br>有时，面对大量写操作的应用时，单台写性能达不到业务需求。如果做双主，就会遇到数据库数据不一致现象，产生这个原因是在应用程序不同的用户会有可能操作两台数据库，同时的更新操作造成两台数据库数据库数据发生冲突或者不一致。在单库时MySQL利用存储引擎机制表锁和行锁来保证数据完整性，怎样在多台主库时解决这个问题呢？有一套基于perl语言开发的主从复制管理工具，叫MySQL-MMM（Master-Master replication managerfor Mysql，Mysql主主复制管理器），这个工具最大的优点是在同一时间只提供一台数据库写操作，有效保证数据一致性。</p>
<p><strong>4.2 增加缓存</strong><br>给数据库增加缓存系统，把热数据缓存到内存中，如果内存缓存中有要请求的数据就不再去数据库中返回结果，提高读性能。缓存实现有本地缓存和分布式缓存，本地缓存是将数据缓存到本地服务器内存中或者文件中，速度快。分布式可以缓存海量数据，扩展容易，主流的分布式缓存系统有memcached、redis，memcached性能稳定，数据缓存在内存中，速度很快，QPS可达8w左右。如果想数据持久化那就用redis，性能不低于memcached。</p>
<p>工作过程：<br><a href="/uploads/2015/06/640.jpg"><img src="/uploads/2015/06/640.jpg" alt="640"></a></p>
<p><strong>4.3 分库</strong><br>分库是根据业务不同把相关的表切分到不同的数据库中，比如web、bbs、blog等库。如果业务量很大，还可将切分后的库做主从架构，进一步避免单个库压力过大。</p>
<p><strong>4.4 分表</strong><br>数据量的日剧增加，数据库中某个表有几百万条数据，导致查询和插入耗时太长，怎么能解决单表压力呢？你就该考虑是否把这个表拆分成多个小表，来减轻单个表的压力，提高处理效率，此方式称为分表。<br>分表技术比较麻烦，要修改程序代码里的SQL语句，还要手动去创建其他表，也可以用merge存储引擎实现分表，相对简单许多。分表后，程序是对一个总表进行操作，这个总表不存放数据，只有一些分表的关系，以及更新数据的方式，总表会根据不同的查询，将压力分到不同的小表上，因此提高并发能力和磁盘I/O性能。</p>
<p><strong>分表分为垂直拆分和水平拆分：</strong><br>垂直拆分：把原来的一个很多字段的表拆分多个表，解决表的宽度问题。你可以把不常用的字段单独放到一个表中，也可以把大字段独立放一个表中，或者把关联密切的字段放一个表中。<br>水平拆分：把原来一个表拆分成多个表，每个表的结构都一样，解决单表数据量大的问题。</p>
<p><strong>4.5 分区</strong><br>分区就是把一张表的数据分成多个区块，这些区块可以在一个磁盘上，也可以在不同的磁盘上，分区后，表面上还是一张表，但数据散列在多个位置，这样一来，多块硬盘同时处理不同的请求，从而提高磁盘I/O读写性能，实现比较简单。<br>注：增加缓存、分库、分表和分区主要由程序猿来实现。</p>
<p><strong>5、数据库维护</strong><br>数据库维护是运维工程师或者DBA主要工作，包括性能监控、性能分析、性能调优、数据库备份和恢复等。</p>
<p><strong>5.1 性能状态关键指标</strong></p>
<ul>
<li>QPS，Queries Per Second：每秒查询数，一台数据库每秒能够处理的查询次数；</li>
</ul>
<ul>
<li>TPS，Transactions Per Second：每秒处理事务数。</li>
</ul>
<p>通过show status查看运行状态，会有300多条状态信息记录，其中有几个值帮可以我们计算出QPS和TPS，如下：</p>
<ul>
<li>Uptime：服务器已经运行的实际，单位秒</li>
</ul>
<ul>
<li>Questions：已经发送给数据库查询数</li>
</ul>
<ul>
<li>Com_select：查询次数，实际操作数据库的</li>
</ul>
<ul>
<li>Com_insert：插入次数</li>
</ul>
<ul>
<li>Com_delete：删除次数</li>
</ul>
<ul>
<li>Com_update：更新次数</li>
</ul>
<ul>
<li>Com_commit：事务次数</li>
</ul>
<ul>
<li>Com_rollback：回滚次数</li>
</ul>
<p>那么，计算方法来了，基于Questions计算出QPS：</p>
<p>QPS = Questions / Uptime</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global status like 'Questions';</span><br><span class="line">mysql&gt; show global status like 'Uptime';</span><br></pre></td></tr></table></figure>
<p>基于Com_commit和Com_rollback计算出TPS：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global status like 'Com_commit';</span><br><span class="line">mysql&gt; show global status like 'Com_rollback';</span><br><span class="line">mysql&gt; show global status like 'Uptime';</span><br><span class="line">TPS = (Com_commit + Com_rollback) / Uptime</span><br></pre></td></tr></table></figure></p>
<p>另一计算方式：基于Com_select、Com_insert、Com_delete、Com_update计算出QPS。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global status where Variable_name in('com_select','com_insert','com_delete','com_update');</span><br><span class="line">等待1秒再执行，获取间隔差值，第二次每个变量值减去第一次对应的变量值，就是QPS</span><br></pre></td></tr></table></figure></p>
<p>TPS计算方法：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global status where Variable_name in('com_insert','com_delete','com_update');</span><br><span class="line">计算TPS，就不算查询操作了，计算出插入、删除、更新四个值即可。</span><br><span class="line">经网友对这两个计算方式的测试得出，当数据库中myisam表比较多时，使用Questions计算比较准确。当数据库中innodb表比较多时，则以Com_*计算比较准确。</span><br></pre></td></tr></table></figure></p>
<p><strong>5.2 开启慢查询日志</strong><br>MySQL开启慢查询日志，分析出哪条SQL语句比较慢，使用set设置变量，重启服务失效，可以在my.cnf添加参数永久生效。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global slow-query-log=on #开启慢查询功能</span><br><span class="line">mysql&gt; set global slow_query_log_file='/var/log/mysql/mysql-slow.log'; #指定慢查询日志文件位置</span><br><span class="line">mysql&gt; set global log_queries_not_using_indexes=on; #记录没有使用索引的查询</span><br><span class="line">mysql&gt; set global long_query_time=1; #只记录处理时间1s以上的慢查询</span><br></pre></td></tr></table></figure></p>
<p>分析慢查询日志，可以使用MySQL自带的mysqldumpslow工具，分析的日志较为简单。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> mysqldumpslow -t 3 /var/log/mysql/mysql-slow.log #查看最慢的前三个查询</span><br></pre></td></tr></table></figure></p>
<p>也可以使用percona公司的pt-query-digest工具，日志分析功能全面，可分析slow log、binlog、general log。</p>
<ul>
<li>分析慢查询日志：pt-query-digest /var/log/mysql/mysql-slow.log</li>
</ul>
<ul>
<li>分析binlog日志：mysqlbinlog mysql-bin.000001 &gt;mysql-bin.000001.sql</li>
</ul>
<ul>
<li>pt-query-digest –type=binlog mysql-bin.000001.sql</li>
</ul>
<ul>
<li>分析普通日志：pt-query-digest –type=genlog localhost.log</li>
</ul>
<p><strong>5.3 数据库备份</strong><br>备份数据库是最基本的工作，也是最重要的，否则后果很严重，你懂得！但由于数据库比较大，上百G，往往备份都很耗费时间，所以就该选择一个效率高的备份策略，对于数据量大的数据库，一般都采用增量备份。常用的备份工具有mysqldump、mysqlhotcopy、xtrabackup等，mysqldump比较适用于小的数据库，因为是逻辑备份，所以备份和恢复耗时都比较长。mysqlhotcopy和xtrabackup是物理备份，备份和恢复速度快，不影响数据库服务情况下进行热拷贝，建议使用xtrabackup，支持增量备份。<br>Xtrabackup备份工具使用博文：<a href="http://lizhenliang.blog.51cto.com/7876557/1612800" target="_blank" rel="noopener">http://lizhenliang.blog.51cto.com/7876557/1612800</a></p>
<p><strong>5.4 数据库修复</strong><br>有时候MySQL服务器突然断电、异常关闭，会导致表损坏，无法读取表数据。这时就可以用到MySQL自带的两个工具进行修复，myisamchk和mysqlcheck。</p>
<p>myisamchk：只能修复myisam表，需要停止数据库</p>
<p>常用参数：<br>-f –force 强制修复，覆盖老的临时文件，一般不使用<br>-r –recover 恢复模式<br>-q –quik 快速恢复<br>-a –analyze 分析表<br>-o –safe-recover 老的恢复模式，如果-r无法修复，可以使用此参数试试<br>-F –fast 只检查没有正常关闭的表</p>
<p>快速修复weibo数据库:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cd /var/lib/mysql/weibo </span><br><span class="line"><span class="meta">#</span> myisamchk -r -q *.MYI</span><br></pre></td></tr></table></figure></p>
<p>mysqlcheck：myisam和innodb表都可以用，不需要停止数据库，如修复单个表，可在数据库后面添加表名，以空格分割。</p>
<p>常用参数：<br>-a –all-databases 检查所有的库<br>-r –repair 修复表<br>-c –check 检查表，默认选项<br>-a –analyze 分析表<br>-o –optimize 优化表<br>-q –quik 最快检查或修复表<br>-F –fast 只检查没有正常关闭的表</p>
<p>快速修复weibo数据库:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlcheck -r -q -uroot -p123 weibo</span><br></pre></td></tr></table></figure></p>
<p><strong>5.5 另外，查看CPU和I/O性能方法</strong></p>
<ul>
<li>查看CPU性能<a href="/uploads/2015/06/0.jpg"><img src="/uploads/2015/06/0-300x33.jpg" alt="0"></a></li>
</ul>
<ul>
<li>参数-P是显示CPU数，ALL为所有，也可以只显示第几颗<a href="/uploads/2015/06/1.jpg"><img src="/uploads/2015/06/1-300x58.jpg" alt="1"></a></li>
</ul>
<ul>
<li>查看I/O性能<a href="/uploads/2015/06/2.jpg"><img src="/uploads/2015/06/2-300x77.jpg" alt="2"></a></li>
</ul>
<p>参数-m是以M单位显示，默认K<br>%util：当达到100%时，说明I/O很忙。<br>await：请求在队列中等待时间，直接影响read时间。<br>I/O极限：IOPS（r/s+w/s）,一般在1200左右。（IOPS，每秒进行读写（I/O）操作次数）<br>I/O带宽：在顺序读写模式下SAS硬盘理论值在300M/s左右，SSD硬盘理论值在600M/s左右。</p>
<p>以上是本人使用MySQL三年来总结的一些主要优化方案，能力有限，有些不太全面，但这些基本能够满足中小型企业数据库需求。由于关系型数据库初衷设计限制，一些BAT公司海量数据放到关系型数据库中，在海量数据查询和分析方面已经达不到更好的性能。因此NoSQL火起来了，非关系型数据库，大数据量，具有高性能，同时也弥补了关系型数据库某方面不足，渐渐大多数公司已经将部分业务数据库存放到NoSQL中，如MongoDB、HBase等。数据存储方面采用分布式文件系统，如HDFS、GFS等。海量数据计算分析采用Hadoop、Spark、Storm等。这些都是与运维相关的前沿技术，也是在存储方面主要学习对象，小伙伴们共同加油吧！哪位博友有更好的优化方案，欢迎交流哦。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/06/09/运维角度浅谈：MySQL数据库优化（转）/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/06/03/Rolling cURL: PHP并发最佳实践/"><span>Rolling cURL: PHP并发最佳实践</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/06/03/Rolling cURL: PHP并发最佳实践/" rel="bookmark">
        <time class="entry-date published" datetime="2015-06-03T06:28:52.000Z">
          2015-06-03
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>在实际项目或者自己编写小工具(比如新闻聚合,商品价格监控,比价)的过程中, 通常需要从第3方网站或者API接口获取数据, 在需要处理1个URL队列时, 为了提高性能, 可以采用cURL提供的curl_multi_*族函数实现简单的并发.</p>
<p>本文将探讨两种具体的实现方法, 并对不同的方法做简单的性能对比.</p>
<p><strong>1. 经典cURL并发机制及其存在的问题</strong><br>经典的cURL实现机制在网上很容易找到, 比如参考<a href="http://php.net/manual/en/function.curl-multi-init.php" target="_blank" rel="noopener">PHP在线手册</a>的如下实现方式:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">classic_curl</span><span class="params">($urls, $delay)</span> </span>&#123;</span><br><span class="line">    $queue = curl_multi_init();</span><br><span class="line">    $map = <span class="keyword">array</span>();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">foreach</span> ($urls <span class="keyword">as</span> $url) &#123;</span><br><span class="line">        <span class="comment">// create cURL resources</span></span><br><span class="line">        $ch = curl_init();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// set URL and other appropriate options</span></span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line"> </span><br><span class="line">        curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">1</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_NOSIGNAL, <span class="keyword">true</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// add handle</span></span><br><span class="line">        curl_multi_add_handle($queue, $ch);</span><br><span class="line">        $map[$url] = $ch;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    $active = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// execute the handles</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        $mrc = curl_multi_exec($queue, $active);</span><br><span class="line">    &#125; <span class="keyword">while</span> ($mrc == CURLM_CALL_MULTI_PERFORM);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">while</span> ($active &gt; <span class="number">0</span> &amp;&amp; $mrc == CURLM_OK) &#123;</span><br><span class="line">        <span class="keyword">if</span> (curl_multi_select($queue, <span class="number">0.5</span>) != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                $mrc = curl_multi_exec($queue, $active);</span><br><span class="line">            &#125; <span class="keyword">while</span> ($mrc == CURLM_CALL_MULTI_PERFORM);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    $responses = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">foreach</span> ($map <span class="keyword">as</span> $url=&gt;$ch) &#123;</span><br><span class="line">        $responses[$url] = callback(curl_multi_getcontent($ch), $delay);</span><br><span class="line">        curl_multi_remove_handle($queue, $ch);</span><br><span class="line">        curl_close($ch);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    curl_multi_close($queue);</span><br><span class="line">    <span class="keyword">return</span> $responses;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先将所有的URL压入并发队列, 然后执行并发过程, 等待所有请求接收完之后进行数据的解析等后续处理. 在实际的处理过程中, 受网络传输的影响, 部分URL的内容会优先于其他URL返回, 但是经典cURL并发必须等待最慢的那个URL返回之后才开始处理, 等待也就意味着CPU的空闲和浪费. 如果URL队列很短, 这种空闲和浪费还处在可接受的范围, 但如果队列很长, 这种等待和浪费将变得不可接受.</p>
<p><strong>2. 改进的Rolling cURL并发方式</strong><br>仔细分析不难发现经典cURL并发还存在优化的空间, 优化的方式时当某个URL请求完毕之后尽可能快的去处理它, 边处理边等待其他的URL返回, 而不是等待那个最慢的接口返回之后才开始处理等工作, 从而避免CPU的空闲和浪费. 闲话不多说, 下面贴上具体的实现:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rolling_curl</span><span class="params">($urls, $delay)</span> </span>&#123;</span><br><span class="line">    $queue = curl_multi_init();</span><br><span class="line">    $map = <span class="keyword">array</span>();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">foreach</span> ($urls <span class="keyword">as</span> $url) &#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line"> </span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">        curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">1</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_NOSIGNAL, <span class="keyword">true</span>);</span><br><span class="line"> </span><br><span class="line">        curl_multi_add_handle($queue, $ch);</span><br><span class="line">        $map[(string) $ch] = $url;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    $responses = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (($code = curl_multi_exec($queue, $active)) == CURLM_CALL_MULTI_PERFORM) ;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> ($code != CURLM_OK) &#123; <span class="keyword">break</span>; &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// a request was just completed -- find out which one</span></span><br><span class="line">        <span class="keyword">while</span> ($done = curl_multi_info_read($queue)) &#123;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// get the info and content returned on the request</span></span><br><span class="line">            $info = curl_getinfo($done[<span class="string">'handle'</span>]);</span><br><span class="line">            $error = curl_error($done[<span class="string">'handle'</span>]);</span><br><span class="line">            $results = callback(curl_multi_getcontent($done[<span class="string">'handle'</span>]), $delay);</span><br><span class="line">            $responses[$map[(string) $done[<span class="string">'handle'</span>]]] = compact(<span class="string">'info'</span>, <span class="string">'error'</span>, <span class="string">'results'</span>);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// remove the curl handle that just completed</span></span><br><span class="line">            curl_multi_remove_handle($queue, $done[<span class="string">'handle'</span>]);</span><br><span class="line">            curl_close($done[<span class="string">'handle'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Block for data in / output; error handling is done by curl_multi_exec</span></span><br><span class="line">        <span class="keyword">if</span> ($active &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            curl_multi_select($queue, <span class="number">0.5</span>);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    &#125; <span class="keyword">while</span> ($active);</span><br><span class="line"> </span><br><span class="line">    curl_multi_close($queue);</span><br><span class="line">    <span class="keyword">return</span> $responses;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>3. 两种并发实现的性能对比</strong><br>改进前后的性能对比试验在LINUX主机上进行, 测试时使用的并发队列如下:</p>
<ul>
<li><a href="http://item.taobao.com/item.htm?id=14392877692" target="_blank" rel="noopener">http://item.taobao.com/item.htm?id=14392877692</a></li>
</ul>
<ul>
<li><a href="http://item.taobao.com/item.htm?id=16231676302" target="_blank" rel="noopener">http://item.taobao.com/item.htm?id=16231676302</a></li>
</ul>
<ul>
<li><a href="http://item.taobao.com/item.htm?id=17037160462" target="_blank" rel="noopener">http://item.taobao.com/item.htm?id=17037160462</a></li>
</ul>
<ul>
<li><a href="http://item.taobao.com/item.htm?id=5522416710" target="_blank" rel="noopener">http://item.taobao.com/item.htm?id=5522416710</a></li>
</ul>
<ul>
<li><a href="http://item.taobao.com/item.htm?id=16551116403" target="_blank" rel="noopener">http://item.taobao.com/item.htm?id=16551116403</a></li>
</ul>
<ul>
<li><a href="http://item.taobao.com/item.htm?id=14088310973" target="_blank" rel="noopener">http://item.taobao.com/item.htm?id=14088310973</a></li>
</ul>
<p>简要说明下实验设计的原则和性能测试结果的格式: 为保证结果的可靠, 每组实验重复20次, 在单次实验中, 给定相同的接口URL集合, 分别测量Classic(指经典的并发机制)和Rolling(指改进后的并发机制)两种并发机制的耗时(秒为单位), 耗时短者胜出(Winner), 并计算节省的时间(Excellence, 秒为单位)以及性能提升比例(Excel. %). 为了尽量贴近真实的请求而又保持实验的简单, 在对返回结果的处理上只是做了简单的正则表达式匹配, 而没有进行其他复杂的操作. 另外, 为了确定结果处理回调对性能对比测试结果的影响, 可以使用usleep模拟现实中比较负责的数据处理逻辑(如提取, 分词, 写入文件或数据库等).</p>
<p>性能测试中用到的回调函数为:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span><span class="params">($data, $delay)</span> </span>&#123;</span><br><span class="line">    preg_match_all(<span class="string">'/&lt;h3&gt;(.+)&lt;\/h3&gt;/iU'</span>, $data, $matches);</span><br><span class="line">    usleep($delay);</span><br><span class="line">    <span class="keyword">return</span> compact(<span class="string">'data'</span>, <span class="string">'matches'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>数据处理回调无延迟时: Rolling Curl略优, 但性能提升效果不明显.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">------------------------------------------------------------------------------------------------</span><br><span class="line">Delay: 0 micro seconds, equals to 0 milli seconds</span><br><span class="line">------------------------------------------------------------------------------------------------</span><br><span class="line">Counter         Classic         Rolling         Winner          Excellence      Excel. %</span><br><span class="line">------------------------------------------------------------------------------------------------</span><br><span class="line">1               0.1193          0.0390          Rolling         0.0803          67.31%</span><br><span class="line">2               0.0556          0.0477          Rolling         0.0079          14.21%</span><br><span class="line">3               0.0461          0.0588          Classic         -0.0127         -21.6%</span><br><span class="line">4               0.0464          0.0385          Rolling         0.0079          17.03%</span><br><span class="line">5               0.0534          0.0448          Rolling         0.0086          16.1%</span><br><span class="line">6               0.0540          0.0714          Classic         -0.0174         -24.37%</span><br><span class="line">7               0.0386          0.0416          Classic         -0.0030         -7.21%</span><br><span class="line">8               0.0357          0.0398          Classic         -0.0041         -10.3%</span><br><span class="line">9               0.0437          0.0442          Classic         -0.0005         -1.13%</span><br><span class="line">10              0.0319          0.0348          Classic         -0.0029         -8.33%</span><br><span class="line">11              0.0529          0.0430          Rolling         0.0099          18.71%</span><br><span class="line">12              0.0503          0.0581          Classic         -0.0078         -13.43%</span><br><span class="line">13              0.0344          0.0225          Rolling         0.0119          34.59%</span><br><span class="line">14              0.0397          0.0643          Classic         -0.0246         -38.26%</span><br><span class="line">15              0.0368          0.0489          Classic         -0.0121         -24.74%</span><br><span class="line">16              0.0502          0.0394          Rolling         0.0108          21.51%</span><br><span class="line">17              0.0592          0.0383          Rolling         0.0209          35.3%</span><br><span class="line">18              0.0302          0.0285          Rolling         0.0017          5.63%</span><br><span class="line">19              0.0248          0.0553          Classic         -0.0305         -55.15%</span><br><span class="line">20              0.0137          0.0131          Rolling         0.0006          4.38%</span><br><span class="line">------------------------------------------------------------------------------------------------</span><br><span class="line">Average         0.0458          0.0436          Rolling         0.0022          4.8%</span><br><span class="line">------------------------------------------------------------------------------------------------</span><br><span class="line">Summary: Classic wins 10 times, while Rolling wins 10 times</span><br></pre></td></tr></table></figure></p>
<p>数据处理回调延迟5毫秒: Rolling Curl完胜, 性能提升40%左右.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">------------------------------------------------------------------------------------------------</span><br><span class="line">Delay: 5000 micro seconds, equals to 5 milli seconds</span><br><span class="line">------------------------------------------------------------------------------------------------</span><br><span class="line">Counter         Classic         Rolling         Winner          Excellence      Excel. %</span><br><span class="line">------------------------------------------------------------------------------------------------</span><br><span class="line">1               0.0658          0.0352          Rolling         0.0306          46.5%</span><br><span class="line">2               0.0728          0.0367          Rolling         0.0361          49.59%</span><br><span class="line">3               0.0732          0.0387          Rolling         0.0345          47.13%</span><br><span class="line">4               0.0783          0.0347          Rolling         0.0436          55.68%</span><br><span class="line">5               0.0658          0.0286          Rolling         0.0372          56.53%</span><br><span class="line">6               0.0687          0.0362          Rolling         0.0325          47.31%</span><br><span class="line">7               0.0787          0.0337          Rolling         0.0450          57.18%</span><br><span class="line">8               0.0676          0.0391          Rolling         0.0285          42.16%</span><br><span class="line">9               0.0668          0.0351          Rolling         0.0317          47.46%</span><br><span class="line">10              0.0603          0.0317          Rolling         0.0286          47.43%</span><br><span class="line">11              0.0714          0.0350          Rolling         0.0364          50.98%</span><br><span class="line">12              0.0627          0.0215          Rolling         0.0412          65.71%</span><br><span class="line">13              0.0617          0.0401          Rolling         0.0216          35.01%</span><br><span class="line">14              0.0721          0.0226          Rolling         0.0495          68.65%</span><br><span class="line">15              0.0701          0.0428          Rolling         0.0273          38.94%</span><br><span class="line">16              0.0674          0.0352          Rolling         0.0322          47.77%</span><br><span class="line">17              0.0452          0.0425          Rolling         0.0027          5.97%</span><br><span class="line">18              0.0596          0.0366          Rolling         0.0230          38.59%</span><br><span class="line">19              0.0679          0.0480          Rolling         0.0199          29.31%</span><br><span class="line">20              0.0657          0.0338          Rolling         0.0319          48.55%</span><br><span class="line">------------------------------------------------------------------------------------------------</span><br><span class="line">Average         0.0671          0.0354          Rolling         0.0317          47.24%</span><br><span class="line">------------------------------------------------------------------------------------------------</span><br><span class="line">Summary: Classic wins 0 times, while Rolling wins 20 times</span><br></pre></td></tr></table></figure></p>
<p>通过上面的性能对比, 在处理URL队列并发的应用场景中Rolling cURL应该是更加的选择, 并发量非常大(1000+)时, 可以控制并发队列的最大长度, 比如20, 每当1个URL返回并处理完毕之后立即加入1个尚未请求的URL到队列中, 这样写出来的代码会更加健壮, 不至于并发数太大而卡死或崩溃. 详细的实现请参考: <a href="http://code.google.com/p/rolling-curl/" target="_blank" rel="noopener">http://code.google.com/p/rolling-curl/</a>（博主注：<a href="/uploads/2015/06/temp.zip">rolling-curl 源码下载</a>）</p>
<p><strong>5. 参考资料和延伸阅读</strong></p>
<ul>
<li>Client URL Library <a href="http://www.php.net/manual/en/book.curl.php" target="_blank" rel="noopener">http://www.php.net/manual/en/book.curl.php</a></li>
</ul>
<ul>
<li>Parallel CURL Requests with PHP <a href="http://blog.rob.cx/multi-curl" target="_blank" rel="noopener">http://blog.rob.cx/multi-curl</a></li>
</ul>
<ul>
<li>A more efficient multi-curl library for PHP (non-blocking) <a href="http://code.google.com/p/rolling-curl/" target="_blank" rel="noopener">http://code.google.com/p/rolling-curl/</a></li>
</ul>
<ul>
<li>PHP: Parallel cURL Performance <a href="http://stackoverflow.com/questions/10485199/php-parallel-curl-performance-rollingcurl-vs-parallelcurl" target="_blank" rel="noopener">http://stackoverflow.com/questions/10485199/php-parallel-curl-performance-rollingcurl-vs-parallelcurl</a></li>
</ul>
<p>转载自 <a href="http://www.searchtb.com/2012/06/rolling-curl-best-practices.html" target="_blank" rel="noopener">http://www.searchtb.com/2012/06/rolling-curl-best-practices.html</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/06/03/Rolling cURL: PHP并发最佳实践/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/06/02/Ubuntu 14.04 安装 QQ 7.2/"><span>Ubuntu 14.04 安装 QQ 7.2</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/06/02/Ubuntu 14.04 安装 QQ 7.2/" rel="bookmark">
        <time class="entry-date published" datetime="2015-06-02T05:24:27.000Z">
          2015-06-02
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>　　首先，添加 ppa，并安装 wine1.7。要是 apt-get update 的时候报错请参考前一篇文章《<a href="http://futa.ooo/2218.html">Ubuntu 使用 shadowsocks 科学上网</a>》。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:ubuntu-wine/ppa</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install wine1.7</span><br></pre></td></tr></table></figure></p>
<p>　　wine 1.7 安装完成后，安装一些依赖：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winetricks riched20 gdiplus msxml4 vcrun2005 msctf mfc42 fakechinese corefonts sound=alsa</span><br></pre></td></tr></table></figure></p>
<p>　　之后，将 win 下字体文件夹（C:\Windows\Fonts）内的所有字体复制至 ~/.wine/drive_c/windows/Fonts。<br>　　打开 <a href="http://im.qq.com" target="_blank" rel="noopener">http://im.qq.com</a> 下载最新版 QQ，双击安装即可。<br>　　安装完成后，需要自行建立快捷方式：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi ~/桌面/QQ.desktop</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Desktop Entry]</span><br><span class="line">Name=腾讯QQ</span><br><span class="line">Exec=wine &quot;C:\\Program Files (x86)\\Tencent\\QQ\\bin\\QQ.exe&quot;</span><br><span class="line">Type=Application</span><br><span class="line">StartupNotify=true</span><br></pre></td></tr></table></figure>
<p>　　给快捷方式加上可执行权限：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x ~/桌面/QQ.desktop</span><br></pre></td></tr></table></figure></p>
<p>　　效果如图<br><a href="/uploads/2015/06/Screenshots_2015_06_02_21_09_01.png"><img src="/uploads/2015/06/Screenshots_2015_06_02_21_09_01-300x169.png" alt="Screenshots_2015_06_02_21_09_01"></a></p>
<p>　　小 bug 还是有点的，比如图中有些字依旧是方块，不过是字体问题，找到对应字体 copy 下就行。还有，切记！千！万！不！能！最！小！化！消！息！列！表！因为没有状态栏。。。要是不小心最小化或者不见了，可以用以下命令解决问题：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">killall QQ.exe</span><br><span class="line">wine "C:\\Program Files (x86)\\Tencent\\QQ\\bin\\QQ.exe"</span><br></pre></td></tr></table></figure></p>
<p>　　你没看错。。就是重启 QQ</p>
<p>　　最后，提供几个比较好的补丁，希望各位喜欢：</p>
<ul>
<li><a href="http://www.laibude.com/blog/22.html" target="_blank" rel="noopener">QQ7.3小清新补丁</a></li>
</ul>
<ul>
<li><a href="http://www.zdfans.com/589.html" target="_blank" rel="noopener">腾讯QQ7.x 去整体安全校验补丁v3.0</a></li>
</ul>
<ul>
<li><a href="http://www.zdfans.com/583.html" target="_blank" rel="noopener">腾讯QQ7.2 正式版SVIP超级会员补丁</a></li>
</ul>
<p>　　感谢 <a href="https://www.maou.me" target="_blank" rel="noopener">(╯‵□′)╯︵┻━┻</a> 提供技术支持。</p>
<p>　　参考：</p>
<ul>
<li><a href="https://www.maou.me/20.html" target="_blank" rel="noopener">Linux 通过 Wine 来安装最新 QQ 的方法</a></li>
</ul>
<ul>
<li><a href="http://blog.aizhet.com/Windows/12172.html" target="_blank" rel="noopener">彻底消除wine中文乱码、QQ等</a></li>
</ul>
<ul>
<li><a href="http://forum.ubuntu.org.cn/viewtopic.php?f=121&amp;t=455783" target="_blank" rel="noopener">Ubuntu12.04+Wine1.7.12近完美使用QQ5.0</a></li>
</ul>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Linux-Desktop/">Linux Desktop</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/06/02/Ubuntu 14.04 安装 QQ 7.2/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/05/31/Ubuntu 使用 shadowsocks 科学上网/"><span>Ubuntu 使用 shadowsocks 科学上网</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/05/31/Ubuntu 使用 shadowsocks 科学上网/" rel="bookmark">
        <time class="entry-date published" datetime="2015-05-31T04:26:30.000Z">
          2015-05-31
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>　　不知道为什么我的系统运行有 gui 的版本会假死。。Ubuntu 14.04：<br><a href="/uploads/2015/05/2015-05-31-201021屏幕截图.png"><img src="/uploads/2015/05/2015-05-31-201021屏幕截图-300x174.png" alt="2015-05-31 20:10:21屏幕截图"></a><br>　　所以，我用了 sslocal + tsocks 实现的科学上网，chrome 需要插件 SwitchyOmega，文末提供下载链接及安装配置方法。<br>　　首先，安装 sslocal，<code>pip install shadowsocks</code></p>
<p>　　安装完成后，新建 json 配置文件，这里位置为 /etc/shadowsocks.json，文件内容大致如下：<br><a href="/uploads/2015/05/QQ截图20150531201514.png"><img src="/uploads/2015/05/QQ截图20150531201514-300x182.png" alt="QQ截图20150531201514"></a><br>　　配置完成后，运行 sslocal<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sslocal -c /etc/shadowsocks.json --pid-file /var/run/shadowsocks.pid -d start</span><br></pre></td></tr></table></figure></p>
<p>　　安装 tsocks 实现 socks5 转 http 代理：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install tsocks</span><br></pre></td></tr></table></figure></p>
<p> 　　配置 tsocks（/etc/tsocks.conf）：<br><a href="/uploads/2015/05/QQ截图20150531201836.png"><img src="/uploads/2015/05/QQ截图20150531201836-300x182.png" alt="QQ截图20150531201836"></a><br>　　使用时只需在命令前加上 tsocks 即可，比如 tsocks apt-get update</p>
<p>　　关于 chrome 的配置：<br>　　下载 <a href="/uploads/2015/05/SwitchyOmega.zip">SwitchyOmega</a>，并解压。将解压出来的 SwitchyOmega.crx 拖动至 <a href="chrome://extensions/" target="_blank" rel="noopener">chrome://extensions/</a> 安装即可。<br>　　安装完成后会自动弹出配置页，如图配置即可：<br><a href="/uploads/2015/05/2015-05-31-202554屏幕截图.png"><img src="/uploads/2015/05/2015-05-31-202554屏幕截图-300x169.png" alt="2015-05-31 20:25:54屏幕截图"></a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Linux-Desktop/">Linux Desktop</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/05/31/Ubuntu 使用 shadowsocks 科学上网/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/05/07/感觉我又恶劣了一把。。/"><span>感觉我又恶劣了一把。。</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/05/07/感觉我又恶劣了一把。。/" rel="bookmark">
        <time class="entry-date published" datetime="2015-05-07T04:25:07.000Z">
          2015-05-07
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>以前研究学校的 WiFi，写过一篇文章：<a href="http://futa.ooo/1988.html">纯靠点小聪明搞定学校 WiFi 该死的 web 登陆</a>，然后利用这个。。。咳咳懂的。但最近遇到点事情需要收回账号，但给出账号时已经给出了所有权限，包括修改密码的，结果只能用点特殊手段，看图。<br><a href="/uploads/2015/05/QQ图片20150507200223.png"><img src="/uploads/2015/05/QQ图片20150507200223-169x300.png" alt="QQ图片20150507200223"></a><br>输错五次密码自动锁定五分钟。。这样的话，要永久锁定不就是件很简单的事情了？只要写个程序不断模拟提交错误密码就行，但是，这里却遇到个问题：验证码。网上搜了很多资料，发现一篇很有用的文章：<a href="http://www.geekso.com/Valite2/" target="_blank" rel="noopener">http://www.geekso.com/Valite2/</a> 修改了下字模，很顺利地认出了学校 Web Portal 弱智的验证码：<br><a href="/uploads/2015/05/QQ图片20150507201318-e1431000789257.jpg"><img src="/uploads/2015/05/QQ图片20150507201318-e1431000789257-169x300.jpg" alt="QQ图片20150507201318"></a><br>2333，写完以后扔在了一部小渣机里，结果居然不卡<br><a href="/uploads/2015/05/QQ图片20150507185259.jpg"><img src="/uploads/2015/05/QQ图片20150507185259-300x169.jpg" alt="QQ图片20150507185259"></a><br><a href="/uploads/2015/05/QQ图片20150507185322.jpg"><img src="/uploads/2015/05/QQ图片20150507185322-300x162.jpg" alt="QQ图片20150507185322"></a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/05/07/感觉我又恶劣了一把。。/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/04/17/用.htaccess设置PHP错误显示(转)/"><span>用.htaccess设置PHP错误显示(转)</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/04/17/用.htaccess设置PHP错误显示(转)/" rel="bookmark">
        <time class="entry-date published" datetime="2015-04-17T06:37:32.000Z">
          2015-04-17
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>今天在网上看到使用.htaccess可以在某种程度上更改PHP的错误显示的设置，实际上相当于更改PHP.ini的参数，很是方便。将以下相应代码放到对应目录中的.htaccess文件，即可实现相应功能。</p>
<p>关闭错误显示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">php_flag display_startup_errors off</span><br><span class="line">php_flag display_errors off</span><br><span class="line">php_flag html_errors off</span><br><span class="line">php_value docref_root 0</span><br><span class="line">php_value docref_ext 0</span><br></pre></td></tr></table></figure></p>
<p>只显示PHP错误：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php_flag  display_errors        on</span><br><span class="line">php_flag  display_startup_errors on</span><br><span class="line">php_value error_reporting        2047</span><br></pre></td></tr></table></figure></p>
<p>其中，“2047”为要显示的错误的级别，详细表格如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1 E_ERROR</span><br><span class="line">2 E_WARNING</span><br><span class="line">4 E_PARSE</span><br><span class="line">8 E_NOTICE</span><br><span class="line">16 E_CORE_ERROR</span><br><span class="line">32 E_CORE_WARNING</span><br><span class="line">64 E_COMPILE_ERROR</span><br><span class="line">128 E_COMPILE_WARNING</span><br><span class="line">256 E_USER_ERROR</span><br><span class="line">512 E_USER_WARNING</span><br><span class="line">1024 E_USER_NOTICE</span><br><span class="line">2047 E_ALL</span><br><span class="line">2048 E_STRICT</span><br><span class="line">4096 E_RECOVERABLE_ERROR</span><br></pre></td></tr></table></figure></p>
<p>要把错误保存到日志文件中，可以这样设置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># enable PHP error logging</span><br><span class="line">php_flag  log_errors on</span><br><span class="line">php_value error_log  /home/path/public_html/domain/PHP_errors.log</span><br></pre></td></tr></table></figure></p>
<p>然后，可以设置不允许访问.log文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># prevent access to PHP error log</span><br><span class="line">&lt;Files PHP_errors.log&gt;</span><br><span class="line"> Order allow,deny</span><br><span class="line"> Deny from all</span><br><span class="line"> Satisfy All</span><br><span class="line">&lt;/Files&gt;</span><br></pre></td></tr></table></figure></p>
<p>设置错误日志的最大体积，以bytes为单位：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># general directive for</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> setting max error size</span><br><span class="line">log_errors_max_len integer</span><br></pre></td></tr></table></figure></p>
<p>综合上述，.htaccess的PHP错误显示设置汇总：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"># PHP error handling for production servers</span><br><span class="line"></span><br><span class="line"># disable display of startup errors</span><br><span class="line">php_flag display_startup_errors off</span><br><span class="line"></span><br><span class="line"># disable display of all other errors</span><br><span class="line">php_flag display_errors off</span><br><span class="line"></span><br><span class="line"># disable html markup of errors</span><br><span class="line">php_flag html_errors off</span><br><span class="line"></span><br><span class="line"># enable logging of errors</span><br><span class="line">php_flag log_errors on</span><br><span class="line"></span><br><span class="line"># disable ignoring of repeat errors</span><br><span class="line">php_flag ignore_repeated_errors off</span><br><span class="line"></span><br><span class="line"># disable ignoring of unique source errors</span><br><span class="line">php_flag ignore_repeated_source off</span><br><span class="line"></span><br><span class="line"># enable logging of php memory leaks</span><br><span class="line">php_flag report_memleaks on</span><br><span class="line"></span><br><span class="line"># preserve most recent error via php_errormsg</span><br><span class="line">php_flag track_errors on</span><br><span class="line"></span><br><span class="line"># disable formatting of error reference links</span><br><span class="line">php_value docref_root 0</span><br><span class="line"></span><br><span class="line"># disable formatting of error reference links</span><br><span class="line">php_value docref_ext 0</span><br><span class="line"></span><br><span class="line"># specify path to php error log</span><br><span class="line">php_value error_log /home/path/public_html/domain/PHP_errors.log</span><br><span class="line"></span><br><span class="line"># specify recording of all php errors</span><br><span class="line">php_value error_reporting 999999999</span><br><span class="line"></span><br><span class="line"># disable max error string length</span><br><span class="line">php_value log_errors_max_len 0</span><br><span class="line"></span><br><span class="line"># protect error log by preventing public access</span><br><span class="line">&lt;Files /home/path/public_html/domain/PHP_errors.log&gt;</span><br><span class="line"> Order allow,deny</span><br><span class="line"> Deny from all</span><br><span class="line"> Satisfy All</span><br><span class="line">&lt;/Files&gt;</span><br></pre></td></tr></table></figure></p>
<p>以下则是适合开发者应用的设置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># PHP error handling for</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> development servers</span><br><span class="line">php_flag display_startup_errors on</span><br><span class="line">php_flag display_errors on</span><br><span class="line">php_flag html_errors on</span><br><span class="line">php_flag log_errors on</span><br><span class="line">php_flag ignore_repeated_errors off</span><br><span class="line">php_flag ignore_repeated_source off</span><br><span class="line">php_flag report_memleaks on</span><br><span class="line">php_flag track_errors on</span><br><span class="line">php_value docref_root 0</span><br><span class="line">php_value docref_ext 0</span><br><span class="line">php_value error_log /home/path/public_html/domain/PHP_errors.log</span><br><span class="line">php_value error_reporting 999999999</span><br><span class="line">php_value log_errors_max_len 0</span><br><span class="line"></span><br><span class="line">&lt;Files /home/path/public_html/domain/PHP_errors.log&gt;</span><br><span class="line"> Order allow,deny</span><br><span class="line"> Deny from all</span><br><span class="line"> Satisfy All</span><br><span class="line">&lt;/Files&gt;</span><br></pre></td></tr></table></figure></p>
<p>本文大部分内容参考这篇文章：<a href="http://perishablepress.com/press/2007/12/17/how-to-enable-php-error-logging-via-htaccess/" target="_blank" rel="noopener">How to Enable PHP Error Logging via htaccess</a> ，大家有兴趣的话可以阅读英文原版。</p>
<p>转载自 <a href="http://blog.slogra.com/post-79.html" target="_blank" rel="noopener">http://blog.slogra.com/post-79.html</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/04/17/用.htaccess设置PHP错误显示(转)/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/04/13/Shell中处理包含空格的文件名实例/"><span>Shell中处理包含空格的文件名实例</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/04/13/Shell中处理包含空格的文件名实例/" rel="bookmark">
        <time class="entry-date published" datetime="2015-04-13T04:24:29.000Z">
          2015-04-13
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>这篇文章主要介绍了Shell中处理包含空格的文件名实例,需要的朋友可以参考下</p>
<p>今天在处理文件时遇到个问题，当文件名包含空格时，for循环就出问题了。<br>例如，我在当前文件夹下建立3个文件名包含空格的文件：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keakons-MacBook-Pro:test keakon$ touch "test 1"</span><br><span class="line">keakons-MacBook-Pro:test keakon$ touch "test 2"</span><br><span class="line">keakons-MacBook-Pro:test keakon$ touch "test 3"</span><br><span class="line">keakons-MacBook-Pro:test keakon$ ls</span><br><span class="line">test 1 test 2 test 3</span><br></pre></td></tr></table></figure></p>
<p>然后for循环输出文件名：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">keakons-MacBook-Pro:test keakon$ for file in `ls`;</span><br><span class="line"><span class="meta">&gt;</span> do echo $file;</span><br><span class="line"><span class="meta">&gt;</span> done</span><br><span class="line">test</span><br><span class="line">1</span><br><span class="line">test</span><br><span class="line">2</span><br><span class="line">test</span><br><span class="line">3</span><br></pre></td></tr></table></figure></p>
<p>可以看到，文件名被分开了。<br>复制操作也不行：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">keakons-MacBook-Pro:test keakon$ mkdir ../bak</span><br><span class="line">keakons-MacBook-Pro:test keakon$ for file in `ls`; do cp "$file" ../bak; done</span><br><span class="line">cp: bak is a directory (not copied).</span><br><span class="line">cp: test: No such file or directory</span><br><span class="line">cp: 1: No such file or directory</span><br><span class="line">cp: test: No such file or directory</span><br><span class="line">cp: 2: No such file or directory</span><br><span class="line">cp: test: No such file or directory</span><br><span class="line">cp: 3: No such file or directory</span><br></pre></td></tr></table></figure></p>
<p>要解决这个问题，当然就要从单词分隔符着手。而bash中使用的是$IFS（Internal Field Separator）这个变量，内容为” \n\t”：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">keakons-MacBook-Pro:test keakon$ echo $IFS  </span><br><span class="line"> keakons-MacBook-Pro:test keakon$ echo "$IFS" | od -t x1</span><br><span class="line">0000000    20  09  0a  0a                                                </span><br><span class="line">0000004</span><br><span class="line">keakons-MacBook-Pro:test keakon$ echo "" | od -t x1</span><br><span class="line">0000000    0a                                                            </span><br><span class="line">0000001</span><br></pre></td></tr></table></figure></p>
<p>然后把它改成”\n\b”，记得修改前先保存一下：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">keakons-MacBook-Pro:test keakon$ SAVEIFS=$IFS</span><br><span class="line">keakons-MacBook-Pro:test keakon$ IFS=$(echo -en "\n\b")</span><br></pre></td></tr></table></figure></p>
<p>现在再执行上述命令就正常了：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">keakons-MacBook-Pro:test keakon$ for file in `ls`; do echo $file; done</span><br><span class="line">test 1</span><br><span class="line">test 2</span><br><span class="line">test 3</span><br><span class="line">keakons-MacBook-Pro:test keakon$ for file in `ls`; do cp "$file" ../bak; done</span><br><span class="line">keakons-MacBook-Pro:test keakon$ ls ../bak</span><br><span class="line">test 1 test 2 test 3</span><br></pre></td></tr></table></figure></p>
<p>最后，别忘了恢复$IFS：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">keakons-MacBook-Pro:test keakon$ IFS=$SAVEIFS</span><br><span class="line">keakons-MacBook-Pro:test keakon$ echo "$IFS" | od -t x1</span><br><span class="line">0000000    20  09  0a  0a                                                </span><br><span class="line">0000004</span><br><span class="line">keakons-MacBook-Pro:test keakon$ IFS=$(echo -en " \n\t")</span><br><span class="line">keakons-MacBook-Pro:test keakon$ echo "$IFS" | od -t x1</span><br><span class="line">0000000    20  0a  09  0a                                                </span><br><span class="line">0000004</span><br></pre></td></tr></table></figure></p>
<p>转载自 <a href="http://www.jb51.net/article/49797.htm" target="_blank" rel="noopener">http://www.jb51.net/article/49797.htm</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/VPS-技术/">VPS 技术</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/04/13/Shell中处理包含空格的文件名实例/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/04/07/Redbean：入门(一) - 增删改查/"><span>Redbean：入门(一) - 增删改查</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/04/07/Redbean：入门(一) - 增删改查/" rel="bookmark">
        <time class="entry-date published" datetime="2015-04-07T07:05:30.000Z">
          2015-04-07
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">require_once</span> <span class="string">'rb.php'</span>;</span><br><span class="line">    $tableName = <span class="string">"link"</span>;</span><br><span class="line">    <span class="comment">//链接数据库</span></span><br><span class="line">    R::setup(<span class="string">"mysql:host=localhost;dbname=hwibs_model"</span>,<span class="string">"root"</span>,<span class="string">""</span>);</span><br><span class="line">    <span class="comment">//创建一个表（也可以指为实例化一个表）</span></span><br><span class="line">    $handler = R::dispense($tableName);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">#####################################   add #####################################</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*同上[同时实例化多个表]</span></span><br><span class="line"><span class="comment">        list($handler_1,$handler_2) = R::dispenseALL("test_1,test_2");</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">//对象方式给字段赋值</span></span><br><span class="line">    <span class="comment">//::注意，如果字段不存在，store方法过后，会自动添加对应的字段，并且自动根据字段值设置字段的对应字段类型</span></span><br><span class="line">    $handler-&gt;name = <span class="string">"haha"</span>;</span><br><span class="line">    $handler-&gt;url = <span class="string">"isxiugai"</span>;</span><br><span class="line">    $handler-&gt;plushtime = time() - <span class="number">5000</span>;</span><br><span class="line">    <span class="comment">//如果有下划线的字段名，则可以使用驼峰法命名，将自动转换为下划线</span></span><br><span class="line">    $handler-&gt;isMyName = <span class="keyword">false</span>;<span class="comment">// = is_my_name</span></span><br><span class="line">    <span class="comment">//执行,此静态方法会返回添加成功后的自增id值(单个)</span></span><br><span class="line">    $inser_id = R::store($handler);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#####################################   query ####################################</span></span><br><span class="line">    <span class="comment">//获取记录句柄(参数1为表名，参数2为id值),返回值为对象集合</span></span><br><span class="line">    <span class="comment">//如果id不存在，则返回0</span></span><br><span class="line">    <span class="comment">//注意，这个获取到的句柄，可以用于删除操作</span></span><br><span class="line">    $bean  = R::load($tableName,<span class="number">4</span>);<span class="comment">//获取单个</span></span><br><span class="line">    $beans = R::loadAll($tableName,<span class="keyword">array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>));<span class="comment">//获取多个</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#####################################   update #####################################</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//1.注意，修改跟add的唯一区别就是id，如果id不为空，则为修改，否则则为添加!</span></span><br><span class="line">    <span class="comment">//2.如果id不存在的情况下，既不会添加，也不会修改！所以一般在修改前，需要事先用load进行判断是否存在</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">foreach</span> ($beans <span class="keyword">as</span> $k=&gt;$v)&#123;</span><br><span class="line">        $beans[$k]-&gt;url = rand(<span class="number">100</span>,<span class="number">5555</span>);<span class="comment">//测试[循环将每个记录对象中的url赋值一个随机数]</span></span><br><span class="line">    &#125;</span><br><span class="line">    R::storeAll($beans);<span class="comment">//执行修改</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">#####################################   delete #####################################</span></span><br><span class="line">    <span class="comment">//删除单个::成功或失败都是返回null</span></span><br><span class="line">    var_dump(R::trash(R::load($tableName,<span class="number">1</span>)));</span><br><span class="line">    <span class="comment">//删除多个::如果有不存在的，则会只删除存在的,成功或失败都是返回null</span></span><br><span class="line">    var_dump(R::trashAll(R::loadALL($tableName,<span class="keyword">array</span>(<span class="number">117</span>,<span class="number">118</span>))));</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">#####################################   other #####################################</span></span><br><span class="line">    <span class="comment">//清除表中所有数据::相当于truncate，因为会将自增指针重置</span></span><br><span class="line">    <span class="comment">//R::wipe($tableName);</span></span><br><span class="line">    <span class="comment">//删除数据库中所有的表,[无语的功能，要这个搞毛]</span></span><br><span class="line">    <span class="comment">//var_dump(R::nuke());</span></span><br><span class="line">    <span class="comment">//关闭链接</span></span><br><span class="line">    R::close();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>转载自 <a href="http://www.cnblogs.com/shibazi/archive/2014/08/02/3887246.html" target="_blank" rel="noopener">http://www.cnblogs.com/shibazi/archive/2014/08/02/3887246.html</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/04/07/Redbean：入门(一) - 增删改查/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/03/20/搭建coreseek(sphinx+mmseg3)详细安装配置+php之sphinx扩展安装+php调用示例/"><span>搭建coreseek(sphinx+mmseg3)详细安装配置+php之sphinx扩展安装+php调用示例</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/03/20/搭建coreseek(sphinx+mmseg3)详细安装配置+php之sphinx扩展安装+php调用示例/" rel="bookmark">
        <time class="entry-date published" datetime="2015-03-20T05:32:49.000Z">
          2015-03-20
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>一个文档包含了安装、增量备份、扩展、api调用示例，省去了查找大量文章的时间。</p>
<p><strong>搭建coreseek(sphinx+mmseg3)安装<br>[第一步] 先安装mmseg3</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd /var/install</span><br><span class="line">wget http://www.coreseek.cn/uploads/csft/4.0/coreseek-4.1-beta.tar.gz</span><br><span class="line">tar zxvf coreseek-4.1-beta.tar.gz</span><br><span class="line"></span><br><span class="line">cd coreseek-4.1-beta</span><br><span class="line">cd mmseg-3.2.14</span><br><span class="line">./bootstrap</span><br><span class="line">./configure --prefix=/usr/local/mmseg3</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p>
<p>遇到的问题:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: cannot find input file: src/Makefile.in</span><br></pre></td></tr></table></figure></p>
<p>或者遇到其他类似error错误时…</p>
<p>解决方案：<br>依次执行下面的命令，我运行’aclocal’时又出现了错误，解决方案请看下文描述<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum -y install libtool</span><br><span class="line"></span><br><span class="line">aclocal</span><br><span class="line">libtoolize --force</span><br><span class="line">automake --add-missing</span><br><span class="line">autoconf</span><br><span class="line">autoheader</span><br><span class="line">make clean</span><br></pre></td></tr></table></figure></p>
<p>安装好’libtool’继续从’aclocal’开始执行上面提到的一串命令，执行完后再运行最开始的安装流程即可。</p>
<p><strong>[第二步] 安装coreseek</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>#安装coreseek</span><br><span class="line"><span class="meta">$</span> cd csft-3.2.14 或者 cd csft-4.0.1 或者 cd csft-4.1</span><br><span class="line"><span class="meta">$</span> sh buildconf.sh                                         #输出的warning信息可以忽略，如果出现error则需要解决</span><br><span class="line"><span class="meta">$</span> ./configure --prefix=/usr/local/coreseek  --without-unixodbc --with-mmseg --with-mmseg-includes=/usr/local/mmseg3/include/mmseg/ --with-mmseg-libs=/usr/local/mmseg3/lib/ --with-mysql</span><br><span class="line"><span class="meta">#</span>#如果提示mysql问题，可以查看MySQL数据源安装说明   http://www.coreseek.cn/product_install/install_on_bsd_linux/#mysql</span><br><span class="line"><span class="meta">$</span> make &amp;&amp; make install</span><br><span class="line"><span class="meta">$</span> cd ..</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>#命令行测试mmseg分词，coreseek搜索（需要预先设置好字符集为zh_CN.UTF-8，确保正确显示中文）</span><br><span class="line"><span class="meta">$</span> cd testpack</span><br><span class="line"><span class="meta">$</span> cat var/test/test.xml    #此时应该正确显示中文</span><br><span class="line"><span class="meta">$</span> /usr/local/mmseg3/bin/mmseg -d /usr/local/mmseg3/etc var/test/test.xml</span><br><span class="line"><span class="meta">$</span> /usr/local/coreseek/bin/indexer -c etc/csft.conf --all</span><br><span class="line"><span class="meta">$</span> /usr/local/coreseek/bin/search -c etc/csft.conf 网络搜索</span><br></pre></td></tr></table></figure></p>
<p>出现这个 xmlpipe2 support NOT compiled in. To use xmlpipe2, install missing XML libra  错误<br>执行以下命令：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install expat expat-devel</span><br></pre></td></tr></table></figure></p>
<p>依次安装后，从新编译coreseek，然后再生成索引，就可以通过了。<br>结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Coreseek Fulltext 4.1 [ Sphinx 2.0.2-dev (r2922)]  </span><br><span class="line">Copyright (c) 2007-2011,  </span><br><span class="line">Beijing Choice Software Technologies Inc (http://www.coreseek.com)  </span><br><span class="line"> </span><br><span class="line">using config file &apos;etc/csft.conf&apos;...  </span><br><span class="line">index &apos;xml&apos;: query &apos;网络搜索 &apos;: returned 1 matches of 1 total in 0.000 sec  </span><br><span class="line"> </span><br><span class="line">displaying matches:  </span><br><span class="line">1. document=1, weight=1590, published=Thu Apr  1 07:20:07 2010, author_id=1  </span><br><span class="line"> </span><br><span class="line">words:  </span><br><span class="line">1. &apos;网络&apos;: 1 documents, 1 hits  </span><br><span class="line">2. &apos;搜索&apos;: 2 documents, 5 hits</span><br></pre></td></tr></table></figure></p>
<p><strong>下面开始sphinx与mysql的配置</strong><br>创建sphinx统计表，在coreseek_test库中执行。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> sph_counter</span><br><span class="line">(</span><br><span class="line">    counter_id <span class="built_in">INTEGER</span> PRIMARY <span class="keyword">KEY</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    max_doc_id <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>创建配置sphinx与mysql的配置文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/local/coreseek/etc/csft_mysql.conf</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">#MySQL数据源配置，详情请查看：http://www.coreseek.cn/docs/coreseek_4.1-sphinx_2.0.1-beta.html#conf-reference</span><br><span class="line"></span><br><span class="line">#源定义</span><br><span class="line">source main</span><br><span class="line">&#123;</span><br><span class="line">    type                    = mysql</span><br><span class="line"></span><br><span class="line">    sql_host                = localhost</span><br><span class="line">    sql_user                = root</span><br><span class="line">    sql_pass                = 123456 </span><br><span class="line">    sql_db                  = coreseek_test</span><br><span class="line">    sql_port                = 3306</span><br><span class="line">    sql_query_pre           = SET NAMES utf8</span><br><span class="line">    sql_query_pre        = REPLACE INTO sph_counter SELECT 1,MAX(id) FROM hr_spider_company;</span><br><span class="line">    sql_query               = SELECT * FROM hr_spider_company WHERE id&lt;=( SELECT max_doc_id FROM sph_counter WHERE counter_id=1 ) </span><br><span class="line">                                                         #sql_query第一列id需为整数</span><br><span class="line">                                                         #title、content作为字符串/文本字段，被全文索引</span><br><span class="line">    sql_attr_uint            = id                        #从SQL读取到的值必须为整数</span><br><span class="line">    sql_attr_uint            = from_id                #从SQL读取到的值必须为整数，不支持全文检索</span><br><span class="line">    sql_attr_uint            = link_id                #从SQL读取到的值必须为整数，不支持全文检索</span><br><span class="line">    sql_attr_uint            = add_time                #从SQL读取到的值必须为整数，不支持全文检索</span><br><span class="line">    sql_field_string         = link_url                 #字符串字段(可全文搜索，可返回原始文本信息)</span><br><span class="line">    sql_field_string          = company_name          #字符串字段(可全文搜索，可返回原始文本信息)</span><br><span class="line">    sql_field_string          = type_name             #字符串字段(可全文搜索，可返回原始文本信息)</span><br><span class="line">    sql_field_string          = trade_name             #字符串字段(可全文搜索，可返回原始文本信息)</span><br><span class="line">    sql_field_string          = email                 #字符串字段(可全文搜索，可返回原始文本信息)</span><br><span class="line">    sql_field_string          = description             #字符串字段(可全文搜索，可返回原始文本信息)</span><br><span class="line"></span><br><span class="line">    sql_query_info_pre      = SET NAMES utf8         #命令行查询时，设置正确的字符集</span><br><span class="line">    sql_query_info            = SELECT id,from_id,link_id,company_name,type_name,trade_name,address,description, FROM_UNIXTIME(add_time) AS add_time  FROM hr_spider_company  WHERE id=$id                     #命令行查询时，从数据库读取原始数据信息</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">source delta : main  </span><br><span class="line">&#123;  </span><br><span class="line">    sql_query_pre           = SET NAMES utf8  </span><br><span class="line">    sql_query               = SELECT * FROM hr_spider_company WHERE id&gt;( SELECT max_doc_id FROM sph_counter WHERE counter_id=1 )</span><br><span class="line">    sql_query_post_index    = REPLACE INTO sph_counter SELECT 1,MAX(id) FROM hr_spider_company</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#index定义</span><br><span class="line">index main</span><br><span class="line">&#123;</span><br><span class="line">    source                = main                         #对应的source名称</span><br><span class="line">    path                  = /usr/local/coreseek/var/data/mysql     #请修改为实际使用的绝对路径，例如：/usr/local/coreseek/var/...</span><br><span class="line">    docinfo               = extern</span><br><span class="line">    mlock                 = 0</span><br><span class="line">    morphology            = none</span><br><span class="line">    min_word_len          = 1</span><br><span class="line">    html_strip            = 0</span><br><span class="line"></span><br><span class="line">    #中文分词配置，详情请查看：http://www.coreseek.cn/products-install/coreseek_mmseg/</span><br><span class="line">    charset_dictpath     = /usr/local/mmseg3/etc/          #BSD、Linux环境下设置，/符号结尾</span><br><span class="line">    charset_type        = zh_cn.utf-8</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">index delta : main  </span><br><span class="line">&#123;  </span><br><span class="line">    source          = delta  </span><br><span class="line">    path            = /usr/local/coreseek/var/data/delta </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#全局index定义</span><br><span class="line">indexer</span><br><span class="line">&#123;</span><br><span class="line">    mem_limit            = 128M</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#searchd服务定义</span><br><span class="line">searchd</span><br><span class="line">&#123;</span><br><span class="line">    listen              = 9312</span><br><span class="line">    read_timeout        = 5</span><br><span class="line">    max_children        = 30</span><br><span class="line">    max_matches         = 1000</span><br><span class="line">    seamless_rotate     = 0</span><br><span class="line">    preopen_indexes     = 0</span><br><span class="line">    unlink_old          = 1</span><br><span class="line">    pid_file         = /usr/local/coreseek/var/log/searchd_mysql.pid   #请修改为实际使用的绝对路径，例如：/usr/local/coreseek/var/...</span><br><span class="line">    log             = /usr/local/coreseek/var/log/searchd_mysql.log        #请修改为实际使用的绝对路径，例如：/usr/local/coreseek/var/...</span><br><span class="line">    query_log         = /usr/local/coreseek/var/log/query_mysql.log    #请修改为实际使用的绝对路径，例如：/usr/local/coreseek/var/...</span><br><span class="line">    binlog_path     =                                              #关闭binlog日志</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我的测试表名为hr_spider_company，你只需要根据实际需求更改为自己的表名即可。</p>
<p>调用命令列表：<br>启动后台服务（必须开启）<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/coreseek/bin/searchd -c /usr/local/coreseek/etc/csft_mysql.conf</span><br></pre></td></tr></table></figure></p>
<p>执行索引（查询、测试前必须执行一次）<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/coreseek/bin/indexer -c /usr/local/coreseek/etc/csft_mysql.conf --all --rotate</span><br></pre></td></tr></table></figure></p>
<p>执行增量索引<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/coreseek/bin/indexer -c /usr/local/coreseek/etc/csft_mysql.conf delta --rotate</span><br></pre></td></tr></table></figure></p>
<p>合并索引<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/coreseek/bin/indexer -c /usr/local/coreseek/etc/csft_mysql.conf --merge main delta --rotate --merge-dst-range deleted 0 0</span><br></pre></td></tr></table></figure></p>
<p>(为了防止多个关键字指向同一个文档加上–merge-dst-range deleted 0 0)<br>后台服务测试<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/coreseek/bin/search -c /usr/local/coreseek/etc/csft_mysql.conf  aaa</span><br></pre></td></tr></table></figure></p>
<p>关闭后台服务<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/coreseek/bin/searchd -c /usr/local/coreseek/etc/csft_mysql.conf --stop</span><br></pre></td></tr></table></figure></p>
<p>自动化命令：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*/1 * * * * /bin/sh /usr/local/coreseek/bin/indexer -c /usr/local/coreseek/etc/csft_mysql.conf delta --rotate</span><br><span class="line">*/5 * * * * /bin/sh /usr/local/coreseek/bin/indexer -c /usr/local/coreseek/etc/csft_mysql.conf --merge main delta --rotate --merge-dst-range deleted 0 0</span><br><span class="line">30 1 * * *  /bin/sh /usr/local/coreseek/bin/indexer -c /usr/local/coreseek/etc/csft_mysql.conf --all --rotate</span><br></pre></td></tr></table></figure>
<p>以上任务计划的意思是：每隔一分钟执行一遍增量索引，每五分钟执行一遍合并索引，每天1:30执行整体索引。</p>
<p><strong>Sphinx扩展安装</strong><br>Coreseek官方教程中建议php使用直接include一个php文件进行操作，事实上php有独立的sphinx模块可以直接操作coreseek(coreseek就是sphinx！)已经进入了php的官方函数库，而且效率的提升不是一点点！但php模块依赖于libsphinxclient包。<br><strong>[第一步] 安装依赖libsphinxclient</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cd /var/install/coreseek-4.1-beta/csft-4.1/api/libsphinxclient/</span><br><span class="line"><span class="meta">#</span> ./configure  --prefix=/usr/local/sphinxclient</span><br><span class="line"></span><br><span class="line">configure: creating ./config.status</span><br><span class="line">config.status: creating Makefile</span><br><span class="line">config.status: error: cannot find input file: Makefile.in   #报错configure失败    </span><br><span class="line"></span><br><span class="line">//处理configure报错</span><br><span class="line">编译过程中报了一个config.status: error: cannot find input file: src/Makefile.in这个的错误，然后运行下列指令再次编译就能通过了：</span><br><span class="line"><span class="meta">#</span> aclocal</span><br><span class="line"><span class="meta">#</span> libtoolize --force</span><br><span class="line"><span class="meta">#</span> automake --add-missing</span><br><span class="line"><span class="meta">#</span> autoconf</span><br><span class="line"><span class="meta">#</span> autoheader</span><br><span class="line"><span class="meta">#</span> make clean</span><br><span class="line"></span><br><span class="line">//从新configure编译</span><br><span class="line"><span class="meta">#</span> ./configure</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p>
<p><strong>[第二步] 安装sphinx的PHP扩展</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">http://pecl.php.net/package/sphinx</span><br><span class="line"><span class="meta">#</span> wget http://pecl.php.net/get/sphinx-1.3.0.tgz</span><br><span class="line"><span class="meta">#</span> tar zxvf sphinx-1.3.0.tgz</span><br><span class="line"><span class="meta">#</span> cd sphinx-1.3.0</span><br><span class="line"><span class="meta">#</span> phpize</span><br><span class="line"><span class="meta">#</span> ./configure --with-php-config=/usr/bin/php-config --with-sphinx=/usr/local/sphinxclient</span><br><span class="line"><span class="meta">#</span> make &amp;&amp; make install</span><br><span class="line"><span class="meta">#</span> cd /etc/php.d/</span><br><span class="line"><span class="meta">#</span> cp gd.ini  sphinx.ini</span><br><span class="line"><span class="meta">#</span> vi sphinx.ini</span><br><span class="line"></span><br><span class="line">extension=sphinx.so</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> service php-fpm restart</span><br></pre></td></tr></table></figure></p>
<p>打开phpinfo看一下是否已经支持了sphinx模块。</p>
<p><strong>php调用sphinx示例：</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $s = <span class="keyword">new</span> SphinxClient;</span><br><span class="line">    $s-&gt;setServer(<span class="string">"127.0.0.1"</span>, <span class="number">9312</span>);</span><br><span class="line"></span><br><span class="line">    $s-&gt;setMatchMode(SPH_MATCH_PHRASE);</span><br><span class="line">    $s-&gt;setMaxQueryTime(<span class="number">30</span>);</span><br><span class="line">    $res = $s-&gt;query(<span class="string">"宝马"</span>,<span class="string">'main'</span>); <span class="comment">#[宝马]关键字，[main]数据源source</span></span><br><span class="line">    $err = $s-&gt;GetLastError();</span><br><span class="line">    var_dump(array_keys($res[<span class="string">'matches'</span>]));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>.<span class="string">"通过获取的ID来读取数据库中的值即可。"</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;'</span>;</span><br><span class="line">    var_dump($res);</span><br><span class="line">    var_dump($err);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;/pre&gt;'</span>;</span><br></pre></td></tr></table></figure></p>
<p>调用示例二：支持分页<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	header(<span class="string">"Content-type: text/html; charset=utf-8"</span>);</span><br><span class="line">	<span class="keyword">require</span>(<span class="string">"./sphinxapi.php"</span>);</span><br><span class="line">    $s = <span class="keyword">new</span> SphinxClient;</span><br><span class="line">    $s-&gt;setServer(<span class="string">"192.168.252.132"</span>, <span class="number">9312</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//SPH_MATCH_ALL, 匹配所有查询词(默认模式); SPH_MATCH_ANY, 匹配查询词中的任意一个; SPH_MATCH_EXTENDED2, 支持特殊运算符查询</span></span><br><span class="line">    $s-&gt;setMatchMode(SPH_MATCH_ALL);</span><br><span class="line">    $s-&gt;setMaxQueryTime(<span class="number">30</span>);										<span class="comment">//设置最大搜索时间</span></span><br><span class="line">	$s-&gt;SetArrayResult(<span class="keyword">false</span>);										<span class="comment">//是否将Matches的key用ID代替</span></span><br><span class="line">	$s-&gt;SetSelect ( <span class="string">"*"</span> );											<span class="comment">//设置返回信息的内容,等同于SQL</span></span><br><span class="line">	$s-&gt;SetRankingMode(SPH_RANK_BM25);								<span class="comment">//设置评分模式，SPH_RANK_BM25可能使包含多个词的查询的结果质量下降。 </span></span><br><span class="line">	<span class="comment">//$s-&gt;SetSortMode(SPH_SORT_EXTENDED);							//发现增加此参数会使结果不准确</span></span><br><span class="line">	<span class="comment">//$s-&gt;SetSortMode(SPH_SORT_EXTENDED,"from_id asc,id desc");		//设置匹配项的排序模式, SPH_SORT_EXTENDED按一种类似SQL的方式将列组合起来，升序或降序排列。</span></span><br><span class="line">	$weights = <span class="keyword">array</span> (<span class="string">'company_name'</span> =&gt; <span class="number">20</span>);</span><br><span class="line">	$s-&gt;SetFieldWeights($weights);									<span class="comment">//设置字段权重</span></span><br><span class="line">	$s-&gt;SetLimits ( <span class="number">0</span>, <span class="number">30</span>, <span class="number">1000</span>, <span class="number">0</span> );								<span class="comment">//设置结果集偏移量  SetLimits (便宜量,匹配项数目,查询的结果集数默认1000,阀值达到后停止)</span></span><br><span class="line">	<span class="comment">//$s-&gt;SetFilter ( $attribute, $values, $exclude=false );		//设置属性过滤</span></span><br><span class="line">	<span class="comment">//$s-&gt;SetGroupBy ( $attribute, $func, $groupsort="@group desc" );	//设置分组的属性</span></span><br><span class="line">    $res = $s-&gt;query(<span class="string">'@* "汽车"'</span>,<span class="string">'main'</span>,<span class="string">'--single-0-query--'</span>); <span class="comment">#[宝马]关键字，[news]数据源source</span></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//代码高亮</span></span><br><span class="line">	$tags = <span class="keyword">array</span>();</span><br><span class="line">	$tags_name = <span class="keyword">array</span>();</span><br><span class="line">	<span class="keyword">foreach</span>($res[<span class="string">'matches'</span>] <span class="keyword">as</span> $key=&gt;$value)&#123;</span><br><span class="line">		$tags[] = $value[<span class="string">'attrs'</span>];</span><br><span class="line">  		$company_name[] = $value[<span class="string">'attrs'</span>][<span class="string">'company_name'</span>];</span><br><span class="line">  		$description[] = $value[<span class="string">'attrs'</span>][<span class="string">'description'</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	$company_name = $s-&gt;BuildExcerpts ($company_name, <span class="string">'main'</span>, <span class="string">'汽车'</span>, $opts=<span class="keyword">array</span>() );		<span class="comment">//执行高亮，这里索引名字千万不能用*</span></span><br><span class="line">	$description = $s-&gt;BuildExcerpts ($description, <span class="string">'main'</span>, <span class="string">'汽车'</span>, $opts=<span class="keyword">array</span>() );		<span class="comment">//执行高亮，这里索引名字千万不能用*</span></span><br><span class="line">	<span class="keyword">foreach</span>($tags <span class="keyword">as</span> $k=&gt;$v)</span><br><span class="line">	&#123;</span><br><span class="line">		$tags[$k][<span class="string">'company_name'</span>] = $company_name[$k];	<span class="comment">//高亮后覆盖</span></span><br><span class="line">		$tags[$k][<span class="string">'description'</span>] = $description[$k];	<span class="comment">//高亮后覆盖</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 高亮后覆盖</span></span><br><span class="line">	$i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">foreach</span>($res[<span class="string">'matches'</span>] <span class="keyword">as</span> $key=&gt;$value)&#123;</span><br><span class="line">		$res[<span class="string">'matches'</span>][$key] = $tags[$i];</span><br><span class="line">		$i++;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    $err = $s-&gt;GetLastError();</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;'</span>;</span><br><span class="line">    var_export($res);</span><br><span class="line">    var_export($err);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;/pre&gt;'</span>;</span><br></pre></td></tr></table></figure></p>
<p>还有很对地方需要参考：<a href="http://www.coreseek.cn/docs/coreseek_4.1-sphinx_2.0.1-beta.html#api-reference" target="_blank" rel="noopener">http://www.coreseek.cn/docs/coreseek_4.1-sphinx_2.0.1-beta.html#api-reference</a></p>
<p>转载自 <a href="http://blog.csdn.net/e421083458/article/details/21529969" target="_blank" rel="noopener">http://blog.csdn.net/e421083458/article/details/21529969</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/03/20/搭建coreseek(sphinx+mmseg3)详细安装配置+php之sphinx扩展安装+php调用示例/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2015/03/11/用javascript实现本地图片预览(HTML5)/"><span>用javascript实现本地图片预览(HTML5)</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/03/11/用javascript实现本地图片预览(HTML5)/" rel="bookmark">
        <time class="entry-date published" datetime="2015-03-11T02:56:51.000Z">
          2015-03-11
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>使用FileReader实现打开本地图片并预览。<br>挺方便的，可惜不是所有浏览器都支持，坑爹的IE。 </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">preImg</span>(<span class="params">sourceId, targetId</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">if</span> (<span class="keyword">typeof</span> FileReader === <span class="string">'undefined'</span>) &#123;</span></span><br><span class="line"><span class="javascript">		alert(<span class="string">'Your browser does not support FileReader...'</span>);</span></span><br><span class="line"><span class="javascript">		<span class="keyword">return</span>;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> reader = <span class="keyword">new</span> FileReader();</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">	reader.onload = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">		<span class="keyword">var</span> img = <span class="built_in">document</span>.getElementById(targetId);</span></span><br><span class="line"><span class="javascript">		img.src = <span class="keyword">this</span>.result;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="javascript">	reader.readAsDataURL(<span class="built_in">document</span>.getElementById(sourceId).files[<span class="number">0</span>]);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"imgOne"</span> <span class="attr">id</span>=<span class="string">"imgOne"</span> <span class="attr">onchange</span>=<span class="string">"preImg(this.id,'imgPre');"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">"imgPre"</span> <span class="attr">src</span>=<span class="string">""</span> <span class="attr">style</span>=<span class="string">"display: block;"</span> /&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>转载自 <a href="http://crayster.iteye.com/blog/1543058" target="_blank" rel="noopener">http://crayster.iteye.com/blog/1543058</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Web-开发/">Web 开发</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2015/03/11/用javascript实现本地图片预览(HTML5)/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>




<nav class="pagination">
  
  <a href="/page/7/" class="pagination-prev">上一页</a>
  
  
  <a href="/page/9/" class="pagination-next">下一页</a>
  
</nav>
    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2019 403 Forbidden
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>